"use strict";angular.module("dateaWebApp",["ngCookies","ngResource","ngSanitize","ngRoute","LocalStorageModule","leaflet-directive","geolocation","FSAngular","monospaced.elastic","ngSocial","angular-bootstrap-select","ui.bootstrap","ui.bootstrap.dropdown","duScroll","angularCharts","daPiecluster","angulartics","angulartics.google.analytics","monospaced.mousewheel"]).config(["$routeProvider","$httpProvider","$locationProvider","localStorageServiceProvider",function(a,b,c,d){b.defaults.useXDomain=!0,delete b.defaults.headers.common["X-Requested-With"],b.defaults.headers.patch={"Content-Type":"application/json;charset=utf-8"},OAuth.initialize("du8nXdQmkjgR3nrfsjHxO07INhk"),c.hashPrefix("!"),a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).when("/home2",{templateUrl:"views/homeSignedIn-bckp.html",controller:"MainBckpCtrl"}).when("/acerca",{templateUrl:"views/about.html"}).when("/registrate",{templateUrl:"views/signup.html",controller:"SignupCtrl"}).when("/signup",{templateUrl:"views/signupForm.html",controller:"SignupformCtrl"}).when("/crear-cuenta",{templateUrl:"views/signupForm.html",controller:"SignupformCtrl"}).when("/twitter-callback",{templateUrl:"views/twitter-callback.html",controller:"TwitterCallbackCtrl"}).when("/signin",{templateUrl:"views/signIn.html",controller:"SigninCtrl"}).when("/change-password/:uid/:token",{templateUrl:"views/change-password.html",controller:"ChangePasswordCtrl"}).when("/updateUser",{templateUrl:"views/updateUser.html",controller:"UpdateuserCtrl"}).when("/configuracion",{templateUrl:"views/account.html",controller:"AccountCtrl",reloadOnSearch:!1}).when("/panel",{templateUrl:"views/campaign-dashboard.html",controller:"CampaignDashboardCtrl"}).when("/iniciativas",{templateUrl:"views/campaign-list.html",controller:"CampaignListCtrl"}).when("/crear-iniciativa",{templateUrl:"views/campaign-create.html"}).when("/tag/:tagName",{templateUrl:"views/tag.html",controller:"TagCtrl",reloadOnSearch:!1}).when("/iniciativas/:campaignId/edit",{templateUrl:"views/campaign-dashboard.html",controller:"CampaignEditCtrl"}).when("/iniciativas/:campaignId/admin",{templateUrl:"views/campaign-dashboard.html",controller:"DateosAdminCtrl",reloadOnSearch:!1}).when("/404",{templateUrl:"views/404.html"}).when("/buscar",{templateUrl:"views/dateo-search.html",controller:"DateoSearchCtrl",reloadOnSearch:!1}).when("/buscar/:search",{templateUrl:"views/dateo-search.html",controller:"DateoSearchCtrl",reloadOnSearch:!1}).when("/dateos/:dateoId",{templateUrl:"views/redirect.html",controller:"RedirectToDateoCtrl"}).when("/mapeo/:campaignId/dateos/:dateoId",{templateUrl:"views/redirect.html",controller:"RedirectToDateoCtrl"}).when("/mapeo/:campaignId/dateos",{templateUrl:"views/redirect.html",controller:"RedirectToCampaignCtrl"}).when("/mapeo/:campaignId",{templateUrl:"views/redirect.html",controller:"RedirectToCampaignCtrl"}).when("/acerca/terminos",{templateUrl:"views/terminos.html"}).when("/acerca/privacidad",{templateUrl:"views/privacidad.html"}).when("/:username/:campaignName",{templateUrl:"views/campaign.html",controller:"CampaignCtrl",reloadOnSearch:!1}).when("/:username/dateos/:dateoId",{templateUrl:"views/dateo-detail.html",controller:"DateoCtrl"}).when("/:username",{templateUrl:"views/profile.html",controller:"ProfileCtrl"}).otherwise({redirectTo:"/404"}),d.prefix="datea",c.html5Mode(!0)}]),angular.module("dateaWebApp").controller("MainCtrl",["$scope","User","$http","$location","$rootScope","config","localStorageService","geolocation","Api","$modal","$interpolate","leafletData","Fullscreen","ActivityTitle","ActivityUrl","$timeout","State","leafletBoundsHelpers","leafletMarkersHelpers","Piecluster","$compile","shareMetaData",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v){var w,x,y,z,A,B,C,D,E,F,G,H=g;a.flow={},a.query={},a.pagination={},a.query.orderBy="-created",a.query.orderByLabel="últimos",a.query.followFilter="all",a.query.followFilterLabel="todos",a.flow.historyResults=5,a.dateFormat=f.defaultDateFormat,G=function(){a.homeSI={},a.homeSI.history=[],a.homeSI.loading={},a.homeSI.loading.campaigns=!0,a.homeSI.userTagsArray=[],a.homeSI.activeTab="dateos",a.homeSI.dateosListView={limit:20},a.flow.campaignTabs={following:!1,featured:!0},a.homeSI.campaignsFollowed=[]},G(),v.resetToDefault(),E=function(){i.tag.getTags({followed:b.data.id}).then(function(c){a.homeSI.userTags={},a.homeSI.followingTags=c.objects.map(function(b){return a.homeSI.userTags[b.tag]=b,b}),b.data.tags_followed=c.objects},function(a){console.log(a)})},F=function(){a.homeSI.trendingTags=[],i.tag.getTrendingTags({limit:5,days:40}).then(function(b){angular.forEach(b.objects,function(b){a.homeSI.trendingTags.push(b)})})},D=function(){i.activityLog.getActivityOfUserByUserId({user:b.data.id,mode:"all",limit:a.flow.historyResults}).then(function(b){a.homeSI.history=[],a.flow.historyTotal=b.meta.total_count,angular.forEach(b.objects,function(b){b._url=o.parse(b),b._message=n.createTitle(b),a.homeSI.history.push(b)})})},a.flow.showMoreHistory=function(){a.flow.historyResults+=5,D()},A=function(b){var c,d,e;c=b&&b.index*f.homeSI.campaignsOffset,e={order_by:"-featured,-created",is_active:!0,limit:f.homeSI.campaignsOffset,offset:c||0},d=b&&b.query||e,i.campaign.getCampaigns(d).then(function(b){a.homeSI.campaigns=b.objects,a.homeSI.loading.campaigns=!1},function(a){console.log(a)})},B=function(){var c;0!==b.data.tags_followed.length&&(c={order_by:"-created",limit:100,main_tag:b.data.tags_followed.map(function(a){return a.tag}).join(",")},a.homeSI.loading.campaignsFollowed=!0,i.campaign.getCampaigns(c).then(function(b){a.homeSI.campaignsFollowed=b.objects,a.homeSI.loading.campaignsFollowed=!1},function(a){console.log(a)}))},a.$watch("pagination.currentPage",function(){b.isSignedIn()&&(A({index:a.pagination.currentPage-1}),a.homeSI.loading.campaigns=!0)}),C=function(b){a.pagination.totalItems=b.meta.total_count,a.pagination.itemsPerPage=f.homeSI.paginationLimit},a.flow.searchDateos=function(){a.query.search&&a.query.search.match(/^#\S+$/)?(console.log("/tag/"+a.query.search.replace("#","")),d.path("/tag/"+a.query.search.replace("#",""))):d.path("/buscar/"+a.query.search)},x=function(){var c;return c=H.get("nextURL"),c&&0===c.count?void p(function(){c.count=c.count+1,H.set("nextURL",c),d.path(c.path)}):(q.isLanding=!1,a.flow.isSignedIn=!1,a.user=b.data,b.data.tags_followed.length&&(a.query.followFilter="follow",a.query.followFilterLabel="lo que sigo"),a.homeSI.userTags={},a.homeSI.followingTags=b.data.tags_followed.map(function(b){return a.homeSI.userTags[b.tag]=b,b}),b.data.tags_followed.length&&(a.flow.campaignTabs={following:!0,featured:!1}),A(),B(),D(),F(),E(),void 0)},y=function(){x()},z=function(){q.isLanding=!0,a.flow.isSignedIn=!0},a.flow.isSignedIn=!b.isSignedIn(),a.flow.datear=function(){j.open({templateUrl:"views/datear.html",controller:"DatearCtrl",windowClass:"datear-modal",backdrop:"static",resolve:{datearModalGivens:function(){return{}}}})},a.homeSI.autocompleteSearch=function(a){return a?i.tag.getAutocompleteByKeyword({q:a.replace("#","")}).then(function(a){var b=[];return angular.forEach(a.suggestions,function(a){b.push("#"+a)}),b}):void 0},a.homeSI.fullscreen=function(){a.homeSI.mapFullscreen=!0,m.isEnabled()?m.cancel():m.enable(document.getElementById("homeSI-map-holder"))},a.homeSI.searchCampaigns=function(){a.homeSI.loading.campaigns=!0,a.homeSI.searchCampaignsKeyword?A({query:{q:a.homeSI.searchCampaignsKeyword,limit:f.homeSI.campaignOffset,offset:0}}):A()},a.$on("$destroy",function(){G(),s.resetCurrentGroups()}),e.$on("user:signedIn",function(){1===b.data.status&&x()}),e.$on("user:signedOut",function(){z()}),e.$on("user:signedUp",function(){y()}),e.$on("user:updated",function(){a.user=b.data}),w=b.data.status,b.isSignedIn()&&1===b.data.status&&x()}]),angular.module("dateaWebApp").controller("SignupCtrl",["$scope","User","$http","$location","localStorageService","Api","shareMetaData",function(a,b,c,d,e,f,g){a.flow={},b.isSignedIn()&&d.path("/"),g.setData({title:"Datea | Regístrate",description:"Registra tu cuenta en Datea."}),a.flow.signIn=function(){d.path("/signin")},a.flow.withFacebook=function(){OAuth.popup("facebook",function(a,c){var e={};e.access_token=c.access_token,e.party="facebook",b.signInBy3rdParty(e).then(function(){d.path("/")},function(a){console.log("$scope.flow.withFacebook",a)})})},a.flow.withTwitter=function(){OAuth.popup("twitter",function(a,c){var e={};e.party="twitter",e.oauth_token=c.oauth_token,e.oauth_token_secret=c.oauth_token_secret,b.signInBy3rdParty(e).then(function(){d.path("/configuracion")},function(a){console.log("$scope.flow.withTwitter",a)})})},a.flow.withEmail=function(){d.path("/crear-cuenta")}}]),angular.module("dateaWebApp").service("User",["localStorageService","$rootScope","Api","$q","$timeout","$location",function(a,b,c,d,e,f){var g,h,i,j={},k=a,l={};return j.isSignedIn=function(){return!!k.get("token")},j.data={},j.isNew=!1,j.updateUserDataFromStorage=function(){j.isSignedIn()&&angular.extend(j.data,k.get("user")),c.user.getToken({fromTwitter:!0}),b.$broadcast("user:updated")},j.writeDataToStorage=function(){k.set("user",j.data)},j.updateTokenOnTwitterSignup=function(){c.user.getToken({fromTwitter:!0})},h=function(a){return g=a&&{Authorization:"Apikey "+a.username+":"+a.token}},j.updateHeader=function(a,b){var d=h({username:a,token:b});k.set("token",d),c.resetRscs()},i=function(a){var b=a&&a.username,e=a&&a.id,f=d.defer();return c.user.getToken(),j.isSignedIn()&&b?c.user.getUserByUserIdOrUsername({username:b}).then(function(a){f.resolve(a)}):j.isSignedIn()&&e?c.user.getUserByUserIdOrUsername({id:e}).then(function(a){f.resolve(a)}):!j.isSignedIn()&&b?c.user.getUserByUserIdOrUsername({username:b}).then(function(a){f.resolve(a)}):f.reject("not username or id"),f.promise},j.getData=i,j.updateUserDataFromApi=function(b){var c,d=a,e=d.get("user");i({username:e.username}).then(function(a){return c=a,angular.extend(e,c),d.set("user",e),j.updateUserDataFromStorage(),0===j.data.status?void f.path("/configuracion"):void(b&&b())},function(a){console.log(a)})},j.updateUser=function(a){var b=d.defer();return c.user.updateUserByUserId(a).then(function(a){var c=a,d=k.get("user");angular.extend(d,c),k.set("user",d),j.updateUserDataFromStorage(),b.resolve(a)},function(a){console.log("error",a),b.reject(a)}),b.promise},j.signInBy3rdParty=function(a){var e=d.defer();return c.account.social.signInBy3rdParty(a).then(function(d){var f={};f.username=d.user.username,f.token=d.token,g=h(f),k.set("token",g),c.resetRscs(),j.isSignedIn(),l=d.user,j.data=l,j.data.authProvider=a.party,j.isNew=d.is_new,k.set("user",l),b.$broadcast("user:signedIn"),e.resolve(j.data)},function(a){e.reject(a)}),e.promise},j.signIn=function(a){var e=a.username,f=d.defer();return c.account.signIn.signIn(a).then(function(a){var d={};d.username=e,d.token=a.token,j.isNew=a.is_new,g=h(d),c.resetRscs(),k.set("token",g),j.isSignedIn(),l=a.user,j.data=l,j.data.authProvider="datea",k.set("user",l),b.$broadcast("user:signedIn"),f.resolve(j.data)},function(a){f.reject(a)}),f.promise},j.signOut=function(){j.data={},k.remove("token"),k.remove("user"),j.isSignedIn(),b.$broadcast("user:signedOut"),f.path("/")},j.resetPassword=function(a){var b=d.defer();return c.account.resetPassword(a).then(function(a){b.resolve(a)},function(a){b.reject(a)}),b.promise},j.getAuthorizationHeader=function(){return g||k.get("token")},j.updateUserDataFromStorage(),j}]),angular.module("dateaWebApp").controller("SignupformCtrl",["$scope","$http","localStorageService","Api","config","$location","User","shareMetaData",function(a,b,c,d,e,f,g,h){var i=c;a.auth={},a.auth.messages={},a.flow={},a.flow.validInput={},a.flow.validInput.username=null,a.flow.validInput.email=null,a.flow.validInput.password=null,a.flow.validInput.samePassword=null,a.flow.loading=!1,a.flow.registerSuccess=!1,g.isSignedIn()&&f.path("/"),h.setData({title:"Datea | Regístrate",description:"Registra tu cuenta en Datea."}),a.auth.checkUsername=function(){a.auth.bio?(a.auth.bio=a.auth.bio.replace(/ /g,""),d.account.register.usernameExists({username:a.auth.bio}).then(function(b){a.flow.validInput.username=!b.result,a.auth.messages.usernameExists=a.flow.validInput.username?null:e.signupForm.validationMsgs.usernameExists,a.form.$setValidity("usernameExists",a.flow.validInput.username)},function(a){console.log(a)})):a.flow.validUsername=null},a.auth.checkEmail=function(){var b;b=e.regex.email.test(a.auth.email),b&&d.account.register.emailExists({email:a.auth.email}).then(function(b){a.flow.validInput.email=!b.result,a.auth.messages.emailExists=a.flow.validInput.email?null:e.signupForm.validationMsgs.emailExists,a.form.$setValidity("emailExists",a.flow.validInput.email)})},a.auth.checkPassword=function(){a.auth.password&&(a.flow.validInput.password=/^(?=.*\d)(?=.*[a-z])(?!.*\s).{6,32}$/.test(a.auth.password),a.auth.message=null)},a.auth.checkSamePassword=function(){a.auth.samePassword&&(a.flow.validInput.samePassword=a.auth.samePassword===a.auth.password,a.auth.message=null)},a.auth.save=function(){var b,c;c=a.form.$valid,b={username:a.auth.bio,email:a.auth.email,password:a.auth.password,success_redirect_url:e.app.url+"updateUser",error_redirect_url:e.app.url},c&&a.flow.validInput.username?(a.auth.message="cargando..",a.flow.loading=!0,d.account.register.createUser(b).then(function(b){201===b.status&&(i.set("user",b.user),a.auth.message="usuario creado.",a.flow.registerSuccess=!0,a.flow.loading=!1)},function(b){400===b.status&&(a.auth.message=e.signupForm.validationMsgs.http400),a.flow.loading=!1,console.log("reason",b)})):a.auth.message="please check your inputs"}}]),angular.module("dateaWebApp").controller("TwitterCallbackCtrl",["wxBirdangularService","$location","localStorageService","$window","$scope",function(a,b,c,d){var e,f,g=c,h=a;e=b.absUrl(),e.match(/\?(.+)$/)&&(f=e.match(/\?(.+)$/)[0].split("&")),h.setToken({token:d.opener.oauth_token,secret:d.opener.oauth_token_secret}),h.accessToken(f[1].split("=")[1].split("#")[0]).then(function(a){g.set("keys-twitter",a),d.opener.oauth_token=null,d.opener.oauth_token_secret=null,d.opener.$windowScope.flow.onCallback(),d.close()})}]),angular.module("dateaWebApp").controller("NavCtrl",["$scope","User","$rootScope","$modal","$location","localStorageService","State","$timeout","$window","Api",function(a,b,c,d,e,f,g,h,i){var j,k,l=1;a.nav={},a.user={},a.nav.isSignedIn=b.isSignedIn(),a.state=g.state,a.nav.visible=b.isSignedIn(),a.nav.isCollapsed=!0,a.alerts=[],j=function(){var a,d=f,g=d.get("user");b.getData({username:g.username}).then(function(f){a=f,angular.extend(g,a),d.set("user",g),b.updateUserDataFromStorage(),0===b.data.status?(e.path("/configuracion"),c.$broadcast("user:statusCheck",{status:0,changed:!1})):1===b.data.status&&0===l?(l=null,e.path("/configuracion"),c.$broadcast("user:statusCheck",{status:1,changed:!0})):e.path("/")},function(a){console.log(a)})},k=function(c){var d=e.path();b.updateUserDataFromStorage(),a.nav.visible=b.isSignedIn(),("/signin"===d||"/signup"===d||"/crear-cuenta"===d||"/registrate"===d||"/"!==d)&&(a.nav.visible=!0),a.user=b.data,a.nav.isSignedIn=b.isSignedIn(),c||0!==b.data.status||(l=b.data.status,j()),"/configuracion"!==e.path()&&0===b.data.status&&e.path("/configuracion")},a.closeAlert=function(b){a.alerts.splice(b,1)},a.addAlert=function(b){a.alerts=[],a.alerts.push(b)},c.$on("user:signedIn",function(){k()}),c.$on("user:signedOut",function(){a.nav.visible=b.isSignedIn(),a.user={},a.nav.isSignedIn=!1}),c.$on("user:hasDateado",function(){}),a.$on("$locationChangeStart",function(){b.updateUserDataFromStorage(),k({checkUserStatus:!1})}),a.$on("$routeChangeSuccess",function(){i.scrollTo(0,0)}),c.$on("error:someError",function(){console.log("hubo un error http")}),a.nav.signIn=function(){e.path("/signin")},a.nav.signOut=function(){b.signOut()},a.nav.datear=function(){d.open({templateUrl:"views/datear.html",controller:"DatearCtrl",windowClass:"datear-modal",resolve:{datearModalGivens:function(){return{}}}})},b.isSignedIn()&&k()}]),angular.module("dateaWebApp").controller("DatearCtrl",["$scope","$modalInstance","geolocation","$http","$rootScope","config","Api","datearModalGivens","$timeout","leafletData","User","$location","geoJSONStyle","localStorageService",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n){var o,p,q,r,s,t,u,v,w,x,y,z,A,B={},C={},D={},E=!1,F=!1,G=k.data.ip_country,H=f.visualization.defaultMarkerIcon.htmlGen(l.absUrl());A=angular.extend({},f.visualization.defaultMarkerIcon),A.html=H,a.dateo=h.dateo||{},a.datear={},a.datear.leaflet={},a.datear.autocomplete={},a.datear.link={},a.datear.selectedMedia=[],a.flow={},a.flow.dp={},a.datear.selectedTags=[],a.datear.loading=!1,a.datear.onFinished=!1,a.datear.isScrolling=!1,a.datear.modalTitle=a.dateo.id?"Editar dateo":"¡Datea!",a.datear.mode=a.dateo.id?"edit":"new",a.datear.showFileInput=!1,a.flow.datearBtnLabel=a.dateo.id?"Guardar":"Datear",a.alerts=[],a.datear.step=1,"new"!=a.datear.mode&&a.dateo.position||(A.className="datea-pin-icon pin-icon-not-set");var I=$("#modal-body");if(I.size()&&0!=I.scrollTop()&&I.scrollTo(0,0),d({method:"GET",url:f.api.url+"ip_location"}).success(function(a){G=a.ip_country}),u=function(b){var c,d,e;c={center:{lat:b.coords.latitude,lng:b.coords.longitude,zoom:14},markers:{draggy:{lat:b.coords.latitude,lng:b.coords.longitude,draggable:!0,icon:A}},events:"dragend"},o?(d=leafletPip.pointInLayer([b.coords.latitude,b.coords.longitude],o),0===d.length?(e=o.getBounds(),j.getMap("leafletDatear").then(function(b){var d;b.fitBounds(e),b.getZoom()<14&&b.zoomIn(1),d=b.getCenter(),a.dateo.position||(c={markers:{draggy:{lat:d.lat,lng:d.lng,draggable:!0,icon:A}},events:"dragend"},angular.extend(a.datear.leaflet,c))})):angular.extend(a.datear.leaflet,c)):angular.extend(a.datear.leaflet,c)},v=function(){var b,c,d={};g.ipLocation.getLocationByIP().then(function(e){d={center:{lat:e.ip_location.latitude,lng:e.ip_location.longitude,zoom:14},markers:{draggy:{lat:e.ip_location.latitude,lng:e.ip_location.longitude,draggable:!0,icon:f.visualization.defaultMarkerIcon}}},o?(b=leafletPip.pointInLayer([e.ip_location.latitude,e.ip_location.longitude],o),c=o.getBounds(),0===b.length?j.getMap("leafletDatear").then(function(b){var e;b.fitBounds(c),b.getZoom()<14&&b.zoomIn(1),e=b.getCenter(),d={markers:{draggy:{lat:e.lat,lng:e.lng,draggable:!0,icon:f.visualization.defaultMarkerIcon}}},angular.extend(a.datear.leaflet,d)}):angular.extend(a.datear.leaflet,d)):angular.extend(a.datear.leaflet,d)},function(){o?(c=o.getBounds(),j.getMap("leafletDatear").then(function(a){a.fitBounds(c),mcenter=a.getCenter(),d={markers:{draggy:{lat:mcenter.lat,lng:mcenter.lng,draggable:!0,icon:f.visualization.defaultMarkerIcon}}}})):(d={center:{lat:-12.05,lng:-77.06,zoom:14},markers:{draggy:{lat:-12.05,lng:-77.06,draggable:!0,icon:f.visualization.defaultMarkerIcon}}},angular.extend(a.datear.leaflet,d))})},a.$on("leafletDirectiveMap.click",function(b,c){var d=c.leafletEvent,e={};F=!0,A.className="datea-pin-icon",e={lat:d.latlng.lat,lng:d.latlng.lng,draggable:!0,icon:A},j.getMap("leafletDatear").then(function(b){var c=a.datear.leaflet.center.zoom;if(16>=c){var f=L.latLng(d.latlng.lat,d.latlng.lng);c+=2,b.setZoomAround(f,c),angular.extend(a.datear.leaflet.markers.draggy,e)}else angular.extend(a.datear.leaflet.markers.draggy,e);o&&0===leafletPip.pointInLayer(d.latlng,o).length&&L.popup({offset:L.point(0,-30)}).setLatLng(d.latlng).setContent("Fuera de la zona de esta iniciativa").openOn(b)})}),a.$on("leafletDirectiveMarker.dragstart",function(){$(".pin-icon-not-set").removeClass("pin-icon-not-set")}),a.$on("leafletDirectiveMarker.dragend",function(b,c){var d=c.leafletEvent.target.getLatLng();if(A.className="datea-pin-icon",F=!0,a.datear.leaflet.center.lat=a.datear.leaflet.markers.draggy.lat=d.lat,a.datear.leaflet.center.lng=a.datear.leaflet.markers.draggy.lng=d.lng,a.datear.leaflet.center.zoom<=16&&a.datear.leaflet.center.zoom++,o){var e=L.latLng([a.datear.leaflet.markers.draggy.lat,a.datear.leaflet.markers.draggy.lng]);0===leafletPip.pointInLayer(e,o).length&&j.getMap("leafletDatear").then(function(b){L.popup({offset:L.point(0,-30)}).setLatLng([a.datear.leaflet.markers.draggy.lat,a.datear.leaflet.markers.draggy.lng]).setContent("Fuera de la zona de esta iniciativa").openOn(b)})}}),a.scrollTo=function(b,c,d){var e,f;b.stopPropagation(),b.preventDefault(),a.datear.isScrolling=!0,e=angular.element(document.getElementById("modal-body")),f=angular.element(document.getElementById(c)),e.scrollToElement(f,d,400).then(function(){a.datear.isScrolling=!1})},a.closeAlert=function(b){a.alerts.splice(b,1)},a.addAlert=function(b){return a.alerts.push(b)-1},e.$on("datea:fileLoaded",function(b,c){c.data.size>f.dateo.sizeImgMax?(a.datear.img=null,void 0!==B.imgSize&&a.closeAlert(B.imgSize),B.imgSize=a.addAlert({type:"danger",msg:f.dateo.sizeImgMaxMsg})):void 0!==B.imgSize&&a.closeAlert(B.imgSize)}),e.$on("duScrollspy:becameActive",function(b,c){var d=c[0].attributes["du-scrollspy"].value,e=parseInt(d.charAt(d.length-1));a.$apply(function(){a.datear.step=e})}),a.flow.dp={dateoDate:a.dateo.date?Date.parse(a.dateo.date):null,dateOptions:{"year-format":"'yy'","starting-day":1},format:"yyyy/MM/dd",opened:!1,dateoTime:a.dateo.date?Date.parse(a.dateo.date):new Date,hstep:1,mstep:1},a.flow.dp.openDatepicker=function(b){b.stopPropagation(),b.preventDefault(),a.flow.dp.opened=!0},a.flow.dp.changed=function(){var b,c={};a.flow.dp.dateoDate?(c.year=a.flow.dp.dateoDate.getFullYear(),c.month=a.flow.dp.dateoDate.getMonth(),c.day=a.flow.dp.dateoDate.getDate(),a.flow.dp.dateoTime?(c.hour=a.flow.dp.dateoTime.getHours(),c.minutes=a.flow.dp.dateoTime.getMinutes()):(c.hour=0,c.minutes=0),b=new Date(c.year,c.month,c.day,c.hour,c.minutes,"00"),a.dateo.date=new Date(b.getTime()-6e4*b.getTimezoneOffset())):a.dateo.date=null},a.$watch("flow.dp.dateoDate",function(){a.flow.dp.changed()}),a.datear.doDatear=function(){console.log("do datear token",n.get("token")),a.dateo.tags=a.datear.selectedTags,F&&(a.dateo.position={coordinates:[a.datear.leaflet.markers.draggy.lng,a.datear.leaflet.markers.draggy.lat],type:"Point"}),a.dateo.images=[],a.dateo.files=[],angular.forEach(a.datear.selectedMedia,function(b){var c;switch(b.type){case"image":c=b.imgData.id?b.imgData:{image:{name:b.imgData.name,data_uri:b.img},order:b.order},a.dateo.images.push(c);break;case"file":b.fileData.id?(b.fileData.title=b.fileTitle,c=b.fileData):c={file:{name:b.fileData.name,data_uri:b.file},title:b.fileTitle||b.fileData.name,order:b.order},a.dateo.files.push(c)}}),null===a.dateo.link&&(a.dateo.link=void 0),a.dateo.content&&a.dateo.tags.length?(a.datear.loading=!0,a.dateo.id?g.dateo.patch(a.dateo).then(function(c){a.datear.errorMessage=null,angular.extend(a.dateo,c),e.$broadcast("user:hasDateado",{dateo:c,created:!1}),a.datear.loading=!1,b.dismiss("cancel")},function(b){console.log(b),a.addAlert({type:"danger",msg:"Hubo un error al datear :( - Intentalo de nuevo"}),a.datear.loading=!1}):g.dateo.postDateo(a.dateo).then(function(b){a.datear.errorMessage=null,a.datear.onFinished=!0,angular.extend(a.dateo,b),e.$broadcast("user:hasDateado",{dateo:b,created:!0}),a.datear.loading=!1,t(),k.data.dateo_count++,k.writeDataToStorage()},function(b){console.log(b),a.addAlert({type:"danger",msg:"Hubo un error al datear :( - Intentalo de nuevo"}),a.datear.loading=!1})):a.dateo.content?a.addAlert(a.dateo.tags.length?{type:"danger",msg:"Hubo un error al datear :("}:{type:"danger",msg:"Debes elegir al menos una etiqueta."}):(a.addAlert({type:"danger",msg:"Por favor, agrega contenido a tu dateo."}),a.flow.validateContent=!1,$("#modal-body").scrollTo(0,0))},a.datear.delete=function(){var c=window.confirm("¿Estás seguro(a) de que quieres borrar este dateo?");c&&(a.datear.loading=!0,g.dateo.delete({id:a.dateo.id}).then(function(){a.datear.loading=!1,b.dismiss("cancel"),e.$broadcast("user:dateoDelete",{id:a.dateo.id}),k.data.dateo_count--,k.writeDataToStorage()},function(a){console.log(a)}))},t=function(){g.follow.doFollow({follow_key:"dateo."+a.dateo.id}).then(function(){},function(a){console.log(a)})},a.datear.cancel=function(){b.dismiss("cancel")},a.datear.autocompleteTag=function(a){return g.tag.getAutocompleteByKeyword({q:a.replace("#","")}).then(function(a){var b=[];return angular.forEach(a.suggestions,function(a){b.push(a)}),b})},z=function(a){var b=a.split(" ");return b=b.map(function(a){return a=a.replace(/[^a-z0-9]/gi,""),a.charAt(0).toUpperCase()+a.slice(1)}),b.join("")},a.datear.addTag=function(b){var c,d;if(a.datear.nextTag=null,!~a.datear.selectedTags.indexOf(b)&&a.datear.selectedTags.length<f.dateo.tagsMax&&(b=z(b),a.datear.selectedTags.push(b)),E&&D[b]&&(c=D[b],c.campaigns.length>0)){d=[];for(var e in c.campaigns)c.campaigns[e].secondary_tags&&c.campaigns[e].secondary_tags.length&&(d=d.concat(c.campaigns[e].secondary_tags.map(function(a){return{tag:a}})));d.length&&(a.datear.suggestedTags2=d)}},a.datear.removeTag=function(b){a.datear.selectedTags.splice(b,1)},a.datear.suggestedTagsBack=function(){a.datear.suggestedTags2=null},x=function(b,c){a.dateo.address&&""==a.dateo.address.trim()||d({method:"GET",url:"http://nominatim.openstreetmap.org/reverse",params:{lat:b,lon:c,format:"json","accept-language":"es,en"}}).success(function(b){a.dateo.address=b.display_name})},w=function(b){a.flow.addressSearchLoading=!0,d({method:"GET",url:"http://nominatim.openstreetmap.org/search",params:{q:b,format:"json","accept-language":"es,en",countrycodes:k.data.ip_country}}).success(function(c){1==c.length?y(c[0]):c.length>1?a.flow.addressSearchResults=c:(a.flow.addressNotFound=!0,setTimeout(function(){a.$apply(function(){a.flow.addressNotFound=!1})},2e3)),a.flow.addressSearchLoading=!1,C[b]=c,$(".address-search-btn").blur()}).error(function(){a.flow.addressSearchLoading=!1,$(".address-search-btn").blur()})},y=function(b){var c,d,e;d=parseFloat(b.lat),e=parseFloat(b.lon),c={lat:d,lng:e,draggable:!0},angular.extend(a.datear.leaflet.markers.draggy,c),a.datear.leaflet.center.lat=d,a.datear.leaflet.center.lng=e,a.datear.leaflet.center.zoom=16,$(".address-search-btn").blur()},a.flow.searchAddressInMap=function(){var b,c;$(".address-search-btn").focus(),a.dateo.address&&""!==a.dateo.address.trim()&&!a.flow.addressSearchLoading&&(b=a.dateo.address.trim(),C[b]?(c=C[b],c.length>1?a.flow.addressSearchResults=c:1==c.length?y(c[0]):(a.flow.addressNotFound=!0,setTimeout(function(){a.$apply(function(){a.flow.addressNotFound=!1})},2e3)),$(".address-search-btn").blur()):w(b))},a.flow.selectAddress=function(b){var c=a.flow.addressSearchResults[b];y(c),a.flow.addressSearchResults=null},a.flow.closeSelectAddress=function(){a.flow.mouseOverSelectAddress||(a.flow.addressSearchResults=null),a.flow.addressNotFound=!1},s=function(){a.dateo.id&&(a.dateo.link&&a.dateo.link.url&&a.datear.selectedMedia.push({type:"link",order:0}),a.dateo.images&&a.dateo.images.length&&angular.forEach(a.dateo.images,function(b){var c=b.image.split("/");b.name=c[c.length-1],a.datear.selectedMedia.push({type:"image",img:f.api.imgUrl+b.image,imgData:b,order:b.order})}),a.dateo.files&&a.dateo.files.length&&angular.forEach(a.dateo.files,function(b){var c=b.file.split("/");b.name=c[c.length-1],a.datear.selectedMedia.push({type:"file",file:b.file,fileData:b,fileTitle:b.title,order:b.order})}))},a.datear.toggleFileInput=function(b){a.datear.showFileInput&&a.datear.activeFileInputType&&a.datear.activeFileInputType!==b||(a.datear.showFileInput=!a.datear.showFileInput),a.datear.activeFileInputType=b},a.datear.fileInputCallback=function(b){a.$apply(function(){a.datear.showFileInput=!1;for(var c in b)if(a.datear.selectedMedia.length<10){var d=b[c];if("image"===d.type){var e=a.datear.selectedMedia.filter(function(a){return"image"===a.type}).length;a.datear.selectedMedia.push({type:"image",img:d.file,imgData:d.data,order:e})}else if("file"===d.type){var e=a.datear.selectedMedia.filter(function(a){return"file"===a.type}).length;a.datear.selectedMedia.push({type:"file",file:d.file,fileData:d.data,order:e})}}})},a.datear.removeMedia=function(b){var c=a.datear.selectedMedia[b].type;a.datear.selectedMedia.splice(b,1),"link"===c&&(a.dateo.link=null)},a.datear.link.add=function(){a.dateo.link||(a.dateo.link={},a.datear.selectedMedia.unshift({type:"link",order:0}))},a.datear.link.loadUrl=function(){a.dateo.link.url?(a.datear.link.loading=!0,a.datear.link.urlPH="",d({method:"GET",url:f.api.url+"url_info/",params:{url:a.dateo.link.url}}).success(function(b){a.dateo.link.title=b.title,a.dateo.link.description=b.description,b.images.length&&(a.dateo.link.img_url=b.images[0],a.datear.link.images=b.images,a.datear.link.imgIndex=0),a.datear.link.loading=!1}).error(function(){a.dateo.link.url="",a.datear.link.urlPH="No se pudo encontrar la dirección. Inténtalo denuevo.",a.datear.link.loading=!1})):(a.dateo.link.url="",a.datear.link.urlPH='Dirección con formato inválido. Falta "http.." ?.')},a.datear.link.prevImg=function(){a.datear.link.imgIndex--,a.dateo.link.img_url=a.datear.link.images[a.datear.link.imgIndex]},a.datear.link.nextImg=function(){a.datear.link.imgIndex++,a.dateo.link.img_url=a.datear.link.images[a.datear.link.imgIndex]},a.datear.goToDateo=function(){l.path("/"+a.dateo.user.username+"/dateos/"+a.dateo.id),b.dismiss("cancel")},q=function(){h.boundary&&h.boundary.coordinates&&(o=L.geoJson(h.boundary,{style:{color:"#E65F00",fill:!1,weight:4}}),j.getMap("leafletDatear").then(function(a){a.addLayer(o)}))},r=function(){h.layerFiles&&h.layerFiles.length>0&&j.getMap("leafletDatear").then(function(a){angular.forEach(h.layerFiles,function(b){var c,e;c=b.file.split("/").slice(-1)[0],e=c.split(".").slice(-1)[0].toLowerCase(),"kml"===e?d.get(f.api.imgUrl+b.file).success(function(){L.geoJson(gjson,m).addTo(a)}):"json"===e&&d.get(f.api.imgUrl+b.file).success(function(b){L.geoJson(b,m).addTo(a)})})})},p=angular.copy(f.defaultMap),p.markers={draggy:{lat:-12.05,lng:-77.06,draggable:!0,icon:f.visualization.defaultMarkerIcon}},angular.extend(a.datear.leaflet,p),h.defaultTag&&a.datear.selectedTags.push(h.defaultTag),a.dateo.tags&&a.dateo.tags.length&&(a.datear.selectedTags=a.dateo.tags.map(function(a){return"string"==typeof a?a:a.tag})),h.suggestedTags)a.datear.suggestedTags=h.suggestedTags;else if(!a.dateo.tags){a.datear.suggestedTags=k.data.tags_followed,E=!0;for(var J in k.data.tags_followed){var K=k.data.tags_followed[J];D[K.tag]=K}}if(h.campaignId&&(a.dateo.campaign=h.campaignId),a.dateo.position){var M={coords:{latitude:a.dateo.position.coordinates[1],longitude:a.dateo.position.coordinates[0]}};u(M)}else c.getLocation({timeout:1e4}).then(u,v);s(),q(),r()}]),angular.module("dateaWebApp").directive("fileread",["$rootScope","config",function(a,b){return{scope:{fileread:"=",filedata:"=",maxImgSize:"@"},link:function(c,d,e){var f=e.maxImgSize?parseInt(e.maxImgSize):b.maxImgSize;FileAPI.event.on(d[0],"change",function(b){var d,e,g=FileAPI.getFiles(b)[0];"image"==g.type.split("/")[0]?(FileAPI.getInfo(g,function(a,b){console.log(b)}),FileAPI.Image(g).rotate("auto").resize(f,f,"max").get(function(b,f){c.$apply(function(){c.filedata=g,e="image/jpeg"==g.type||"image/png"==g.type?g.type:"image/png",c.fileread=f.toDataURL(e,1),d={data:g,file:c.fileread},a.$broadcast("datea:fileLoaded",d)})})):FileAPI.readAsDataURL(g,function(b){"load"==b.type&&c.$apply(function(){c.filedata=g,c.fileread=b.result,d={data:g,file:c.fileread},a.$broadcast("datea:fileLoaded",d)})})}),c.$on("$destroy",function(){FileAPI.event.off(d,"change")})}}}]),angular.module("dateaWebApp").constant("config",{app:{name:"Datea.pe",url:"http://datea.pe"},api:{url:"https://api.datea.io/api/v2/",imgUrl:"http://api.datea.io"},marker:['<div class="marker-holderet">','<img class="img-circle" src="{{user.markerImage}}" alt="user image">','<div class="part">',"<h5>{{user.username}}</h5>",'<span class="date">{{_prettyDate}}</span>',"</div>","<p>{{extract}}</p>",'<a class="popup-detail-btn btn datea-gray-btn btn-xs pull-right" data-index="{{index}}" href="#{{user.username}}/dateos/{{id}}">ver detalle</a>','<div class="stats">','<span class="stat"><span class="glyphicon glyphicon-thumbs-up"></span>{{vote_count}}</span>','<span class="stat"><span class="glyphicon glyphicon-comment"></span>{{comment_count}}</span>',"</div>","</div>"].join(""),selectFilter:{last:"",mostVoted:"-vote_count,-created",mostCommented:"-comment_count,-created"},dateo:{sizeImgMax:5242880,sizeImgMaxMsg:"Su archivo es muy grande",tagsMax:7},defaultMap:{bounds:[[-12.0735,-77.0336],[-12.0829,-77.0467]],center:{lat:-12.05,lng:-77.06,zoom:14},defaults:{scrollWheelZoom:!1},markers:{},tiles:{url:"http://{s}.mqcdn.com/tiles/1.0.0/osm/{z}/{x}/{y}.png",options:{attribution:'Tiles by <a href="http://www.mapquest.com/">MapQuest</a> &mdash; Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>',subdomains:["otile1","otile2","otile3","otile4"]}}},defaultDateFormat:"d 'de' MMMM yyyy - H:mm",shortDateFormat:"d/MM/yyyy - H:mm",dateFieldFormat:"d 'de' MMMM yyyy - H:mm",defaultBoundsRatio:.0075,defaultImgProfile:"/static/images/globals/user-default.png",defaultImgBackground:"/static/images/globals/bg-gris.png",defaultImgCampaign:"/static/images/campaign/iniciativa-default-sm.png",defaultImgCampaignLarge:"/static/images/campaign/iniciativa-default.png",defaultdateoNumResults:30,dateosLoadedAtOnce:200,maxImgSize:2048,homeSI:{campaignsOffset:12,paginationLimit:6,mapZoomOverride:13,zoomAfterDatear:16,dateosLimitByRequest:100,defaultMarkersImage:"/static/images/globals/"},profile:{dateosOffset:10,campaignsOffset:10,paginationLimit:10},activityLog:{activityVerbs:["dateo","commented","voted","redateo","campaign"],activityContentMsg:{onUser:{dateo:"{{actor.username}} dateó {{tags}}",commented:"{{actor.username}} comentó tu dateo {{tags}}",voted:"{{actor.username}} apoyó tu dateo {{tags}}",redateo:"{{actor.username}} redateó tu dateo {{tags}}"},byUser:{dateo:"dateaste {{tags}}",commented:"comentaste el dateo de {{target_user.username}} {{tags}}",voted:"apoyaste el dateo de {{target_user.username}} {{tags}}",redateo:"redateaste a {{target_user.username}} {{tags}}",campaign:"creaste una iniciativa {{tags}}"},anyUser:{dateo:"{{actor.username}} dateó {{tags}}",commented:"{{actor.username}} comentó dateo de {{target_user.username}} {{tags}}",voted:"{{actor.username}} apoyó dateo de {{target_user.username}} {{tags}}",redateo:"{{actor.username}} redateó a {{target_user.username}} {{tags}}",campaign:"{{actor.username}} creó una iniciativa {{tags}}"}}},campaign:{mapZoomFocus:15},dashboard:{defaultZoom:14,validationMsgs:{mainTagExists:"La etiqueta ya está siendo usada en alguna iniciativa. Al menos que quieras compartirla, usa otra.",duplicateUserTag:'Ya has utilizado esta etiqueta en otra iniciativa. Si quieres reutilizarla, debes llenar el campo "Componente de URL". De otro modo mejor cámbiala.',slugError:"Esta url ya esta siendo utilizada. Por favor, elige otra.",emptyField:"Campo obligatorio"}},signupForm:{validationMsgs:{usernameExists:"El nombre de usuario ya ha sido usado.",emailExists:"La dirección ya está siendo utilizada. ¡Recupera tu contraseña!",http400:"El nombre de usuario o correo ya está siendo usado."}},accountMsgs:{userBannedMsg:'Tu usuario ha sido bloqueado. Si piensas que esto es injusto, por favor comunicate con nosotros a traves de nuestro <a href="http://ayuda.datea.pe/contacto">formulario de contacto</a>.',userWelcomeReadyMsg:"Tu cuenta ha sido activada y ya estás listo(a) para datear. Si quieres, antes puedes hacer ajustes a la configuración de tu usuario acá abajo.",userWelcomeConfirmMsg:"Ya casi eres datero(a)! Falta que nos confirmes tu dirección de correo (Twitter no nos provee ese dato). Una vez confirmada tu cuenta estarás listo(a) para datear.",duplicateEmailMsg:"La dirección de correo ya existe. Por favor utiliza otra, o si no recuerdas tu usuario, puedes salir y recuperar tu clave. Si ingresaste con otro servico (Facebook), por favor vuelve a ingresar con ese servicio.",duplicateUsernameMsg:"El nombre de usuario ya existe. Por favor, elige otro.",checkEmailMsg:"¡Gracias! Ahora revisa tu correo y sigue las instrucciones para activar tu cuenta. Si deseas, puedes cerrar esta ventana o pestaña.",userConfirmEmailMsg:"Antes de poder datear, necesitamos verificar tu dirección de correo. Ingrésala aquí abajo. ¡Gracias!",userConfirmMissingMsg:'Falta que nos confirmes tu correo para activar tu cuenta. Por favor, chequea tu correo y sigue las instrucciones que te enviamos. Si deseas recibir otro correo de activación, vuelve a cliquear en "Enviar". ¡Gracias!',userConfirmSuccessMsg:"Tu cuenta ha sido plenamente activada y estas listo(a) para datear. Si deseas, puedes antes hacer ajustes a tu cuenta acá abajo.",registerActivationCompleteMsg:"Tu cuenta ha sido activada. Ahora puedes ingresar con tu usuario y contraseña.",PasswdResetEmailMsg:"Por favor revisa tu correo y sigue las instrucciones para recuperar tu contraseña.",PasswdResetNotFoundMsg:"No existen dateros con esa dirección ;)",wrongUserOrPassword:"Tu usuario y/o contraseña no son válidos. Vuélvelo a intentar."},unknownErrorMsg:'Hubo un error. Por favor revisa tus datos e intenta de nuevo. Si no funciona, <a href="http://ayuda.datea.pe/contacto">contáctanos</a>.',regex:{email:/^([a-zA-Z0-9_\.\-])+\@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,4})+$/,text:/^([a-záéíóúñÑÁÉÍÓÚA-Z \-])+$/},layout_100:[],visualization:{default_other_color:"#CCCCCC",default_color:"#28BC45",markerSvgPath:"M14.087,0.485c-7.566,0-13.694,6.133-13.698,13.695c0.027,3.938,2.02,8.328,4.637,10.878c2.615,3.363,6.536,8.889,6.488,11.033v0.07c0,4.195,0.364,3.92,0.4,4.051c0.128,0.441,0.527,0.746,0.99,0.746h2.179c0.464,0,0.858-0.309,0.983-0.74c0.04-0.137,0.407,0.139,0.411-4.057c0-0.039-0.004-0.059-0.004-0.068c-0.038-2.047,3.399-7.35,6.109-10.877c2.875-2.498,5.175-6.814,5.196-11.035C27.779,6.618,21.65,0.485,14.087,0.485z",markerWidth:29,markerHeight:42,defaultMarkerIcon:{type:"div",iconSize:[29,42],iconAnchor:[14.5,43],popupAnchor:[0,-33],labelAnchor:[8,-25],className:"datea-pin-icon",htmlGen:function(a){return'<svg width="29" height="43" class="hey-wtf"><g style="clip-path: url('+a+'#pinpath);"><rect height="43" width="29" fill="#28BC45" /><circle cx="14.5" cy="13" r="4" fill="white" /><path d="M14.087,0.485c-7.566,0-13.694,6.133-13.698,13.695c0.027,3.938,2.02,8.328,4.637,10.878c2.615,3.363,6.536,8.889,6.488,11.033v0.07c0,4.195,0.364,3.92,0.4,4.051c0.128,0.441,0.527,0.746,0.99,0.746h2.179c0.464,0,0.858-0.309,0.983-0.74c0.04-0.137,0.407,0.139,0.411-4.057c0-0.039-0.004-0.059-0.004-0.068c-0.038-2.047,3.399-7.35,6.109-10.877c2.875-2.498,5.175-6.814,5.196-11.035C27.779,6.618,21.65,0.485,14.087,0.485z" stroke="#888888" fill="none" stroke-width="1" /></g></svg>'
}}},embed:{baseUrl:"http://embed.datea.pe/#",defaultWidth:800,defaultHeight:500,minWidth:600,maxWidth:1e3,minHeight:400,maxHeight:800},allowedMimetypes:["application/msword","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/vnd.ms-excel","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","application/vnd.ms-powerpoint","application/vnd.openxmlformats-officedocument.presentationml.presentation","application/vnd.openxmlformats-officedocument.presentationml.slideshow","application/vnd.oasis.opendocument.text","application/vnd.oasis.opendocument.spreadsheet","application/vnd.oasis.opendocument.presentation","application/vnd.oasis.opendocument.graphics","application/json","application/xml","text/csv","text/plain","text/rtf","text/xml","application/pdf","application/postscript","application/rdf+xml","application/zip","application/gzip","audio/mpeg","audio/mp4","audio/ogg"]}),angular.module("dateaWebApp").controller("DateoCtrl",["$scope","$routeParams","Api","config","$location","$modal","$window","User","leafletData","$timeout","$rootScope","shareMetaData",function(a,b,c,d,e,f,g,h,i,j,k,l){var m,n,o,p,q,r,s,t;a.dateo={},a.flow={},a.flow.imgUrl=d.api.imgUrl,a.flow.showEditBtn=!1,a.flow.form={},a.flow.form.loading=!1,a.flow.leaflet={},a.flow.messageNext="",a.flow.isUserSignedIn=h.isSignedIn(),a.createdFormat=d.defaultDateFormat,a.dateFormat=d.dateFieldFormat,q=function(a){return a.id<a.next_by_user},o=function(b){var c,f;if(b.objects[0]){var g=b.objects[0];if(!(g.published||h.isSignedIn()&&h.data.id===g.user.id))return void e.path("/404").replace();a.flow.messageNext=q(g)?"siguiente":"primer",angular.extend(a.dateo,g),a.dateo.comments=[],p(),s(),a.flow.shareableUrl=d.app.url+e.path(),r(),h.isSignedIn()&&h.data.id===g.user.id&&(a.flow.showEditBtn=!0),f=g.tags.slice(0,2),c={title:"Datea | "+g.user.username+" dateó en "+f.join(", "),description:g.extract,imageUrl:g.images.length?d.api.imgUrl+g.images[0].image:null},l.setData(c)}else e.path("/404").replace()},s=function(){var b={};if(a.dateo.position){b.center={lat:a.dateo.position.coordinates[1],lng:a.dateo.position.coordinates[0],zoom:16};var c=d.visualization.defaultMarkerIcon.htmlGen(e.absUrl()),f=d.visualization.defaultMarkerIcon;f.html=c,b.markers={staticy:{lat:a.dateo.position.coordinates[1],lng:a.dateo.position.coordinates[0],draggable:!1,icon:f}},i.getMap("leafletDateo").then(function(a){j(function(){a.invalidateSize()},200)}),angular.extend(a.flow.leaflet,b)}},r=function(){c.campaign.getCampaigns({tags:a.dateo.tags.join(",")}).then(function(b){a.flow.campaigns=b.objects})},p=function(){var b=a.dateo.comments.map(function(a){return a.id});c.comment.getList({content_type__model:"dateo",object_id:a.dateo.id,order_by:"created"}).then(function(c){a.dateo.comment_count=c.meta.total_count,a.dateo.comments=c.objects.map(function(a){return a.new=-1===b.indexOf(a.id),a}),a.flow.form.loading=!1,a.flow.form.comment=null},function(a){console.log(a)})},a.slideDownComments=function(){$(".slidedown").slideDown("normal",function(){$(this).removeClass("slidedown")})},a.flow.nextDateo=function(){e.path("/"+b.username+"/dateos/"+m.next_by_user)},a.flow.imgDetail=function(a){console.log("IMG",a);var b;b={templateUrl:"views/dateo-detail-img.html",controller:"DateoimgCtrl",resolve:{img:function(){return a}}},f.open(b)},a.flow.print=function(){g.print()},a.flow.postComment=function(){var b={};a.flow.form.comment.trim()&&!a.flow.form.loading&&(a.flow.form.loading=!0,b.comment=a.flow.form.comment,b.object_id=a.dateo.id,b.content_type="dateo",c.comment.postCommentByDateoId(b).then(function(){k.$broadcast("user:doFollow",{followKey:"dateo."+a.dateo.id}),p()}))},a.flow.focusCommentForm=function(){angular.element("#comment-input").focus()},a.flow.share=function(){var b=a.dateo.images.length?d.api.imgUrl+a.dateo.images[0].image:d.app.url+"/static/images/logo-large.png";f.open({templateUrl:"views/share.html",controller:"ShareCtrl",resolve:{shareModalGivens:function(){return{url:a.flow.shareableUrl,title:"Datea | "+a.dateo.user.username+" dateó en #"+a.dateo.tags.slice(0,2).join(", #"),description:a.dateo.extract,image:b}}}})},a.flow.denounce=function(a,d){c.flag.doFlag({content_type:a,object_id:+b.dateoId}).then(function(){$(d.target).hide()},function(a){console.log(a)})},a.flow.editDateo=function(){n=f.open({templateUrl:"views/datear.html",controller:"DatearCtrl",windowClass:"datear-modal",backdrop:"static",resolve:{datearModalGivens:function(){return{dateo:a.dateo}}}})},a.$on("user:hasDateado",function(){s()}),a.$on("user:dateoDelete",function(b,c){c.id===a.dateo.id&&e.url("/"+h.data.username)}),b.username&&b.dateoId&&(t={id:+b.dateoId},h.isSignedIn()&&b.username===h.data.username&&(t.published="all"),c.dateo.getDateos(t).then(o,function(a){404===a.status&&e.path("/404").replace()}),angular.extend(a.flow.leaflet,d.defaultMap))}]),angular.module("dateaWebApp").service("Api",["$resource","config","$q","localStorageService","$http",function(a,b,c,d){var e,f,g,h=d,i={},j={},k={},l={},m={},n={},o={},p={},q={},r={},s={},t={},u={},v={},w={},x={};return m.social={},m.social.twitter={},m.social.facebook={},m.register={},m.signIn={},m.password={},m.passwordChange={},m.usernameExists={},m.emailExists={},o.autocomplete={},o.trending={},f=function(){n.rsrc=a(b.api.url+"user/:id",{},{get:{method:"GET",headers:h.get("token")},patch:{method:"PATCH",params:{id:"@id"},headers:h.get("token")}})},g=function(){i.rsrc=a(b.api.url+"dateo/",{},{query:{method:"GET"},post:{method:"POST",headers:h.get("token")},patch:{method:"PATCH",headers:h.get("token"),url:b.api.url+"dateo/:id",params:{id:"@id"}},put:{method:"PUT",headers:h.get("token"),url:b.api.url+"dateo/:id",params:{id:"@id"}},"delete":{method:"DELETE",headers:h.get("token"),url:b.api.url+"dateo/:id",params:{id:"@id"}}}),j.rsrc=a(b.api.url+"dateo_status/",{},{query:{method:"GET"},post:{method:"POST",headers:h.get("token")},patch:{method:"PATCH",params:{id:"@id"},headers:h.get("token")},put:{method:"PUT",params:{id:"@id"},headers:h.get("token")},"delete":{method:"DELETE",headers:h.get("token")}}),l.rsrc=a(b.api.url+"comment/",{},{query:{method:"GET"},post:{method:"POST",headers:h.get("token")}}),m.social.twitter.rsrc=a(b.api.url+"account/socialauth/twitter/",{},{post:{method:"POST"}}),m.social.facebook.rsrc=a(b.api.url+"account/socialauth/facebook/",{},{post:{method:"POST"}}),m.register.rsrc=a(b.api.url+"account/register/",{},{post:{method:"POST"}}),m.signIn.rsrc=a(b.api.url+"account/signin/ ",{},{post:{method:"POST"}}),m.password.rsrc=a(b.api.url+"account/reset-password/",{},{save:{method:"POST"}}),m.passwordChange.rsrc=a(b.api.url+"account/reset-password-confirm/",{},{save:{method:"POST"}}),m.usernameExists.rsrc=a(b.api.url+"account/username-exists",{},{query:{method:"GET"}}),m.emailExists.rsrc=a(b.api.url+"account/email-exists",{},{query:{method:"GET"}}),n.rsrc=a(b.api.url+"user/:id",{},{get:{method:"GET",params:{id:"@id"},headers:h.get("token")},patch:{method:"PATCH",params:{id:"@id"},headers:h.get("token")}}),t.rsrc=a(b.api.url+"user/",{},{query:{method:"GET"}}),o.rsrc=a(b.api.url+"tag/",{},{get:{method:"GET"}}),o.autocomplete.rsrc=a(b.api.url+"tag/autocomplete/",{},{get:{method:"GET"}}),o.trending.rsrc=a(b.api.url+"tag/trending/",{},{get:{method:"GET"}}),p.rsrc=a(b.api.url+"campaign/",{},{query:{method:"GET"},post:{method:"POST",headers:h.get("token")},patch:{method:"PATCH",headers:h.get("token")}}),q.rsrc=a(b.api.url+"activity_log/",{},{query:{method:"GET"}}),r.rsrc=a(b.api.url+"category/",{},{query:{method:"GET"}}),s.rsrc=a(b.api.url+"follow/",{},{query:{method:"GET"},post:{method:"POST",headers:h.get("token")},"delete":{method:"DELETE",headers:h.get("token")}}),u.rsrc=a(b.api.url+"vote/",{},{query:{method:"GET"},post:{method:"POST",headers:h.get("token")},"delete":{method:"DELETE",headers:h.get("token")}}),v.rsrc=a(b.api.url+"flag/",{},{post:{method:"POST",headers:h.get("token")}}),w.rsrc=a(b.api.url+"dateo/stats/",{},{query:{method:"GET"}}),k.rsrc=a(b.api.url+"redateo/",{},{query:{method:"GET"},post:{method:"POST",headers:h.get("token")},"delete":{method:"DELETE",headers:h.get("token")}}),x.rsrc=a(b.api.url+"ip_location",{},{query:{method:"GET"}})},g(),n.getUserByUserIdOrUsername=function(a){var b=(h.get("token"),c.defer());return a.id=a&&a.username?a.username:a.id,f(),n.rsrc.get(a,function(a){b.resolve(a)},function(a){b.reject(a)}),b.promise},n.getUsers=function(a){var b=c.defer();return t.rsrc.query(a,function(a){b.resolve(a)},function(a){b.reject(a)}),b.promise},n.updateUserByUserId=function(a){var b=(h.get("token"),c.defer());return n.rsrc.patch({},a,function(a){b.resolve(a)},function(a){b.reject(a)}),b.promise},n.getToken=function(a){var b=a&&a.fromTwitter;e=h.get("token"),b&&f()},m.signIn.signIn=function(a){var b=c.defer();return m.signIn.rsrc.post(a,function(a){b.resolve(a)},function(a){b.reject(a)}),b.promise},m.register.createUser=function(a){var b=c.defer();return m.register.rsrc.post(a,function(a){b.resolve(a)},function(a){b.reject(a)}),b.promise},m.register.usernameExists=function(a){var b=c.defer();return m.usernameExists.rsrc.query(a,function(a){b.resolve(a)},function(a){b.reject(a)}),b.promise},m.register.emailExists=function(a){var b=c.defer();return m.emailExists.rsrc.query(a,function(a){b.resolve(a)},function(a){b.reject(a)}),b.promise},m.social.signInBy3rdParty=function(a){var b=c.defer(),d=a.party;return m.social[d].rsrc.post(a,function(a){b.resolve(a)},function(a){b.reject(a)}),b.promise},m.resetPassword=function(a){var b=c.defer();return m.password.rsrc.save(a,function(a){b.resolve(a)},function(a){b.reject(a)}),b.promise},m.changePassword=function(a){var b=c.defer();return m.passwordChange.rsrc.save(a,function(a){b.resolve(a)},function(a){b.reject(a)}),b.promise},i.getDateos=function(a){var b=c.defer();return i.rsrc.query(a,function(a){b.resolve(a)},function(a){b.reject(a)}),b.promise},i.getDateosByUsername=function(a){var b=c.defer();return i.rsrc.query({user:a},function(a){b.resolve(a)},function(a){b.reject(a)}),b.promise},i.postDateo=function(a){var b=c.defer();return i.rsrc.post(a,function(a){b.resolve(a)},function(a){b.reject(a)}),b.promise},i.patch=function(a){var b=c.defer();return i.rsrc.patch(a,function(a){b.resolve(a)},function(a){b.reject(a)}),b.promise},i.put=function(a){var b=c.defer();return i.rsrc.put(a,function(a){b.resolve(a)},function(a){b.reject(a)}),b.promise},i.delete=function(a){var b=c.defer();return i.rsrc.delete(a,function(a){b.resolve(a)},function(a){b.reject(a)}),b.promise},j.post=function(a){var b=c.defer();return j.rsrc.post(a,function(a){b.resolve(a)},function(a){b.reject(a)}),b.promise},j.putList=function(a){var b=c.defer();return j.rsrc.put(a,function(a){b.resolve(a)},function(a){b.reject(a)}),b.promise},j.patchList=function(a){var b=c.defer();return j.rsrc.patch(a,function(a){b.resolve(a)},function(a){b.reject(a)}),b.promise},j.getList=function(a){var b=c.defer();return j.rsrc.query(a,function(a){b.resolve(a)},function(a){b.reject(a)}),b.promise},j.deleteList=function(a){var b=c.defer();return j.rsrc.delete(a,function(a){b.resolve(a)},function(a){b.reject(a)}),b.promise},k.post=function(a){var b=c.defer();return k.rsrc.post(a,function(a){b.resolve(a)},function(a){b.reject(a)}),b.promise},k.getList=function(a){var b=c.defer();return k.rsrc.query(a,function(a){b.resolve(a)},function(a){b.reject(a)}),b.promise},k.deleteList=function(a){var b=c.defer();return k.rsrc.delete(a,function(a){b.resolve(a)},function(a){b.reject(a)}),b.promise},l.postCommentByDateoId=function(a){{var b=c.defer();h.get("token")}return l.rsrc.post({},a,function(a){b.resolve(a)},function(a){b.reject(a)}),b.promise},l.getList=function(a){{var b=c.defer();h.get("token")}return l.rsrc.query(a,function(a){b.resolve(a)},function(a){b.reject(a)}),b.promise},o.getTags=function(a){var b=c.defer();return o.rsrc.get(a,function(a){b.resolve(a)},function(a){b.reject(a)}),b.promise},o.getAutocompleteByKeyword=function(a){var b=c.defer();return o.autocomplete.rsrc.get(a,{},function(a){b.resolve(a)},function(a){b.reject(a)}),b.promise},o.getTrendingTags=function(a){var b=c.defer();return o.trending.rsrc.get(a,{},function(a){b.resolve(a)},function(a){b.reject(a)}),b.promise},p.getCampaigns=function(a){var b=c.defer();return p.rsrc.query(a,function(a){b.resolve(a)},function(a){b.reject(a)}),b.promise},p.postCampaign=function(a){var b=c.defer();return p.rsrc.post(a,function(a){b.resolve(a)},function(a){b.reject(a)}),b.promise},p.patchCampaign=function(a){var b=c.defer();return p.rsrc.patch(a,function(a){b.resolve(a)},function(a){b.reject(a)}),b.promise},q.getActivityOfUserByUserId=function(a){var b=c.defer();return q.rsrc.query(a,function(a){b.resolve(a)},function(a){b.reject(a)}),b.promise},r.getCategories=function(a){var b=c.defer();return r.rsrc.query(a,function(a){b.resolve(a)},function(a){b.reject(a)}),b.promise},s.getFollows=function(a){var b=c.defer();return s.rsrc.query(a,function(a){b.resolve(a)},function(a){b.reject(a)}),b.promise},s.doFollow=function(a){var b=c.defer();return s.rsrc.post(a,function(a){b.resolve(a)},function(a){b.reject(a)}),b.promise},s.doUnfollow=function(a){var b=c.defer();return s.rsrc.delete(a,function(a){b.resolve(a)},function(a){b.reject(a)}),b.promise},u.getVotes=function(a){var b=c.defer();return u.rsrc.query(a,function(a){b.resolve(a)},function(a){b.reject(a)}),b.promise},u.doVote=function(a){{var b=c.defer();h.get("token")}return u.rsrc.post({},a,function(a){b.resolve(a)},function(a){b.reject(a)}),b.promise},u.deleteVote=function(a){{var b=c.defer();h.get("token")}return u.rsrc.delete({},a,function(a){b.resolve(a)},function(a){b.reject(a)}),b.promise},v.doFlag=function(a){var b=c.defer();return v.rsrc.post(a,function(a){b.resolve(a)},function(a){b.reject(a)}),b.promise},w.getStats=function(a){var b=c.defer();return w.rsrc.query(a,function(a){b.resolve(a)},function(a){b.reject(a)}),b.promise},x.getLocationByIP=function(a){var b=c.defer();return x.rsrc.query(a,function(a){b.resolve(a)},function(a){b.reject(a)}),b.promise},{dateo:i,dateoStatus:j,redateo:k,comment:l,account:m,user:n,tag:o,campaign:p,activityLog:q,category:r,follow:s,vote:u,flag:v,stats:w,ipLocation:x,resetRscs:g}}]),angular.module("dateaWebApp").filter("imgFromApi",["config",function(a){return function(b){return b?a.api.imgUrl+b:a.defaultImgProfile}}]),angular.module("dateaWebApp").controller("DateoimgCtrl",["$scope","$modalInstance","img",function(a,b,c){a.dateoImg={},a.dateoImg.img=c}]),angular.module("dateaWebApp").controller("SigninCtrl",["$scope","Api","localStorageService","User","$location","State","config","shareMetaData",function(a,b,c,d,e,f,g,h){var i;f.isLanding=!1,a.auth={},a.flow={},a.alerts=[],a.reset={},a.nav={},a.flow.activationMsg=g.accountMsgs.registerActivationCompleteMsg,a.nav.visible=!0,a.flow.hideSocial=!1,a.auth.passwordRequired=!0,a.auth.showResetPassword=!1,d.isSignedIn()&&e.path("/"),h.setData({title:"Datea | Ingresa",description:"Ingresa a tu cuenta en Datea."}),e.search().msg&&(i=e.search().msg,"activationComplete"===i&&(a.flow.hideSocial=!0)),a.closeAlert=function(b){a.alerts.splice(b,1)},a.addAlert=function(b){a.alerts.push(b)},a.auth.signIn=function(){var c,f;c=a.form.$valid,console.log(a.form),f={username:a.auth.username,password:a.auth.password},c&&(a.flow.loading=!0,d.signIn(f).then(function(){b.resetRscs(),e.path("/"),a.flow.loading=!1},function(b){401==b.status&&a.addAlert({type:"danger",msg:g.accountMsgs.wrongUserOrPassword}),a.flow.loading=!1}))},a.auth.withFacebook=function(){OAuth.popup("facebook",function(b,c){var f={};f.access_token=c.access_token,f.party="facebook",a.flow.loading=!0,d.signInBy3rdParty(f).then(function(){e.path("/"),a.flow.loading=!1},function(b){console.log(b),a.flow.loading=!1})})},a.auth.withTwitter=function(){OAuth.popup("twitter",function(b,c){var f={};f.party="twitter",f.oauth_token=c.oauth_token,f.oauth_token_secret=c.oauth_token_secret,a.flow.loading=!0,d.signInBy3rdParty(f).then(function(b){e.path(0===b.status?"/configuracion":"/"),a.flow.loading=!1},function(b){console.log("auth.withTwitter error",b),a.flow.loading=!1})})},a.auth.resetPassword=function(){var b={};b.email=a.reset.email,a.flow.loading=!0,d.resetPassword(b).then(function(){a.addAlert({type:"success",msg:g.accountMsgs.PasswdResetEmailMsg}),a.flow.loading=!1},function(){a.flow.loading=!1,a.addAlert({type:"warning",msg:g.accountMsgs.PasswdResetNotFoundMsg})})},a.flow.toggleResetPassword=function(){a.auth.showResetPassword=!a.auth.showResetPassword}}]),angular.module("dateaWebApp").directive("wxPasswordMatch",[function(){return{restrict:"A",scope:!0,require:"ngModel",link:function(a,b,c,d){var e=function(){var b=a.$eval(c.ngModel),d=a.$eval(c.wxPasswordMatch);return b==d};a.$watch(e,function(a){d.$setValidity("unique",a)})}}}]),angular.module("dateaWebApp").controller("AccountCtrl",["$scope","User","config","Api","$modal","localStorageService","$location","shareMetaData",function(a,b,c,d,e,f,g,h){{var i,j;b.data.username}b.isSignedIn()||g.path("/signin"),a.flow={},a.account=b.data,a.alerts=[],a.flow.loading=!1,a.accountMsgs=c.accountMsgs,a.flow.statusBeingChecked=!b.data.status,a.flow.activeTab=g.search().tab||"user",h.setData({title:"Datea | configuración de cuenta"}),a.flow.openTab=function(a){g.search({tab:a})},a.$on("$routeUpdate",function(){j(g.search().tab)}),j=function(b){b=b?b:"user",a.flow.activeTab={user:!1,profile:!1,notifications:!1},a.flow.activeTab[b]=!0},j(g.search().tab),i=function(c,d){a.flow.userIsNew=b.isNew,a.flow.userStatus=c,a.flow.authProvider=b.data.authProvider||null,a.flow.statusChanged=d,a.flow.submitLabel=1===c?"Guardar":"Enviar",a.flow.hasEmail=!!b.data.email},1===b.data.status&&i(1,!1),a.$on("user:statusCheck",function(b,c){i(c.status,c.changed),a.flow.statusBeingChecked=!1}),a.closeAlert=function(b){a.alerts.splice(b,1)},a.addAlert=function(b){a.alerts=[],a.alerts.push(b)},a.account.save=function(){a.loading=!0;var d,f={};f.username=a.account.username,f.email=a.account.email,f.full_name=a.account.full_name,f.image=a.flow.imgData&&{image:{data_uri:a.flow.img,name:a.flow.imgData&&a.flow.imgData.name}},f.bg_image=a.flow.bgImgData&&{image:{data_uri:a.flow.bgImg,name:a.flow.bgImgData&&a.flow.bgImgData.name}},f.message=a.account.message,f.url=a.account.url,f.url_facebook=a.account.url_facebook,f.url_twitter=a.account.url_twitter,f.url_youtube=a.account.url_youtube,f.notify_settings=a.account.notify_settings,f.id=b.data.id;for(d in f)f.hasOwnProperty(d)&&!f[d]&&delete f[d];!b.data.status&&b.updateTokenOnTwitterSignup(),f.username&&f.email&&b.updateUser(f).then(function(c){c.token&&b.updateHeader(c.username,c.token),f.email&&0===b.data.status?e.open({templateUrl:"views/verifyEmailModal.html",backdrop:"static"}):f.email?g.url("/"+f.username):a.addAlert({type:"danger",msg:"Por favor indique un correo válido."}),a.loading=!1},function(b){var d;400===b.status&&(b.data&&b.data.error&&b.data.error.length?(d=b.data.error,"Duplicate email"===d&&a.addAlert({type:"warning",msg:c.accountMsgs.duplicateEmailMsg}),"Duplicate username"===d&&a.addAlert({type:"danger",msg:c.accountMsgs.duplicateUsernameMsg})):a.addAlert({type:"danger",msg:c.unknownErrorMsg})),a.loading=!1})}}]),angular.module("dateaWebApp").controller("ProfileCtrl",["$scope","User","config","Api","$routeParams","$interpolate","ActivityUrl","ActivityTitle","$modal","$location","shareMetaData","$timeout","$rootScope",function(a,b,c,d,e,f,g,h,i,j,k){var l,m,n,o,p,q,r;a.targetUser={},a.targetUser.history=[],a.targetUser.dateo_loading=!0,a.targetUser.campaign_loading=!0,a.paginationCampaigns={},a.paginationDateos={},a.flow={},a.flow.historyResults=5,a.map_is_present=!1,m=function(){d.tag.getTags({followed:a.targetUser.id}).then(function(b){a.targetUser.follows=b.objects},function(a){console.log(a)})},r=function(){a.targetUser.history=[],d.activityLog.getActivityOfUserByUserId({user:a.targetUser.id,mode:"actor",limit:a.flow.historyResults}).then(function(b){a.flow.historyTotal=b.meta.total_count,angular.forEach(b.objects,function(b){b._url=g.parse(b),b._message=h.createTitle(b),a.targetUser.history.push(b)})})},a.flow.showMoreHistory=function(){a.flow.historyResults+=5,r()},n=function(e){var f,g;a.targetUser.dateoLoading=!0,f=e&&e.index*c.profile.dateosOffset,g={limit:c.profile.dateosOffset,offset:f||0,user_id:a.targetUser.id,with_redateos:!0},b.isSignedIn()&&b.data.id==a.targetUser.id&&(g.published="all"),d.dateo.getDateos(g).then(function(b){a.targetUser.dateos=b.objects,q(b),a.targetUser.dateoLoading=!1},function(a){console.log(a)})},o=function(f){var g,h;a.targetUser.campaign_loading=!0,g=f&&f.index*c.profile.campaignsOffset,h={limit:c.profile.campaignsOffset,offset:g||0,user:e.username},b.isSignedIn()&&b.data.id==a.targetUser.id&&(h.published="all"),d.campaign.getCampaigns(h).then(function(b){a.targetUser.campaigns=b.objects,p(b),a.targetUser.campaign_loading=!1},function(a){console.log(a)})},l=function(){d.user.getUserByUserIdOrUsername({username:e.username}).then(function(d){var e;angular.extend(a.targetUser,d),a.targetUser.isSameAsUser=a.targetUser.username===b.data.username,a.flow.notFound=!1,a.flow.showRedateoAuthor=a.targetUser.username,n(),o(),r(),m(),e={title:"Perfil datero de "+a.targetUser.username,description:"Chequea los dateos e iniciativas de "+a.targetUser.username+" en Datea. ¡Todos somos dateros!",imageUrl:a.targetUser.image_large?c.api.imgUrl+a.targetUser.image_large:c.app.url+c.defaultImgProfile},k.setData(e)},function(a){console.log("user error reason:",a),404===a.status&&j.path("/404")})},p=function(b){a.paginationCampaigns.totalItems=b.meta.total_count,a.paginationCampaigns.itemsPerPage=c.profile.paginationLimit},a.$watch("paginationCampaigns.currentPage",function(){o({index:a.paginationCampaigns.currentPage-1})}),q=function(b){a.paginationDateos.totalItems=b.meta.total_count,a.paginationDateos.itemsPerPage=c.profile.paginationLimit},a.targetUser.share=function(){i.open({templateUrl:"views/share.html",controller:"ShareCtrl",resolve:{shareModalGivens:function(){return{url:c.app.url+"/"+a.targetUser.username}}}})},a.pageChanged=function(){n({index:a.paginationDateos.currentPage-1})},a.$on("user:hasDateado",function(b,c){c.created&&(a.targetUser.dateos.unshift(c.dateo),a.targetUser.dateo_count++)}),a.$on("user:dateoDelete",function(){a.targetUser.dateo_count--,n()}),e.username&&l()}]),angular.module("dateaWebApp").controller("UpdateuserCtrl",["$scope","User","$location","localStorageService","$rootScope",function(a,b,c,d,e){var f,g=d,h=g.get("user");b.getData({username:h.username}).then(function(a){f=a,angular.extend(h,f),g.set("user",h),e.$broadcast("user:signedUp"),b.updateUserDataFromStorage(),c.path("/signin")},function(a){console.log(a)})}]),angular.module("dateaWebApp").directive("daBgFromApi",["config",function(a){return{restrict:"A",scope:{daImgSize:"@",daImgPosition:"@",daImgRepeat:"@",daImgType:"@"},link:function(b,c,d){var e,f,g,h=angular.isDefined(d.daImgSize)?d.daImgSize:"auto",i=angular.isDefined(d.daImgPosition)?d.daImgPosition:"center center",j=angular.isDefined(d.daImgRepeat)?d.daImgRepeat:"no-repeat",k=angular.isDefined(d.daImgType)?d.daImgType:"campaign";switch(k){case"campaign":f=a.defaultImgCampaign;break;case"campaign-lg":f=a.defaultImgCampaignLarge,h="auto";break;case"user":f=a.defaultImgProfile;break;case"user-bg":f=a.defaultImgBackground;break;default:f=a.defaultImgCampaign}g=function(){e=d.daBgFromApi?a.api.imgUrl+d.daBgFromApi:f,"campaign-lg"===k&&(h=d.daBgFromApi?d.daImgSize:"auto")},d.$observe("daBgFromApi",function(){g(),c.css({"background-image":"url("+e+")","background-size":h,"background-repeat":j,"background-position":i})})}}}]),angular.module("dateaWebApp").service("ActivityUrl",function(){var a;return a=function(a){var b;switch(a.verb){case"dateo":b=a.action_object.user.username?"/"+a.action_object.user.username+"/dateos/"+a.action_object.id:"/"+a.target_object.user.username+"/dateos/"+a.target_object.id;break;case"commented":a.target_object.user.username&&(b="/"+a.target_object.user.username+"/dateos/"+a.target_object.id);break;case"voted":a.target_object.user.username&&(b="/"+a.target_object.user.username+"/dateos/"+a.target_object.id);break;case"redateo":a.target_object.user.username&&(b="/"+a.target_object.user.username+"/dateos/"+a.target_object.id);break;case"campaign":b="/"+a.actor.username+"/"+a.action_object.main_tag.tag;break;default:b="/"}return b},{parse:a}}),angular.module("dateaWebApp").controller("CampaignCtrl",["$scope","Api","$routeParams","config","$interpolate","$compile","leafletData","$timeout","$filter","User","$window","$modal","$location","leafletMarkersHelpers","$http","$document","geoJSONStyle","Piecluster","$rootScope","localStorageService","shareMetaData","Datear",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v){var w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,M,N,O,P,Q,R,S,T,U,V,W,X=0,Y=[],Z=[],ab={},X=0;a.campaign={},a.campaign.leaflet={},a.campaign.dateos={},a.dateFormat=d.defaultDateFormat,a.flow={},a.flow.notFound=!1,a.flow.userIsOwner=!1,a.flow.activeTab=m.search().tab||"map",a.flow.loading=!0,a.flow.mapIsPresent=!0,a.flow.colorRange=d3.scale.category10().range(),a.flow.hasLegend=!1,a.flow.showLegendExpandLink=!1,a.flow.showLegendContractLink=!1,a.flow.dateoShowListNumResults=d.defaultdateoNumResults,a.campaign.isUserSignedIn=j.isSignedIn(),a.dateamap={},a.chart={type:"pie",typeControl:"pie"},a.flow.dateoDetail={dateo:null,show:!1},a.query={},a.campaign.leaflet.events={enable:["leafletDirectiveMarker.click"]},F=function(){var c=K(a.campaign);b.campaign.getCampaigns({tags:c}).then(function(b){a.campaign.relatedCampaigns=b.objects[0]},function(a){console.log(a)})},B=function(b){var c=b&&b.dateos;X=0,a.campaign.leaflet.markers={},angular.forEach(c,function(a){a.position?(D(a),Y.push(L.latLng(a.position.coordinates[1],a.position.coordinates[0]))):X++}),c.length&&g.getMap("leafletCampaign").then(function(a){var b=L.latLngBounds(Y);a.fitBounds(b)})},C=function(b){var c=[],d=[];return angular.forEach(b.tags,function(b){angular.isDefined(a.subTags[b])&&d.push("#"+b),c.push(b)}),{lat:b.position.coordinates[1],lng:b.position.coordinates[0],group:a.campaign.main_tag.tag,label:{message:d.join(",")},draggable:!1,focus:!1,_id:b.id,tags:c,icon:M(b),riseOnHover:!0}};var M=function(a){var b,c,e;return c=d.visualization.markerWidth/a.colors.length,e=m.absUrl()+"#pinpath",b='<svg width="'+d.visualization.markerWidth+'" height="'+d.visualization.markerHeight+'"><g style="clip-path: url('+e+');">',_.each(a.colors,function(a,e){b=b+'<rect height="'+d.visualization.markerHeight+'" width="'+parseInt(Math.ceil(c))+'" fill="'+a+'" x="'+parseInt(Math.ceil(e*c))+'" />'}),b=b+'<circle cx="14.5" cy="13" r="4" fill="white" /><path d="'+d.visualization.markerSvgPath+'" stroke="#888888" fill="none" stroke-width="1" /></g></svg>',{type:"div",iconSize:[29,40],iconAnchor:[14.5,40],popupAnchor:[0,-33],labelAnchor:[8,-25],html:b,className:"datea-pin-icon"}};D=function(b){var c;c=C(b),a.campaign.leaflet.markers["marker"+b.id]=c,X++},J=function(b){o.get("views/dateo-map-popup.html").success(function(c){var e,h,i,j,k;j=Z.indexOf(b.options._id),h=a.$new(!0),h.dateo=a.campaign.dateos[j],h.dateFormat=d.defaultDateFormat,h.openDetail=function(){a.flow.openDateoDetail(h.dateo.id)},h.tags=h.dateo.tags.slice(0,2),e=f(angular.element(c)),i=e(h),k=b.getLatLng(),g.getMap("leafletCampaign").then(function(a){L.popup({offset:L.point(0,-32)}).setLatLng(k).setContent(i[0]).openOn(a)})})},E=function(){a.campaign.followers=[],b.user.getUsers({follow_key:"tag."+a.campaign.main_tag.id}).then(function(b){angular.extend(a.campaign.followers,b.objects)},function(a){console.log(a)})},y=function(){var e={},f={};e.user=c.username,e.slug=c.campaignName,j.isSignedIn()&&c.username===j.data.username&&(e.published="all"),b.campaign.getCampaigns(e).then(function(b){b.objects[0]?(angular.extend(a.campaign,b.objects[0]),a.campaign.secondary_tags&&a.campaign.secondary_tags.length>10&&(a.flow.colorRange=d3.scale.category20().range()),f={title:"#"+a.campaign.main_tag.tag+", "+a.campaign.name+" | Datea",description:a.campaign.short_description,imageUrl:a.campaign.image?a.campaign.image.image:d.defaultImgCampaignLarge},u.setData(f),a.flow.shareableUrl=d.app.url+"/"+a.campaign.user.username+"/"+a.campaign.slug,bb(),Q(),U(),a.flow.getDateos(),E(),F(),G(),I(),"stats"==a.flow.activeTab&&a.chart.buildCharts(),j.isSignedIn()&&j.data.id==a.campaign.user.id&&(a.flow.userIsOwner=!0),v.setContext({defaultTag:a.campaign.main_tag.tag,suggestedTags:a.campaign.secondary_tags,campaignId:a.campaign.id,boundary:a.campaign.boundary||null,layerFiles:a.campaign.layer_files})):m.path("/404").replace()},function(a){console.log(a),404===a.status&&m.path("/404").replace()})},I=function(){var b,c,d;a.campaign.end_date&&(b=Date.parse(a.campaign.end_date),d=new Date,c=new TimeSpan(b-d),a.flow.endDate=c.days<0?{type:"warning",msg:"Iniciativa ha expirado"}:0===c.days?{type:"normal",msg:"¡último dia para datear!"}:{type:"normal",msg:"faltan "+c.days+" días"})},z=function(){var d={user:c.username,main_tag:c.campaignName};b.campaign.getCampaigns(d).then(function(b){angular.extend(a.campaign,b.objects[0])},function(a){console.log(a)})},K=function(a){var b=a.main_tag,c=a.secondary_tags,d=[];return angular.forEach(c,function(a){!!a.tag&&d.push(a.tag)}),c.length?b.tag+","+d.join(","):b.tag},a.query={tag:"",limit:100,order_by:"-created"},a.flow.tagFilterOptions=[],a.flow.orderByOptions=[{val:"-created",label:"últimos"},{val:"-vote_count",label:"más apoyados"},{val:"-comment_count",label:"más comentados"}],a.flow.queryDone=!1,a.$watch("query.limit",function(){a.flow.queryLimitLabel=a.query.limit<1e3?"máximo "+a.query.limit:"todos los"}),Q=function(){a.campaign.secondary_tags&&(a.flow.tagFilterOptions.push({value:"",label:"-- todas -- "}),angular.forEach(a.campaign.secondary_tags,function(b){a.flow.tagFilterOptions.push({value:b.tag,label:"#"+b.tag})})),"owner"===a.campaign.default_filter&&(a.query.owner=!0)},H=function(){a.flow.showRedateoAuthor=a.query.owner?a.campaign.user.username:null},V=function(){var b={};for(var c in a.query)a.query[c]&&(b[c]="since"===c||"until"===c?a.query[c].toISOString():a.query[c]);m.search(b)},R=function(){var b=[a.campaign.main_tag.tag],c={},d=m.search();for(var e in d)"tab"!==e&&("tag"===e&&d.tag?b.push(d.tag):"owner"===e?(c.user_id=a.campaign.user.id,c.with_redateos=!0):c[e]=d[e]);return c.tags=b.join(","),b.length>0&&(c.tag_operator="and"),c.limit||(c.limit=a.query.limit),S(),c},U=function(){var b=m.search();for(var c in b)"tab"!==c&&(a.query[c]=b[c])},S=function(b){var c,d=[],e=a.query;c=void 0!==b?b>e.limit?e.limit:b:e.limit,c>0?("-created"===e.order_by&&d.push("últimos "+c),"-vote_count"===e.order_by&&d.push(c+" más apoyados"),"-comment_count"===e.order_by&&d.push(c+" más comentados")):d.push("sin resultados"),e.tag&&d.push("en #"+e.tag),e.owner&&d.push("por "+a.campaign.user.username),e.since&&e.until?d.push(i("date")(e.since,"d/M/yy")+" > "+i("date")(e.until,"d/M/yy")):(e.since&&d.push("desde &nbsp;"+i("date")(e.since,"d/M/yy")),e.until&&d.push("hasta &nbsp;"+i("date")(e.until,"d/M/yy"))),a.flow.queryTextRep=d},a.flow.getDateos=function(){if(a.campaign.id){var b,c=R(),d=a.flow.activeTab;"images"===d&&(c.has_images=1),b=JSON.stringify(c),ab[d]&&ab[d]===b||(ab[d]=b,a.flow.loading=!0,a.flow.queryDone=!1,H(),W(c))}},W=function(c){var e=Math.ceil(c.limit/d.dateosLoadedAtOnce),f=0,g=[],h=[],i=a.flow.activeTab;switch(i){case"map":a.campaign.dateos=[],a.campaign.leaflet.markers={};break;case"images":a.campaign.dateosWithImages=[];break;case"timeline":a.campaign.dateos=[]}c.offset=0;var j=function(c){b.dateo.getDateos(c).then(function(b){if(g=g.concat(b.objects.map(function(b){return b.timestamp=Date.parse(b.date||b.created).getTime(),b.colors=[],_.each(b.tags,function(c){c!=a.campaign.main_tag.tag&&a.subTags[c]&&b.colors.push(a.subTags[c].color)}),0==b.colors.length&&b.colors.push(d.visualization.default_color),b})),h=h.concat(b.objects.map(function(a){return a.id})),f++,f>=e||b.meta.total_count===g.length){switch(i){case"map":Z=h,a.campaign.dateos=g,B({dateos:g}),T();
break;case"images":var k=[];_.each(b.objects,function(a){_.each(a.images,function(b){b.dateo=a,k.push(b)})}),a.campaign.dateoImages=k;break;case"timeline":a.campaign.dateos=g}a.flow.loading=!1,a.flow.queryDone=!0,a.flow.dateoShowListNumResults=d.defaultdateoNumResults,S(g.length),s.$broadcast("dateoQuery:done")}else c.offset+=d.dateosLoadedAtOnce,j(c)},function(){console.log("reason")})};j(c)},a.$watch("flow.activeTab",function(){a.flow.getDateos(),m.search("tab",a.flow.activeTab),"stats"==a.flow.activeTab&&a.campaign.id&&a.chart.buildCharts()}),a.flow.getSearch=function(b){b.preventDefault(),a.flow.showFilter=!1,V(),a.flow.getDateos()},a.flow.showMoreListResults=function(){a.flow.dateoShowListNumResults+=d.defaultdateoNumResults};var bb=function(){var b={};a.campaign.secondary_tags.length>0&&(a.flow.hasLegend=!0),angular.forEach(a.campaign.secondary_tags,function(c,d){b[c.tag]={obj:c,color:a.flow.colorRange[d%20]}}),a.subTags=b};a.chart.buildCharts=function(){console.log("buildCharts"),b.stats.getStats({campaign:a.campaign.id}).then(function(b){a.chart.rawData=b,console.log("chart raw data",a.chart.rawData),"pie"==a.chart.type?N():"bar"==a.chart.type&&O(),h(function(){a.chart.visible=!0},10)},function(a){console.log(a)})},a.chart.changeChartType=function(){"pie"==a.chart.typeControl?N():"bar"==a.chart.typeControl&&O(),a.chart.type=a.chart.typeControl},N=function(){a.chart.data={series:[],data:[]},a.chart.config={title:"Estadísticas",tooltips:!0,labels:!0,legend:{display:!0,position:"right"},innerRadius:0,colors:[]},_.each(a.chart.rawData.tags,function(b){a.chart.data.data.push({x:"#"+b.tag,y:[b.count]}),a.chart.data.series.push("#"+b.tag),a.chart.config.colors.push(a.subTags[b.tag].color)}),console.log("scope.chart",a.chart)},O=function(){a.chart.data={series:[],data:[{x:"por etiquetas",y:[]}]},a.chart.config={title:"Estadísticas",tooltips:!0,labels:!1,legend:{display:!0,position:"right"},colors:[]},_.each(a.chart.rawData.tags,function(b){a.chart.data.data[0].y.push(b.count),a.chart.data.series.push("#"+b.tag),a.chart.config.colors.push("#"+a.subTags[b.tag].color)})},a.dateamap.focusDateo=function(b){var c;c="marker"+b,g.getMarkers("leafletCampaign").then(function(b){var d=n.getCurrentGroups()[a.campaign.main_tag.tag],e=b[c];d&&e&&d.zoomToShowLayer(e,function(){a.campaign.leaflet.markers[c].focus,J(e)})})},a.flow.openDateoDetail=function(b){var c=Z.indexOf(b),d=a.campaign.dateos[c];a.flow.dateoDetail.dateo=d,a.flow.dateoDetail.show=!0,d.position&&a.dateamap.focusDateo(b)},a.flow.closeDateoDetail=function(){a.flow.dateoDetail.dateo=null,a.flow.dateoDetail.show=!1},a.$on("focus-dateo",function(b,c){a.dateamap.focusDateo(c.id)}),a.$on("open-dateo-detail",function(b,c){a.flow.openDateoDetail(c.id)}),a.$on("close-dateo-detail",function(){a.flow.closeDateoDetail()}),a.$on("leafletDirectiveMarker.click",function(b,c){a.campaign.leaflet.markers[c.markerName].focus,J(c.leafletEvent.target)}),a.campaign.onSelectFilterChange=function(){A()},a.campaign.print=function(){k.print()},a.$on("user:hasDateado",function(b,c){c.created&&(a.campaign.dateos.unshift(c.dateo),Z.unshift(c.dateo.id),c.dateo.is_geolocated&&D(c.dateo),c.dateo.has_images&&a.campaign.dateosWithImages.unshift(c.dateo),z(),c.dateo.position&&a.dateamap.focusDateo(c.dateo.id))}),a.$on("user:dateoDelete",function(){a.flow.closeDateoDetail(),a.flow.getDateos(),z()}),G=function(){a.campaign.layer_files&&a.campaign.layer_files.length>0&&g.getMap("leafletCampaign").then(function(b){angular.forEach(a.campaign.layer_files,function(a){var c,e;c=a.file.split("/").slice(-1)[0],e=c.split(".").slice(-1)[0].toLowerCase(),"kml"===e?o.get(d.api.imgUrl+a.file).success(function(){L.geoJson(gjson,q).addTo(b)}):"json"===e&&o.get(d.api.imgUrl+a.file).success(function(a){L.geoJson(a,q).addTo(b)})})})},a.campaign.share=function(){var b=a.campaign.image?d.api.imgUrl+a.campaign.image.image:d.app.url+d.defaultImgCampaignLarge;l.open({templateUrl:"views/share.html",controller:"ShareCtrl",resolve:{shareModalGivens:function(){return{url:a.flow.shareableUrl,title:a.campaign.name,description:a.campaign.short_description,image:b}}}})},a.$on("user:follow",function(b,c){"follow"===c.op?a.campaign.follow_count++:a.campaign.follow_count--,E()}),c.username&&c.campaignName&&(y(),w=angular.copy(d.defaultMap),angular.extend(a.campaign.leaflet,w)),P=function(b){var c,d,e=b.getAllChildMarkers(),f=e.length,g=r.clusterSizeRange(e.length),h=g+1,i=g/2,j={},k=[];return angular.forEach(e,function(b){angular.forEach(b.options.tags,function(c){c!=a.campaign.main_tag.tag&&a.subTags[c]&&(j[c]?(j[c].value++,j[c].ids.push(b.options._id)):j[c]={label:"#"+c,value:1,tag:c,ids:[b.options._id]})})}),k=_.values(j),c=r.makeSVGPie({n:f,r:i,d:g,data:k,tags:a.subTags,secondaryTags:a.subTags}),d=new L.DivIcon({html:c,className:r.pieclusterConfig.clusterIconClassName,iconSize:new L.Point(h,h)})},a.campaign.leaflet.clusterOptions={iconCreateFunction:P,polygonOptions:{weight:1,fillColor:"#999",color:"#999",fillOpacity:.4}},a.flow.onLegendRender=function(){var b=angular.element(".legend-holder .tag-list").height();b>23&&(a.flow.showLegendExpandLink=!0)},a.flow.expandLegend=function(){angular.element(".legend-holder").addClass("expanded"),a.flow.showLegendExpandLink=!1,a.flow.showLegendContractLink=!0},a.flow.contractLegend=function(){angular.element(".legend-holder").removeClass("expanded"),a.flow.showLegendExpandLink=!0,a.flow.showLegendContractLink=!1},p.on("scroll",function(){var b=p.scrollTop();"undefined"==typeof x&&angular.element(".viz-holder").size()&&(x=angular.element(".viz-holder").position().top),x&&a.$apply(function(){a.flow.titleFix=b>x-60})}),a.flow.loadEmbedBuilder=function(){l.open({templateUrl:"views/embedbuilder.html",controller:"EmbedbuilderCtrl",resolve:{embedBuilderGivens:function(){return{author:a.campaign.user.username,mainTag:a.campaign.main_tag.tag,path:m.path()}}}})},$(window).resize(function(){T()}),T=function(){if(Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor")>0){var b=$(".dateo-map-viz"),c=b.height();$(".dateos-holder").css("height",c+"px"),a.flow.hasLegend&&(c-=32),$(".leaflet-map-holder").css("height",c+"px"),g.getMap("leafletCampaign").then(function(a){a.invalidateSize()})}},a.$on("$destroy",function(){Y=[],a.campaign={},n.resetCurrentGroups(),v.resetContext(),$(window).off("resize")})}]),angular.module("dateaWebApp").directive("scrollto",["config",function(){return{link:function(a,b,c){var d,e,f,g,h;g=a.$eval(c.scrollto),d=g.pos,e=g.container,f=g.target,b.bind("click",function(){h=$(e),h.animate({scrollTop:$(f+d).offset().top-50})})}}}]),angular.module("dateaWebApp").controller("LandingCtrl",["$scope","Api","config","shareMetaData",function(a,b,c,d){a.landing={},a.dateFormat=c.defaultDateFormat,d.resetToDefault(),b.stats.getStats().then(function(b){a.landing.dateo_count=b.dateo_count,a.landing.user_count=b.user_count},function(a){console.log(a)}),b.tag.getTrendingTags({limit:5,days:40}).then(function(b){a.landing.trendingTags=b.objects},function(a){console.log(a)}),b.dateo.getDateos({limit:1}).then(function(b){a.landing.outstandingDateo=b.objects[0]},function(a){console.log(a)}),b.campaign.getCampaigns({limit:4,order_by:"-featured,-created"}).then(function(b){a.landing.outstandingCampaigns=b.objects},function(a){console.log(a)})}]),angular.module("dateaWebApp").controller("CampaignDashboardCtrl",["$scope","Api","geolocation","config","leafletData","User","$location","$rootScope",function(a,b,c,d,e,f,g,h){var i,j,k,l,m=new L.FeatureGroup,n={edit:{featureGroup:m},draw:{marker:!1,polyline:!1,circle:!1,rectangle:!1,polygon:{allowIntersection:!1}}},o=new L.Control.Draw(n);a.newCampaign={},a.flow={},a.flow.categories,a.flow.validInput={},a.flow.messages={},a.flow.leaflet={},f.isSignedIn()||g.path("/"),k=function(b){var c={};console.log("sup onGeolocation"),c.center={lat:b.coords.latitude,lng:b.coords.longitude,zoom:d.dashboard.defaultZoom},c.controls={draw:{marker:!1,polyline:!1}},angular.extend(a.flow.leaflet,c)},l=function(){console.log("sup onGeolocationError")},i=function(){b.category.getCategories({}).then(function(b){a.flow.categories=b.objects,console.log(a.flow.categories)})},j=function(){c.getLocation({timeout:1e4}).then(l,l),angular.extend(a.flow.leaflet,d.defaultMap),angular.extend(a.flow.leaflet,{controls:{custom:[o]}}),a.newCampaign.boundary,e.getMap("leafletNewCampaign").then(function(b){b.on("draw:created",function(c){var d=c.layer;console.log(JSON.stringify(d.toGeoJSON())),a.newCampaign.boundary=d.toGeoJSON().geometry,m.addLayer(d),b.addLayer(d),angular.element("div.leaflet-draw-toolbar-top").hide()}),b.on("draw:deleted",function(a){var c=a.layers._layers[Object.keys(a.layers._layers)[0]];console.log("draw:deleted",a.layers._layers),b.removeLayer(c),angular.element("div.leaflet-draw-toolbar-top").show()})})},a.flow.checkMainTag=function(){a.flow.messages.mainTagExists="",a.newCampaign.main_hashtag&&b.campaign.getCampaigns({main_tag:a.newCampaign.main_hashtag}).then(function(b){console.log("checkMainTag",b,!!b.objects.length),a.flow.validInput.mainTag=!b.objects.length,a.flow.messages.mainTagExists=b.objects.length?d.dashboard.validationMsgs.mainTagExists:""},function(a){console.log(a)})},a.flow.hashtagify=function(a){var b=[];return a.split(" ").map(function(a){b.push(a.charAt(0).toUpperCase()+a.slice(1))}),"#"+b.join("")},a.flow.addTag=function(){a.newCampaign.nextTag&&a.newCampaign.tags.push({title:a.newCampaign.nextTag,tag:a.flow.hashtagify(a.newCampaign.nextTag)}),a.newCampaign.nextTag=""},h.$on("datea:fileLoaded",function(b,c){c.data.name&&a.newCampaign.files.push({name:c.data.name,data:c.file}),a.newCampaign.nextFile=null,a.newCampaign.nextFileData=null}),a.flow.arrowUp=function(b){var c;b>0&&(c=a.newCampaign.tags[b-1],a.newCampaign.tags[b-1]=a.newCampaign.tags[b],a.newCampaign.tags[b]=c)},a.flow.arrowDown=function(b){var c;b<a.newCampaign.tags.length-1&&(c=a.newCampaign.tags[b+1],a.newCampaign.tags[b+1]=a.newCampaign.tags[b],a.newCampaign.tags[b]=c)},a.flow.removeTag=function(b){a.newCampaign.tags.splice(b,1)},a.flow.removeFile=function(b){a.newCampaign.files.splice(b,1)},a.flow.today=function(){a.flow.dt=new Date},a.flow.minDate=null,a.flow.dateOptions={"year-format":"'yy'","starting-day":1},a.newCampaign.tags=[{title:"Autos Mal Estacionados",tag:"#AutosMalEstacionados"}],a.newCampaign.files=[],a.newCampaign.save=function(){var c={};c.name=a.newCampaign.title,c.published=1,c.end_date=a.flow.dt&&a.flow.dt,c.short_description=a.newCampaign.mission.substring(0,140)||"no description",c.mission=a.newCampaign.mission.substring(0,500)||"no mission",c.information_destiny=a.newCampaign.information_destiny,c.category=a.flow.selectedCategory,c.main_tag={tag:a.newCampaign.main_hashtag},c.secondary_tags=a.newCampaign.tags,c.files=a.newCampaign.files.length&&a.newCampaign.files,c.center={type:"Point",coordinates:[-77.027772,-12.121937]},c.boundary=a.newCampaign.boundary,c.zoom=a.flow.leaflet.center.zoom,e.getMap("leafletNewCampaign").then(function(a){c.center=a.getCenter(),console.log("getcenter",c.center)},function(a){console.log(a)}),b.campaign.postCampaign(c).then(function(a){console.log(a),console.log("postCampaign")},function(a){console.log("postCampaign reason: ",a)})},i(),j()}]),angular.module("dateaWebApp").controller("ShareCtrl",["$scope","$modalInstance","shareModalGivens",function(a,b,c){a.share={},a.share.url=c.url,a.share.title=c.title,a.share.description=c.description,a.share.image=c.image}]),angular.module("dateaWebApp").controller("TagCtrl",["$scope","Api","$routeParams","$location","$q","User","$modal","config","$filter","$interpolate","leafletData","$timeout","leafletMarkersHelpers","$http","$compile","shareMetaData","Datear","$document",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r){var s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,M,N,O=0,P=[];a.tag={},a.tag.selectedMarker="last",a.flow={},a.flow.loading=!0,a.flow.leaflet={},a.flow.isUserSignedIn=f.isSignedIn(),a.flow.dateoDetail={dateo:null,show:!1},a.$watch("query.limit",function(){a.flow.limitLabel=a.query.limit<1e3?"máximo "+a.query.limit:"todos los"}),a.flow.orderByOptions=[{val:"-created",label:"últimos"},{val:"-vote_count",label:"más apoyados"},{val:"-comment_count",label:"más comentados"}],a.query={limit:d.search().limit||100,order_by:d.search().order_by||"-created",tab:d.search().tab||"map"},d.search().since&&(a.query.since=Date.parse(d.search().since)||void 0),d.search().until&&(a.query.until=Date.parse(d.search().until)||void 0),d.search().q&&(a.query.q=d.search().q),a.dateFormat=h.defaultDateFormat,a.flow.leaflet.events={enable:["leafletDirectiveMarker.click"]},t=h.visualization.defaultMarkerIcon,t.html=h.visualization.defaultMarkerIcon.htmlGen(d.absUrl()),u=function(){var a=e.defer();return b.campaign.getCampaigns({main_tag:c.tagName,order_by:"-dateo_count"}).then(function(b){a.resolve({isMainTag:!!b.objects.length,tagObj:b.objects})},function(b){a.reject(b)}),a.promise},B=function(){b.tag.getTags({tag:c.tagName}).then(function(b){var c;b.objects.length?(angular.extend(a.tag,b.objects[0]),M(),c={title:"Datea | dateos en #"+a.tag.tag,description:"Chequea los dateos con el hashtag #"+a.tag.tag+" en Datea."},p.setData(c),a.flow.shareableUrl=h.app.url+"/tag/"+a.tag.tag):d.path("/404").replace()},function(a){console.log(a),404===a.status&&d.path("/404").replace()})},C=function(){b.tag.getTags({tag:c.tagName}).then(function(b){angular.extend(a.tag,b.objects[0])},function(a){console.log(a)})},J=function(){var a={tags:c.tagName};for(var b in d.search())"tab"!==b&&(a[b]=d.search()[b]);return a},I=function(b){var c,d=[],e=a.query;c=void 0!==b?b>e.limit?e.limit:b:e.limit,c>0?("-created"===e.order_by&&d.push("últimos "+c),"-vote_count"===e.order_by&&d.push(c+" más apoyados"),"-comment_count"===e.order_by&&d.push(c+" más comentados")):d.push("sin resultados"),e.since&&e.until?d.push(i("date")(e.since,"d/M/yy")+" > "+i("date")(e.until,"d/M/yy")):(e.since&&d.push("desde &nbsp;"+i("date")(e.since,"d/M/yy")),e.until&&d.push("hasta &nbsp;"+i("date")(e.until,"d/M/yy"))),a.flow.queryTextRep=d},K=function(){var b={};for(var c in a.query)a.query[c]&&(b[c]="since"===c||"until"===c?a.query[c].toISOString():a.query[c]);d.search(b)},M=function(){var c,e=d.search().tab||"map";a.flow.showFilter=!1,a.flow.loading=!0,c=J(),"map"===e?(a.tag.dateos=[],a.flow.leaflet.markers={}):"images"===e&&(a.tag.dateosWithImages=[],c.has_images=1),b.dateo.getDateos(c).then(function(b){if("map"===e)N(),a.flow.dateoShowListNumResults=h.defaultdateoNumResults,a.tag.dateos=b.objects,s=b.objects.map(function(a){return a.id}),x({dateos:b.objects});else if("images"===e){var c=[];_.each(b.objects,function(a){_.each(a.images,function(b){b.dateo=a,c.push(b)})}),a.tag.dateoImages=c}I(b.objects.length),a.flow.loading=!1},function(a){console.log(a)})},a.flow.doSearch=function(){K(),M()},a.flow.showMoreListResults=function(){a.flow.dateoShowListNumResults+=h.defaultdateoNumResults},a.flow.openTab=function(b){d.search("tab",b),a.query.tab=b,a.flow.doSearch()},a.flow.share=function(){var b=h.app.url+"/static/images/logo-large.png";g.open({templateUrl:"views/share.html",controller:"ShareCtrl",resolve:{shareModalGivens:function(){return{url:a.flow.shareableUrl,title:"Datea | dateos en #"+a.tag.tag,description:"Chequea los dateos con el hashtag #"+a.tag.tag+" en Datea.",image:b}}}})},x=function(b){var c=b&&b.dateos;O=0,a.flow.leaflet.markers={},angular.forEach(c,function(a){a.position&&(A(a),P.push([a.position.coordinates[1],a.position.coordinates[0]]))}),c.length&&k.getMap("leafletTag").then(function(a){a.fitBounds(P)})},y=function(b){return{lat:b.position.coordinates[1],lng:b.position.coordinates[0],group:a.tag.tag,label:{message:"#"+a.tag.tag},draggable:!1,focus:!1,_id:b.id,icon:t,riseOnHover:!0}},A=function(b){var c=y(b);a.flow.leaflet.markers["marker"+b.id]=c,O++},z=function(b){n.get("views/dateo-map-popup.html").success(function(c){var d,e,f,g,i;g=s.indexOf(b.options._id),e=a.$new(!0),e.dateo=a.tag.dateos[g],e.dateFormat=h.defaultDateFormat,e.openDetail=function(){a.flow.openDateoDetail(e.dateo.id)},e.tags=e.dateo.tags.slice(0,2),d=o(angular.element(c)),f=d(e),i=b.getLatLng(),k.getMap("leafletTag").then(function(a){L.popup({offset:L.point(0,-32)}).setLatLng(i).setContent(f[0]).openOn(a)})})},a.clusterOptions={polygonOptions:{weight:1,fillColor:"#999",color:"#999",fillOpacity:.4}},D=function(a){d.path(a.username+"/"+a.tagName).replace()},a.tag.isUserFollowing=function(){return v()},q.setContext({defaultTag:c.tagName}),a.$on("user:hasDateado",function(b,c){c.created&&(a.tag.dateos.unshift(c.dateo),s.unshift(c.dateo.id),c.dateo.is_geolocated&&A(c.dateo),c.dateo.has_images&&a.tag.dateosWithImages.unshift(c.dateo),C(),c.dateo.position&&a.flow.focusDateo(c.dateo.id))}),a.$on("user:dateoDelete",function(){a.flow.closeDateoDetail(),a.flow.doSearch(),C()}),a.flow.focusDateo=function(b){var c;c="marker"+b,k.getMarkers("leafletTag").then(function(b){var d=m.getCurrentGroups()[a.tag.tag],e=b[c];d&&e&&d.zoomToShowLayer(e,function(){a.flow.leaflet.markers[c].focus,z(e)})})},a.flow.openDateoDetail=function(b){var c=s.indexOf(b),d=a.tag.dateos[c];a.flow.dateoDetail.dateo=d,a.flow.dateoDetail.markerIndex=c,a.flow.dateoDetail.show=!0,d.position&&a.flow.focusDateo(b)},a.flow.closeDateoDetail=function(){a.flow.dateoDetail.dateo=null,a.flow.dateoDetail.show=!1},a.$on("focus-dateo",function(b,c){a.flow.focusDateo(c.id)}),a.$on("open-dateo-detail",function(b,c){a.flow.openDateoDetail(c.id)}),a.$on("close-dateo-detail",function(){a.flow.closeDateoDetail()}),a.$on("leafletDirectiveMarker.click",function(b,c){a.flow.leaflet.markers[c.markerName].focus=!0,z(c.leafletEvent.target)}),a.tag.searchDateos=function(){a.tag.searchDateosKeyword?w({q:a.tag.searchDateosKeyword}):w(),a.flow.loading=!1},a.flow.scrollToCampaigns=function(a){a.preventDefault(),a.stopPropagation(),r.scrollToElement($("#campaigns"),100,400)},G=d3.scale.linear().domain([0,100]).range([50,80]).clamp(!0),E=function(a){var b,c,d=a.getAllChildMarkers(),e=d.length,f=G(d.length),g=f+1,h=f/2;return b=F({n:e,r:h,d:f}),c=new L.DivIcon({html:b,className:"marker-cluster",iconSize:new L.Point(g,g)})},F=function(a){var b,c;return b=document.createElementNS(d3.ns.prefix.svg,"svg"),c=d3.select(b).data([a.data]).attr("class","datea-svg-cluster").attr("width",a.d).attr("height",a.d).append("svg:g").attr("transform","translate("+a.r+","+a.r+")"),c.append("circle").attr("fill",h.visualization.default_color).attr("r",a.r).attr("cx",0).attr("cy",0).attr("opacity",.75),c.append("circle").attr("fill","#ffffff").attr("r",a.r/2.2).attr("cx",0).attr("cy",0),c.append("text").attr("x",0).attr("y",0).attr("class","cpie-label").attr("text-anchor","middle").attr("dy",".3em").text(a.n),H(b)},a.flow.leaflet.clusterOptions={iconCreateFunction:E,polygonOptions:{weight:1,fillColor:"#999",color:"#999",fillOpacity:.4}},H=function(a){return"undefined"!=typeof window.XMLSerializer?(new window.XMLSerializer).serializeToString(a):"undefined"!=typeof a.xml?a.xml:""},c.tagName&&(u().then(function(b){b.tagObj.length>0&&(a.campaignsInTag=b.tagObj),B()},function(a){console.log(a)}),angular.extend(a.flow.leaflet,h.defaultMap)),$(window).resize(function(){N()}),N=function(){if(Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor")>0){var a=$(".dateo-map-viz"),b=a.height();$(".leaflet-map-holder, .dateos-holder").css("height",b+"px"),k.getMap("leafletTag").then(function(a){a.invalidateSize()})}},a.$on("$destroy",function(){P=[],a.tag={},m.resetCurrentGroups(),q.resetContext(),$(window).off("resize")})}]),angular.module("dateaWebApp").service("State",function(){var a={};return{state:a}}),angular.module("dateaWebApp").directive("daDateoTeaser",["$rootScope","$location","$modal","config",function(a,b,c,d){return{restrict:"E",transclude:!0,replace:!0,templateUrl:"/views/dateo-teaser.html",controller:["$scope","$element","$attrs",function(e,f,g){var h;if(e.teaser={},e.timeline&&e.timeline.activeDateo&&(e.dateo=e.timeline.activeDateo),e.mapPresent=g.mapPresent?e.$eval(g.mapPresent):!0,e.detailInline=g.detailInline?e.$eval(g.detailInline):!0,e.campaignId=g.campaignId?e.$eval(g.campaignId):null,e.mainTag=g.mainTag?e.$eval(g.mainTag):null,e.createdFormat=d.defaultDateFormat,e.dateFormat=d.dateFieldFormat,e.forceDate=g.forceDate?e.$eval(g.forceDate):!1,e.mainTag&&e.dateo&&e.dateo.tags.length&&e.dateo.tags[0]!=e.mainTag){var i=e.dateo.tags.indexOf(e.mainTag);e.dateo.tags.splice(i,1),e.dateo.tags.unshift(e.mainTag)}h=function(){var a;e.campaignId&&e.dateo.admin&&e.dateo.admin[e.campaignId]&&(a=e.dateo.admin[e.campaignId].status,"new"!=a&&(e.flow.status={msg:"reviewed"==a?"atendido":"solucionado",type:a}))},e.focusDateo=function(){a.$broadcast("focus-dateo",{id:e.dateo.id})},e.openDetail=function(){e.detailInline?a.$broadcast("open-dateo-detail",{id:e.dateo.id}):(console.log(e.dateo.user.username+"/dateos/"+e.dateo.id),b.path(e.dateo.user.username+"/dateos/"+e.dateo.id))},e.teaser.imgDetail=function(a){var b;b={templateUrl:"views/dateo-detail-img.html",controller:"DateoimgCtrl",resolve:{img:function(){return a}}},c.open(b)},h()}]}}]),angular.module("dateaWebApp").directive("daDateoThumb",function(){return{restrict:"E",templateUrl:"/views/dateo-thumb.html"}}),angular.module("dateaWebApp").directive("daCampaignTeaser",function(){return{restrict:"E",templateUrl:"views/campaign-teaser.html"}}),angular.module("dateaWebApp").controller("LayoutCtrl",["$scope","$rootScope","$location","User","config",function(a,b,c,d,e){var f,g;a.flow={},b.$on("$locationChangeStart",function(){f=c.path(),"/"==f?(a.flow.autoheight=!0,a.flow.withNav=d.isSignedIn()):(g=f.split("/")[1],a.flow.autoheight=-1==e.layout_100.indexOf(g)?!0:!1,a.flow.withNav=!0)}),b.$on("user:signedOut",function(){a.flow.withNav=!1})}]),angular.module("dateaWebApp").directive("daOnLastRepeat",["$timeout",function(a){return{restrict:"A",link:function(b,c,d){b.$last===!0&&a(function(){b.$eval(d.daOnLastRepeat)})}}}]),angular.module("dateaWebApp").directive("daFollow",["Api","User","$location","localStorageService","$rootScope",function(a,b,c,d,e){return{restrict:"E",templateUrl:"/views/follow-button.html",replace:!0,scope:{btnClass:"@",followObj:"=",followId:"@",followLabel:"@"},controller:["$scope","$element","$attrs",function(f,g,h){var i,j,k,l,m,n,o;j=h.followObj,o=d,f.btnClass=angular.isDefined(h.btnClass)?h.btnClass:"",f.flow={},f.flow.isFollowing=!1,f.flow.loading=!0,f.flow.followingChanged=!1,f.flow.followLabel=h.followLabel?h.followLabel:"seguir",h.$observe("followId",function(a){angular.isDefined(a)&&(i=j+"."+a,k())});var k=function(){a.follow.getFollows({user:b.data.id,follow_key:i}).then(function(a){f.flow.isFollowing=0!=a.objects.length,f.flow.loading=!1},function(a){console.log(a)})};l=function(){b.isSignedIn()&&0==f.flow.loading?(f.flow.loading=!0,a.follow.doFollow({follow_key:i}).then(function(){b.updateUserDataFromApi(),f.flow.loading=!1,f.flow.isFollowing=!0,f.flow.followingChanged=!0,e.$broadcast("user:follow",{followKey:i,op:"follow"})},function(a){f.flow.loading=!1,console.log(a)})):(n=c.path(),o.set("nextURL",{path:n,count:0}),c.path("/registrate"))},m=function(){f.flow.loading||(f.flow.loading=f.flow.removing=!0,a.follow.doUnfollow({user:b.data.id,follow_key:i}).then(function(){b.updateUserDataFromApi(),f.flow.loading=f.flow.isFollowing=f.flow.removing=!1,f.flow.followingChanged=!0,e.$broadcast("user:follow",{followKey:i,op:"unfollow"})},function(a){f.flow.loading=!0,console.log(a)}))},f.doFollowAction=function(){f.flow.isFollowing?m():l()},f.$on("user:doFollow",function(a,b){b.followKey!==i||f.flow.isFollowing||l()})}]}}]),angular.module("dateaWebApp").directive("daCampaignForm",["Api","geolocation","config","leafletData","User","$location","$rootScope","$document","$http","geoJSONStyle",function(a,b,c,d,e,f,g,h,i,j){return{restrict:"E",scope:{mode:"=",campaignId:"=?"},templateUrl:"views/campaign-form.html",controller:["$scope","$element","$attrs",function(h,k,l){var m,n,o,p,q,r,s,t,u,v,w,x,y,z=new L.FeatureGroup,A={edit:{featureGroup:z},draw:{marker:!1,polyline:!1,circle:!1,rectangle:!1,polygon:{allowIntersection:!1}}},B=new L.Control.Draw(A);e.isSignedIn()||f.path("/"),m=l.mode,h.campaign={main_tag:{},secondary_tags:[],published:!0,default_vis:"map",layer_files:[]},h.help={},h.flow={},h.flow.categories,h.flow.loading=!1,h.flow.validInput={},h.flow.messages={},h.flow.alerts=[],h.flow.mode=m,h.flow.leaflet={controls:{custom:[B]},center:c.defaultMap.center,fileLayers:[]},d.getMap("leafletNewCampaign").then(function(a){h.flow.leaflet.map=a}),h.flow.urlBase=f.protocol()+"://"+f.host()+"/"+e.data.username+"/",h.flow.dp={minDate:null,dateOptions:{"year-format":"yy","starting-day":1},format:"dd-MMMM-yyyy",opened:!1},h.flow.dp.openDatepicker=function(a){a.stopPropagation(),a.preventDefault(),h.flow.dp.opened=!0},h.flow.dp.clear=function(){h.flow.dp.endDate=null},h.$watch("flow.dp.endDate",function(){h.campaign.end_date=h.flow.dp.endDate?h.flow.dp.endDate.toISOString():null}),"edit"===m&&(h.flow.loading=!0,n={id:h.campaignId,published:"all"},a.campaign.getCampaigns(n).then(function(a){if(0===a.objects.length)return void f.path("/404").replace();var b,d,g=[];return angular.extend(h.campaign,a.objects[0]),e.data.id!=h.campaign.user.id?void f.path("/"):(o=h.campaign.main_tag.tag,h.flow.selectedCategory=h.campaign.category.id,h.flow.leaflet.center={lat:h.campaign.center.coordinates[1],lng:h.campaign.center.coordinates[0],zoom:h.campaign.zoom},h.campaign.end_date&&(h.flow.dp.endDate=Date.parse(h.campaign.end_date)),h.campaign.boundary&&h.campaign.boundary.coordinates&&(angular.forEach(h.campaign.boundary.coordinates[0],function(a){g.push(L.latLng(a[1],a[0]))}),b=L.polygon(g,{color:"#E65F00",fillColor:"#E65F00",fillOpacity:.2}),z.addLayer(b),h.flow.leaflet.map.addLayer(b),d=b.getBounds(),h.flow.leaflet.map.getBounds().contains(d)||setTimeout(function(){h.flow.leaflet.map.fitBounds(d)},300)),h.campaign.image&&(h.flow.img=c.api.imgUrl+h.campaign.image.image),h.campaign.image2&&(h.flow.img2=c.api.imgUrl+h.campaign.image2.image),h.campaign.layer_files&&h.campaign.layer_files.length>0&&angular.forEach(h.campaign.layer_files,function(a){var b,d;b=a.file.split("/").slice(-1)[0],d=b.split(".").slice(-1)[0].toLowerCase(),"kml"===d?i.get(c.api.imgUrl+a.file).success(function(a){var c,d;c=toGeoJSON.kml(a,{styles:!0}),d=L.geoJson(c,j).addTo(h.flow.leaflet.map),h.flow.leaflet.fileLayers.push({layer:d,name:b})}):"json"===d&&i.get(c.api.imgUrl+a.file).success(function(a){var c;c=L.geoJson(a,j).addTo(h.flow.leaflet.map),h.flow.leaflet.fileLayers.push({layer:c,name:b})})}),h.campaign.main_tag.tag.toLowerCase()!==h.campaign.slug&&(h.flow.showSlugField=!0),void(h.flow.loading=!1))},function(a){h.flow.loading=!1,console.log(a),404===a.status&&f.path("/404").replace()})),t=function(a){var b={};b=angular.copy(c.defaultMap),b.center={lat:a.coords.latitude,lng:a.coords.longitude,zoom:c.dashboard.defaultZoom},angular.extend(h.flow.leaflet,b)},u=function(){console.log("sup onGeolocationError")},q=function(){a.category.getCategories({}).then(function(a){h.flow.categories=a.objects})},r=function(a){for(var b=0;b<h.flow.categories.length;b++)if(h.flow.categories[b].id==a)return h.flow.categories[b]},s=function(){b.getLocation({timeout:1e4}).then(u,u),angular.extend(h.flow.leaflet,c.defaultMap),angular.extend(h.flow.leaflet,{controls:{custom:[B]}}),d.getMap("leafletNewCampaign").then(function(a){a.on("draw:created",function(b){var c=b.layer;h.campaign.boundary=c.toGeoJSON().geometry,z.addLayer(c),a.addLayer(c),angular.element("div.leaflet-draw-toolbar-top").hide()}),a.on("draw:deleted",function(b){var c=b.layers._layers[Object.keys(b.layers._layers)[0]];a.removeLayer(c),angular.element("div.leaflet-draw-toolbar-top").show()})})},h.flow.checkMainTag=function(){h.campaign.main_tag.tag=y(h.campaign.main_tag.tag),h.flow.messages.mainTagExists="",h.campaign.main_tag.tag?a.campaign.getCampaigns({main_tag:h.campaign.main_tag.tag}).then(function(a){var b=!1;return h.campaign.id&&1===a.objects.length&&a.objects[0].id==h.campaign.id?(h.flow.validInput.mainTag=!0,h.flow.messages.mainTagExists="",h.campaign.slug=h.campaign.main_tag.tag,h.flow.showSlugField=!1,void(h.flow.campaignNeedsSlug=!1)):(h.flow.validInput.mainTag=a.objects.length?"warning":!0,h.flow.messages.mainTagExists=a.objects.length?c.dashboard.validationMsgs.mainTagExists:"",h.flow.showSlugField=!1,p=!1,h.campaign.id||angular.forEach(a.objects,function(a){a.user.id===e.data.id&&(b=!0,h.flow.messages.mainTagExists=c.dashboard.validationMsgs.duplicateUserTag,h.campaign.slug=null,h.flow.showSlugField=!0,p=!0)}),b||(h.campaign.slug=h.campaign.main_tag.tag),void 0)},function(a){console.log(a)}):(h.flow.validInput.mainTag=null,h.flow.messages.mainTagExists="")},h.flow.checkSlug=function(){h.campaign.slug&&(h.campaign.slug=h.campaign.slug.replace(/[^a-z0-9-]/gi,"")),h.campaign.slug?a.campaign.getCampaigns({slug:h.campaign.slug,user:e.data.username}).then(function(a){h.campaign.id&&1===a.objects.length&&a.objects[0].id===h.campaign.id?(h.flow.validInput.slug=!0,h.flow.messages.slugError=""):(h.flow.validInput.slug=a.objects.length?!1:!0,h.flow.messages.slugError=a.objects.length?c.dashboard.validationMsgs.slugError:"")}):h.flow.validInput.slug=null},y=function(a){var b=a.split(" ");return b=b.map(function(a){return a=a.replace(/[^a-z0-9]/gi,""),a.charAt(0).toUpperCase()+a.slice(1)}),b.join("")},h.flow.addTag=function(){h.flow.nextTag&&h.campaign.secondary_tags.push({title:h.flow.nextTag,tag:y(h.flow.nextTag)}),h.flow.nextTag=""},v=function(a){return decodeURIComponent(escape(window.atob(a)))},g.$on("datea:fileLoaded",function(a,b){var c,e,f,g,i;g=b.data.name.split(".").slice(-1)[0].toLowerCase(),!b.data.name||"kml"!==g&&"json"!==g||(h.campaign.layer_files.push({file:{name:b.data.name,data_uri:b.file}}),"kml"===g?(c=v(b.file.split(";base64,")[1]),e=(new DOMParser).parseFromString(c,"text/xml"),f=toGeoJSON.kml(e,{styles:!0})):"json"===g&&(f=JSON.parse(v(b.file.split(";base64,")[1]))),i=L.geoJson(f,j).addTo(h.flow.leaflet.map),h.flow.leaflet.fileLayers.push({layer:i,name:b.data.name}),d.getMap("leafletNewCampaign").then(function(a){a.fitBounds(i.getBounds())})),h.flow.nextFile=null,h.flow.nextFileData=null}),h.flow.arrowUp=function(a){var b;a>0&&(b=h.campaign.secondary_tags[a-1],h.campaign.secondary_tags[a-1]=h.campaign.secondary_tags[a],h.campaign.secondary_tags[a]=b)},h.flow.arrowDown=function(a){var b;a<h.campaign.secondary_tags.length-1&&(b=h.campaign.secondary_tags[a+1],h.campaign.secondary_tags[a+1]=h.campaign.secondary_tags[a],h.campaign.secondary_tags[a]=b)},h.flow.removeTag=function(a){h.campaign.secondary_tags.splice(a,1)},h.flow.removeFile=function(a){h.campaign.layer_files.splice(a,1),h.flow.leaflet.map.removeLayer(h.flow.leaflet.fileLayers[a].layer),h.flow.leaflet.fileLayers.splice(a,1)},h.flow.today=function(){h.flow.dt=new Date},h.flow.save=function(){var b;h.campaign.category=r(h.flow.selectedCategory),h.campaign.layer_files=h.campaign.layer_files&&h.campaign.layer_files.length?h.campaign.layer_files:[],h.campaign.center={type:"Point",coordinates:[-77.027772,-12.121937]},h.campaign.zoom=h.flow.leaflet.center.zoom,h.flow.imgData&&(h.campaign.image={image:{name:h.flow.imgData.name,data_uri:h.flow.img}}),h.flow.imgData2&&(h.campaign.image2={image:{name:h.flow.imgData2.name,data_uri:h.flow.img2}}),b=h.flow.leaflet.map.getCenter(),h.campaign.center={coordinates:[b.lng,b.lat],type:"Point"},o&&o!==h.campaign.main_tag.tag&&(h.campaign.main_tag={tag:h.campaign.main_tag.tag}),w()&&(h.flow.loading=!0,h.campaign.id?a.campaign.patchCampaign({objects:[h.campaign]}).then(function(a){f.url("/"+e.data.username+"/"+a.objects[0].slug)},function(a){console.log("patchCampaign reason: ",a),h.flow.loading=!1}):a.campaign.postCampaign(h.campaign).then(function(b){a.follow.doFollow({follow_key:"tag."+b.main_tag.id}).then(function(){f.url("/"+e.data.username+"/"+b.slug)})},function(a){console.log("postCampaign reason: ",a),h.flow.loading=!1}))},w=function(){var a=["name","main_tag","category","short_description","mission","information_destiny"],b=!0;
p&&a.push("slug");for(var c in h.flow.validInput)h.flow.validInput[c]=null;for(var d in a){var c=a[d];("main_tag"!==c&&!h.campaign[c]||"main_tag"===c&&$.isEmptyObject(h.campaign[c]))&&(b=!1,h.flow.validInput[c]=!1)}return b||(h.flow.alerts=["Uy, parece que te faltó llenar algún campo. Chequea los campos marcados en rojo y vuélvelo a intentar."]),b},h.flow.closeAlert=function(a){h.flow.alerts.splice(a,1)},h.flow.autocompleteTag=function(b){return a.tag.getAutocompleteByKeyword({q:b.replace("#","")}).then(function(a){var b=[];return angular.forEach(a.suggestions,function(a){b.push(a)}),b})},x=function(b){a.follow.doFollow({follow_key:"tag."+b})},h.help={name:{content:"Escoge un título llamativo, que describa e identifique tu iniciativa."},mainTag:{title:"Tag principal",content:"Este tag identifica tu iniciativa dentro y fuera de Datea. ¡Escogelo bien! Toma en cuenta: que sea simple, identifique claramente tu iniciativa, no sea muy generico a menos que desees compartirlo. Tips para diferenciar: inluye siglas de tu organización, el lugar, año etc."},published:{content:"Las iniciativas publicadas aparece en nuestra busqueda."},image:{content:"La imágen que identifica a tu iniciativa en los listados (busqueda, inicio etc). Recomendamos una imagen distinctiva (logo, afiche, foto emblemática), y que el contenido principal se encuentrecentrado."},image2:{content:"La imágen que sale en tu iniciativa en el banner (arriba a la derecha).Recomendamos una imagen con formato horizontal, de preferencia alargado (16:9), para que ocupe mas espacio en el banner."},endDate:{content:"Opcionalmente puedes indicar una fecha de cierre de tu iniciativa."},category:{content:"Esta categoría ayuda a encontrar tu iniciativa en nuestra busqueda de iniciativas."},shortDescription:{content:"Slogan, subtítulo o descripción corta de iniciativa (max 140 caractéres)."},mission:{content:"Explícale a los usuarios la razón por la que deben participar de la iniciativa: objetivos, que se espera lograr."},informationDestiny:{content:"Indica qué sucederá con la información que se recopila, si se va a mandar a algún lugar, quién la va a recibir etc."},secondaryTags:{title:"Etiquetas",content:"Estas etiquetas le son sugeridas a los usuarios para categorizar sus dateos. Por ello, ayudan luego a analizar mejor la información. Recomendamos elegir con cuidado, reutilizar etiquetas cuando sea pertinente y no usar demasiadas (idealmente no más de 7)."},map:{title:"Opciones de ubicación",content:"Coloca el mapa en el lugar y nivel de zoom, en que quieres que aparezca. Opcionalmente puedes delimitar la zona de dateo con un polígono, utilizando el control respectivo en la parte superior izquierda del mapa. "},layerFiles:{title:"Archivos Kml/geoJSON",content:"Opcionalmente puedes subir archivos kml o geoJSON para mostrar puntos, lineas y polígonos, incluyendo texto en popups. Recomendamos para ello crear archivos geoJSON en Mapbox, porque son más compatibles con Datea y siempre conservan el estilo."},defaultVis:{content:"Elige cual de las visualizaciones aparecerá por defecto. Elige la que tenga más sentido para tu iniciativa."},defaultFilter:{content:"Si deseas moderar el contenido de tu iniciativa (aprobar dateos de otros usuarios), entonces te sugerimos que enciendas este filtro. Asi aparecerán por defecto sólo tus dateos y los que re-dateas. Los usuarios pueden desactivar el filtro si lo desean."},slug:{title:"Componente de URL",content:"La URLs de iniciativas normalmente se compone de tu usuario y el tag principal. Como ya tienes una iniciativa con ese tag, es necesario que indiques una alternativa. Se aceptan letras, números y giones. Sin tildes, espacios, diéresis etc."}},q(),s()}],link:function(a){var b=60;a.scrollTo=function(b,c,d){b.stopPropagation(),b.preventDefault(),a.flow.isScrolling=!0;var e=angular.element(document.getElementById(c));h.scrollToElement(e,d,400).then(function(){a.flow.isScrolling=!1})},h.on("scroll",function(){a.$apply(function(){a.flow.fixMenu=h.scrollTop()>b})}),a.$watch("flow.fixMenu",function(){if(a.flow.fixMenu){var b=$(".form").width();$(".form-alert").width(b)}})}}}]),angular.module("dateaWebApp").controller("CampaignEditCtrl",["$scope","$routeParams","shareMetaData",function(a,b,c){a.campaignId=b.campaignId,a.flow={},a.flow.dashboardMode="edit",c.setData({title:"Datea | editar iniciativa"})}]),angular.module("dateaWebApp").directive("ngEnter",function(){return function(a,b,c){b.bind("keydown keypress",function(b){13===b.which&&(a.$apply(function(){a.$eval(c.ngEnter)}),b.preventDefault())})}}),angular.module("dateaWebApp").directive("daDateoDetailInline",["$rootScope","$modal","User","Api","config",function(a,b,c,d,e){return{restrict:"E",templateUrl:"/views/dateo-detail-inline.html",scope:{dateo:"=",markerIndex:"=?",mapPresent:"@",campaignId:"=",mainTag:"=?"},controller:["$scope","$element","$attrs",function(f,g,h){var i,j;f.createdFormat=e.defaultDateFormat,f.dateFormat=e.dateFieldFormat,f.dateo={},f.comment={},f.flow={},f.flow.mapPresent=h.mapPresent?f.$eval(h.mapPresent):!0,f.flow.isUserSignedIn=c.isSignedIn(),f.flow.showEditBtn=!1,f.$watch("dateo.id",function(){if(f.dateo&&f.dateo.id&&(f.flow.showEditBtn=c.data.id===f.dateo.user.id,f.flow.shareableUrl=e.app.url+"/"+f.dateo.user.username+"/dateos/"+f.dateo.id,j(),f.dateo.comments=[],i(),f.mainTag&&f.dateo.tags[0]!=f.mainTag)){var a=f.dateo.tags.indexOf(f.mainTag);f.dateo.tags.splice(a,1),f.dateo.tags.unshift(f.mainTag)}}),h.$observe("markerIndex",function(a){f.markerIndex=a}),f.focusDateo=function(){a.$broadcast("focus-dateo",{id:f.dateo.id})},f.closeDetail=function(){a.$broadcast("close-dateo-detail")},i=function(){var a=f.dateo.comments.map(function(a){return a.id});d.comment.getList({content_type__model:"dateo",object_id:f.dateo.id}).then(function(b){f.dateo.comment_count=b.meta.total_count,f.dateo.comments=b.objects.map(function(b){return b.new=-1===a.indexOf(b.id),b}),f.comment.loading=!1,f.comment.comment=null},function(a){console.log(a)})},j=function(){var a;f.campaignId&&f.dateo.admin&&f.dateo.admin[f.campaignId]&&(a=f.dateo.admin[f.campaignId].status,"new"!=a&&(f.flow.status={msg:"reviewed"==a?"atendido":"solucionado",type:a}))},f.flow.imgDetail=function(a){var c;c={templateUrl:"views/dateo-detail-img.html",controller:"DateoimgCtrl",resolve:{img:function(){return a}}},b.open(c)},f.flow.postComment=function(){var b={};f.comment.comment.trim()&&!f.comment.loading&&(f.comment.loading=!0,b.comment=f.comment.comment,b.object_id=f.dateo.id,b.content_type="dateo",d.comment.postCommentByDateoId(b).then(function(){a.$broadcast("user:doFollow",{followKey:"dateo."+f.dateo.id}),i()}))},f.slideDownNewComment=function(){$(".slidedown").slideDown("normal",function(){$(this).removeClass("slidedown")})},f.flow.share=function(){var a=f.dateo.images.length?e.api.imgUrl+f.dateo.images[0].image:e.app.url+"/static/images/logo-large.png";b.open({templateUrl:"views/share.html",controller:"ShareCtrl",resolve:{shareModalGivens:function(){return{url:f.flow.shareableUrl,title:"Datea | "+f.dateo.user.username+" dateó en #"+f.dateo.tags.slice(0,2).join(", #"),description:f.dateo.extract,image:a}}}})},f.flow.denounce=function(a,b){d.flag.doFlag({content_type:a,object_id:+$routeParams.dateoId}).then(function(){$(b.target).hide()},function(a){console.log(a)})},f.flow.focusCommentForm=function(){angular.element("#comment-input").focus()},f.flow.imgDetail=function(a){var c;c={templateUrl:"views/dateo-detail-img.html",controller:"DateoimgCtrl",resolve:{img:function(){return a}}},b.open(c)},f.flow.editDateo=function(){modalInstance=b.open({templateUrl:"views/datear.html",controller:"DatearCtrl",windowClass:"datear-modal",backdrop:"static",resolve:{datearModalGivens:function(){return{dateo:f.dateo}}}})}}]}}]),angular.module("dateaWebApp").directive("daVote",["Api","User","$location","localStorageService",function(a,b,c,d){return{restrict:"E",templateUrl:"/views/vote-button.html",replace:!0,scope:{btnClass:"@",voteObj:"=",voteObjType:"@",voteCallback:"=?"},controller:["$scope","$element","$attrs",function(e){var f,g,h,i=d;e.vote={},e.flow={},e.flow.isActive=!1,e.flow.loading=!1,e.flow.disabled=!0,e.flow.hoverEnabled=!1,e.$watch("voteObj.id",function(){e.voteObj&&e.voteObj.id&&(b.data.id===e.voteObj.user.id?(e.hoverEnabled=!0,e.disabled=!0):f())}),f=function(){b.isSignedIn()?a.vote.getVotes({user:b.data.id,vote_key:e.voteObjType+"."+e.voteObj.id}).then(function(a){e.flow.disabled=!1,e.flow.isActive=a.meta.total_count?!0:!1,e.flow.hoverEnabled=!0,a.objects.length&&(e.flow.vote=a.objects[0])},function(a){console.log(a),e.flow.disabled=!1,e.flow.hoverEnabled=!0}):(e.flow.disabled=!1,e.flow.hoverEnabled=!0)},e.flow.doVote=function(){return b.isSignedIn()?void(e.flow.loading||e.flow.disabled||(e.flow.loading=!0,e.flow.hoverEnabled=!1,g=!1,e.flow.isActive?a.vote.deleteVote({vote_key:e.voteObjType+"."+e.voteObj.id,id:e.flow.vote.id}).then(function(a){console.log("delete Vote",a),"undefined"!=typeof e.voteObj.vote_count&&e.voteObj.vote_count--,"undefined"!=typeof e.voteCallback&&e.voteCallback(a,"delete"),e.flow.loading=!1,e.flow.isActive=!1,e.flow.vote=null,g||(e.flow.hoverEnabled=!1)},function(a){console.log(a),e.flow.loading=!1,e.flow.hoverEnabled=!0}):a.vote.doVote({vote_key:e.voteObjType+"."+e.voteObj.id}).then(function(a){console.log("vote",a),"undefined"!=typeof e.voteObj.vote_count&&e.voteObj.vote_count++,"undefined"!=typeof e.voteCallback&&e.voteCallback(a,"post"),e.flow.loading=!1,e.flow.isActive=!0,e.flow.vote=a,g||(e.flow.hoverEnabled=!1)},function(a){console.log(a),e.flow.loading=!1,e.flow.hoverEnabled=!0}))):(h=c.path(),i.set("nextURL",{path:h,count:0}),void c.path("/registrate"))},e.flow.onMouseLeave=function(){g=!0,e.flow.hoverEnabled=!0}}]}}]),angular.module("dateaWebApp").controller("CampaignListCtrl",["$scope","Api","config","shareMetaData",function(a,b,c,d){var e,f,g;a.query={page:1,numResults:18,totalCount:0,orderBy:"-featured,-created",category:"all"},a.flow={},a.flow.orderByOptions=[{val:"-featured,-created",label:"destacados"},{val:"-created",label:"recientes"},{val:"-dateo_count,-created",label:"más dateadas"}],a.dateFormat=c.defaultDateFormat,g={title:"Datea | Iniciativas",description:"Busca iniciativas dateras sobre temas que te importan."},d.setData(g),e=function(){b.category.getCategories({}).then(function(b){a.flow.categories=b.objects,a.flow.categories.unshift({id:"all",name:"-- todas --"})})},a.flow.doQuery=function(){var c={};a.flow.campaigns=[],a.flow.loading=!0,c.limit=a.query.numResults,c.offset=(a.query.page-1)*c.limit,c.order_by=a.query.orderBy,a.query.search&&""!==a.query.search.trim()&&(c.q=a.query.search),a.query.category&&"all"!==a.query.category&&(c.category_id=a.query.category),b.campaign.getCampaigns(c).then(function(b){a.flow.campaigns=b.objects,a.query.totalCount=b.meta.total_count,f(b),a.flow.loading=!1},function(a){console.log(a)})},a.$watch("query.page",function(){a.flow.doQuery()}),f=function(b){a.query.totalCount=b.meta.total_count,a.query.numResults=18},e(),a.flow.doQuery()}]),angular.module("dateaWebApp").directive("daDateoOutstanding",function(){return{restrict:"E",templateUrl:"views/dateo-outstanding.html"}}),angular.module("dateaWebApp").controller("DateosAdminCtrl",["$scope","Api","config","User","$routeParams","$document","$location","shareMetaData",function(a,b,c,d,e,f,g,h){var i,j,k,l,m,n,o,p,q,r=60,s=0;a.flow={},a.flow.dashboardMode="admin",a.flow.loading=!1,a.flow.showDetail=!1,a.flow.leaflet=c.defaultMap,a.dateFormat=c.shortDateFormat,a.campaignId=e.campaignId,a.campaign={},m="/api/v2/campaign/"+a.campaignId,a.query={page:g.search().page||1,itemsPerPage:30,totalCount:0,orderBy:"-created",status:"all",tag:"all",statusOptions:{all:"-- todos --","new":"nuevo",reviewed:"atendido",solved:"solucionado"}},h.setData({title:"Datea | administrador de dateos"}),i=function(){a.flow.loading=!0,b.campaign.getCampaigns({id:a.campaignId}).then(function(b){if(b.objects.length){if(a.campaign=b.objects[0],d.data.id!=a.campaign.user.id)return void g.path("/");a.query.tags=a.campaign.main_tag.tag,k(),a.flow.getDateos()}else g.path("/404").replace()},function(a){console.log(a),404===a.status&&g.path("/404").replace()})},k=function(){a.query.tagFilterOptions=[{value:"all",label:"-- todas --"}],angular.forEach(a.campaign.secondary_tags,function(b){a.query.tagFilterOptions.push({value:b.tag,label:"#"+b.tag})})},j=function(){var b=[a.campaign.main_tag.tag],c={};return a.query.tag&&"all"!==a.query.tag&&b.push(a.query.tag),c.tags=b.join(","),b.length>0&&(c.tag_operator="and"),c.order_by=a.query.orderBy,c.limit=a.query.itemsPerPage,c.offset=(a.query.page-1)*c.limit,a.query.since&&(c.created__gt=a.query.since.toISOString()),a.query.until&&(c.created__lt=a.query.until.toISOString()),a.query.search&&""!==a.query.search.trim()&&(c.q=a.query.search),a.query.status&&"all"!==a.query.status&&("new"===a.query.status?c.new_in_campaign_id=a.campaignId:c.admin=a.query.status+":"+a.campaignId),c},a.flow.getDateos=function(){var c=j();a.campaign.dateos=[],a.flow.showDetail=!1,a.flow.dateo=null,a.flow.loading=!0,b.dateo.getDateos(c).then(function(b){a.campaign.dateos=b.objects.map(function(a){return q(a)}),a.query.totalCount=b.meta.total_count,g.search().item&&p(g.search().item),a.flow.loading=!1},function(b){console.log(b),a.flow.loading=!1})},a.flow.openDateo=function(b){g.search("item",a.campaign.dateos[b].id)},a.$on("$routeUpdate",function(){var b=parseInt(g.search().item);b&&!a.flow.loading?p(b):b||a.flow.closeDateo()}),a.flow.closeDateo=function(){a.flow.dateoShown=null,a.flow.showDetail=!1,g.search("item",null),f.scrollTop(s)},o=function(b){var c;a.flow.showDetail=!0,n=b,c=a.campaign.dateos[b],a.flow.dateoStatus=c.admin&&c.admin[a.campaignId]?c.admin[a.campaignId].status:"new",s=f.scrollTop(),setTimeout(function(){a.$apply(function(){a.flow.dateo=c})}),a.flow.leaflet.center=null,a.flow.leaflet.markers=null,g.search("item",c.id),c.position&&c.position.coordinates&&(a.flow.leaflet.center={lat:c.position.coordinates[1],lng:c.position.coordinates[0],zoom:16},a.flow.leaflet.markers={staticy:{lat:c.position.coordinates[1],lng:c.position.coordinates[0],draggable:!1}})},p=function(b){for(var c in a.campaign.dateos)if(a.campaign.dateos[c].id==b){o(c);break}},a.flow.setDateoStatus=function(){var c,d={};a.flow.statusLoading=!0,a.flow.dateo.admin&&a.flow.dateo.admin[a.campaignId]?(c=a.flow.dateo.admin[a.campaignId],"new"===a.flow.dateoStatus?b.dateoStatus.deleteList({id:c.id}).then(function(){l(a.flow.dateo),a.flow.statusLoading=!1},function(a){console.log(a)}):(d={id:a.flow.dateo.admin[a.campaignId].id,status:a.flow.dateoStatus},b.dateoStatus.patchList({objects:[d]}).then(function(){l(a.flow.dateo),a.flow.statusLoading=!1},function(b){console.log(b),a.flow.statusLoading=!1}))):"new"!==a.flow.dateoStatus&&(d={campaign:a.campaignId,dateo:a.flow.dateo.id,status:a.flow.dateoStatus},b.dateoStatus.post(d).then(function(){l(a.flow.dateo),a.flow.statusLoading=!1},function(b){console.log(b),a.flow.statusLoading=!1}))},l=function(c){b.dateo.getDateos({id:c.id}).then(function(b){var c;c=q(b.objects[0]),a.campaign.dateos[n]=c,a.flow.dateo=c},function(a){console.log(a)})},q=function(b){return b.admin&&b.admin[a.campaign.id]&&(b.status=b.admin[a.campaign.id].status),b},a.$watch("query.page",function(){a.campaign.id&&a.flow.getDateos()}),f.on("scroll",function(){a.$apply(function(){a.flow.fixMenu=f.scrollTop()>r})}),i()}]),angular.module("dateaWebApp").directive("daRedateo",["Api","User","$location","localStorageService",function(a,b,c,d){return{restrict:"E",templateUrl:"/views/redateo-button.html",replace:!0,scope:{btnClass:"@",dateo:"=",redateoCallback:"=?"},controller:["$scope","$element","$attrs",function(e){var f,g,h,i=d;e.redateo={},e.flow={},e.flow.isActive=!1,e.flow.loading=!1,e.flow.disabled=!0,e.flow.hoverEnabled=!1,e.$watch("dateo.id",function(){e.dateo&&e.dateo.id&&(b.data.id===e.dateo.user.id?(e.flow.hoverEnabled=!0,e.flow.disabled=!0):f())}),f=function(){b.isSignedIn()?a.redateo.getList({user:b.data.id,dateo:e.dateo.id}).then(function(a){e.flow.disabled=!1,e.flow.isActive=a.meta.total_count?!0:!1,e.flow.hoverEnabled=!0,a.objects.length&&(e.flow.redateo=a.objects[0])},function(a){console.log(a),e.flow.disabled=!1,e.flow.hoverEnabled=!0}):(e.flow.disabled=!1,e.flow.hoverEnabled=!0)},e.flow.doRedateo=function(){return b.isSignedIn()?void(e.flow.loading||e.flow.disabled||(e.flow.loading=!0,e.flow.hoverEnabled=!1,g=!1,e.flow.isActive?a.redateo.deleteList({user:b.data.id,dateo:e.dateo.id,id:e.flow.redateo.id}).then(function(a){e.dateo.redateo_count--,"undefined"!=typeof e.redateoCallback&&e.redateoCallback(a,"delete"),e.flow.loading=!1,e.flow.isActive=!1,e.flow.redateo=null,g||(e.flow.hoverEnabled=!1)},function(a){console.log(a),e.flow.loading=!1,e.flow.hoverEnabled=!0}):a.redateo.post({user:b.data.id,dateo:e.dateo.id}).then(function(a){e.dateo.redateo_count++,"undefined"!=typeof e.redateoCallback&&e.redateoCallback(a,"post"),e.flow.loading=!1,e.flow.isActive=!0,e.flow.redateo=a,g||(e.flow.hoverEnabled=!1)},function(a){console.log(a),e.flow.loading=!1,e.flow.hoverEnabled=!0}))):(h=c.path(),i.set("nextURL",{path:h,count:0}),void c.path("/registrate"))},e.flow.onMouseLeave=function(){g=!0,e.flow.hoverEnabled=!0}}]}}]),angular.module("dateaWebApp").factory("geoJSONStyle",function(){return{style:function(a){var b=a.properties;return b.stroke&&"#"===b.stroke.charAt(0)&&(b.color=b.stroke,b.stroke=!0),b["stroke-opacity"]&&(b.opacity=b["stroke-opacity"]),b["stroke-width"]&&(b.weight=b["stroke-width"]),b.fill&&(b.fillColor=b.fill),b["fill-opacity"]&&(b.fillOpacity=b["fill-opacity"]),b},pointToLayer:function(a,b){var c,d;if(a.properties["marker-size"]&&a.properties["marker-color"]){var e={small:[20,50],medium:[30,70],large:[35,90]},f=a.properties||{},g=f["marker-size"]||"medium",h=f["marker-symbol"]?"-"+f["marker-symbol"]:"",i=f["marker-color"]||"7e7e7e";i=i.replace("#","");var j="http://a.tiles.mapbox.com/v3/marker/pin-"+g.charAt(0)+h+"+"+i+(2===window.devicePixelRatio?"@2x":"")+".png";c=L.marker(b,{icon:new L.icon({iconUrl:j,iconSize:e[g],iconAnchor:[e[g][0]/2,e[g][1]/2],popupAnchor:[e[g][0]/2,0]})})}else c=L.marker(b);return(a.properties.title||a.properties.name)&&(d=a.properties.title||a.properties.name,c.bindLabel(d)),c},onEachFeature:function(a,b){var c;(a.properties.description||a.properties.popupContent)&&(c=a.properties.description||a.properties.popupContent,b.bindPopup(c))}}}),angular.module("dateaWebApp").controller("ChangePasswordCtrl",["$scope","Api","User","$location","config","$routeParams","shareMetaData",function(a,b,c,d,e,f,g){a.flow={},a.auth={},a.alerts=[],a.flow.loading=!1,a.flow.validInput={},a.flow.validInput.password=null,a.flow.validInput.samePassword=null,a.flow.changeSuccess=null,g.setData({title:"Datea | cambio de contraseña"}),a.flow.checkPassword=function(){a.auth.password&&(a.flow.validInput.password=/^(?=.*\d)(?=.*[a-z])(?!.*\s).{6,32}$/.test(a.auth.password),a.auth.message=null)},a.flow.checkSamePassword=function(){a.auth.samePassword&&(a.flow.validInput.samePassword=a.auth.samePassword===a.auth.password,a.auth.message=null)},a.flow.savePasswd=function(){var c;if(c=a.form.$valid){a.flow.loading=!0;var d={uid:f.uid,token:f.token,password:a.auth.password};b.account.changePassword(d).then(function(){a.flow.changeSuccess=!0,a.flow.loading=!1},function(){a.flow.changeSuccess=!1,a.flow.loading=!1})}}}]),angular.module("dateaWebApp").directive("daLoading",function(){return{restrict:"A",scope:{daLoading:"="},link:function(a,b){a.$watch("daLoading",function(){a.daLoading?b.addClass("datea-loading"):b.removeClass("datea-loading")}),b.append('<div class="datea-loading-icon"><i class="icon-loading fa-spin"></i></div>')}}}),angular.module("dateaWebApp").factory("shareMetaData",["config","$location",function(a,b){var c={title:"Datea - Todos somos dateros",description:"Comparte y visualiza datos útiles con tu comunidad.",imageUrl:a.app.url+"/static/images/logo-large.png",url:a.app.url};return{data:angular.copy(c),init:!0,resetToDefault:function(){this.data=angular.copy(c),this.init=!1},setData:function(d){this.data.title=d.title||c.title,this.data.description=d.description||c.description,this.data.imageUrl=d.imageUrl?-1!==d.imageUrl.indexOf("http")?d.imageUrl:a.api.imgUrl+d.imageUrl:c.image_url,this.data.url=d.url?-1!==d.url.indexOf("http")?d.url:a.app.url+d.url:a.app.url+b.path(),this.init=!1}}}]),angular.module("dateaWebApp").controller("HeadCtrl",["$scope","shareMetaData","$timeout","$rootScope",function(a,b){a.share=b.data}]),angular.module("dateaWebApp").service("ActivityTitle",["config","User","$interpolate",function(a,b,c){var d,e;return e=function(a){var b,c,d;switch(a.verb){case"dateo":c=a.action_object.tags.filter(function(a){return a.campaigns.length>0}).map(function(a){return"#"+a.tag}),b=a.action_object.tags.map(function(a){return"#"+a.tag});break;case"commented":a.target_object&&a.target_object.tags&&(c=a.target_object.tags.filter(function(a){return a.campaigns.length>0}).map(function(a){return"#"+a.tag}),b=a.target_object.tags.map(function(a){return"#"+a.tag}));break;case"voted":a.target_object&&a.target_object.tags&&(c=a.target_object.tags.filter(function(a){return a.campaigns.length>0}).map(function(a){return"#"+a.tag}),b=a.target_object.tags.map(function(a){return"#"+a.tag}));break;case"redateo":c=a.target_object.tags.filter(function(a){return a.campaigns.length>0}).map(function(a){return"#"+a.tag}),b=a.target_object.tags.map(function(a){return"#"+a.tag});break;case"campaign":c=["#"+a.action_object.main_tag.tag],b=[]}return c&&c.length>0?(d=c.slice(0,2).join(", "),d=c.length>2?d+"...":d,"en "+d):b&&b.length>0?(d=b.slice(0,2).join(", "),d=b.length>2?d+"...":d,"en "+d):""},d=function(d){var f,g,h;return b.isSignedIn()&&(d.actor.id===b.data.id?h="byUser":d.target_user&&d.target_user.id===b.data.id&&(h="onUser")),h||(h="anyUser"),f=c(a.activityLog.activityContentMsg[h][d.verb])(d),g=e(d),f+g},{createTitle:d}}]),angular.module("dateaWebApp").directive("daFlag",["Api","User","$location","localStorageService","$modal",function(a,b,c,d,e){return{restrict:"E",templateUrl:"/views/flag-button.html",replace:!0,scope:{flagId:"=",flagObjType:"@"},controller:["$scope","$element","$attrs",function(a,f,g){var h,i,j,k,l;k=d,a.flow={},a.flow.flagLabel="denunciar",a.flow.isFlagged=!1,a.$watch("flagId",function(){a.flagId&&(h=a.flagId),a.flow.flagLabel="denunciar",a.flow.isFlagged=!1}),g.$observe("flagObjType",function(){g.flagObjType&&(i=g.flagObjType)}),a.flow.openModal=function(){a.flow.isFlagged||(b.isSignedIn()?(l={flagObjType:i,flagId:h},e.open({templateUrl:"views/flag-form.html",controller:"FlagFormCtrl",windowClass:"flag-modal",resolve:{flagModalGivens:function(){return l}}}).result.then(function(){a.flow.isFlagged=!0,a.flow.flagLabel="denunciado!"})):(j=c.path(),k.set("nextURL",{path:j,count:0}),c.path("/registrate")))}}]}}]),angular.module("dateaWebApp").directive("daJcarousel",[function(){return{restrict:"A",link:function(a,b){var c,d,e=4;a.carousel={},d=b.find(".jcarousel"),d.jcarousel({wrap:"both"}),a.carousel.goToNext=function(){d.jcarousel("scroll","+="+e,!0)},a.carousel.goToPrev=function(){d.jcarousel("scroll","-="+e,!0)},a.carousel.onLastCarouselItem=function(){a.resizeCarousel()},$(window).resize(a.resizeCarousel),c=function(){var a=b.width(),c=b.find(".carousel-container");a>=750?(c.css("width","300%"),e=4):a>=600&&750>a?(c.css("width","400%"),e=3):a>=480&&600>a?(c.css("width","600%"),e=2):(c.css("width","600%"),e=2)},a.resizeCarousel=function(){var a,e,f=0,g=b.find(".carousel-item");a=g.size(),c(),g.each(function(){$(this).removeAttr("style"),f+=$(this).outerWidth()}),e=parseInt(f/a),g.each(function(){$(this).css("width",e+"px")}),d.jcarousel("reload")}},controller:["$scope","$element","$attrs",function(a){a.$on("destroy",function(){$(window).off(a.resizeCarousel)})}]}}]),angular.module("dateaWebApp").controller("RedirectToCampaignCtrl",["$scope","$routeParams","Api","config","$location",function(a,b,c,d,e){b.campaignId&&c.campaign.getCampaigns({id:b.campaignId}).then(function(a){var b;a.objects.length?(b=a.objects[0],e.path("/"+b.user.username+"/"+b.slug).replace()):e.path("/404").replace()},function(a){404===a.status&&e.path("/404").replace()})}]),angular.module("dateaWebApp").controller("RedirectToDateoCtrl",["$scope","$routeParams","Api","config","$location",function(a,b,c,d,e){b.dateoId&&c.dateo.getDateos({id:b.dateoId}).then(function(a){var b;a.objects.length?(b=a.objects[0],e.path("/"+b.user.username+"/dateos/"+b.id).replace()):e.path("/404").replace()},function(a){404===a.status&&e.path("/404").replace()})}]),angular.module("dateaWebApp").service("Datear",["config","$modal",function(a,b){var c={};return{open:function(a){a&&(c=$.isEmptyObject(a)?{}:a),b.open({templateUrl:"views/datear.html",controller:"DatearCtrl",windowClass:"datear-modal",backdrop:"static",resolve:{datearModalGivens:function(){return c}}})},setContext:function(a){c=a},resetContext:function(){c={}}}}]),angular.module("dateaWebApp").directive("datearBtn",["Datear","User","$location","localStorageService",function(a,b,c,d){return{restrict:"E",templateUrl:"/views/datear-button.html",replace:!0,controller:["$scope","$element","$attrs",function(e,f,g){e.btnLabel=void 0!==g.btnText?g.btnText:"datear ",e.btnClass=void 0!==g.btnClass?g.btnClass:"",e.datear=function(){b.isSignedIn()?a.open():(d.set("nextURL",{path:c.path(),count:0}),c.path("/registrate"))}}]}}]),angular.module("dateaWebApp").controller("MainBckpCtrl",["$scope","User","$http","$location","$rootScope","config","localStorageService","geolocation","Api","$modal","$interpolate","leafletData","$q","Fullscreen","ActivityTitle","ActivityUrl","$filter","$timeout","State","leafletBoundsHelpers","leafletMarkersHelpers","$log","Piecluster","$compile","shareMetaData",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y){var z,A,B,C,D,E,F,G,H,I,J,K,M,N,O,P,Q,R,S,T,U,V,W,X,Y,Z,$,_,ab,bb,cb,db,eb,fb=g,gb={},hb=0,ib={},jb=!1;a.flow={},a.query={},a.pagination={},a.query.orderBy="-created",a.query.orderByLabel="últimos",a.query.followFilter="all",a.query.followFilterLabel="todos",a.dateFormat=f.defaultDateFormat,bb=function(){a.homeSI={},a.homeSI.leaflet={},a.homeSI.history=[],a.homeSI.selectedMarker="last",a.homeSI.loading={},a.homeSI.loading.leaflet=!0,a.homeSI.loading.campaigns=!0,a.homeSI.hasLegend=!1,a.homeSI.userTagsArray=[],a.homeSI.activeTab="dateos",a.homeSI.activeDateoView="map",a.homeSI.dateosListView={limit:20},a.homeSI.campaignsFollowed=[],a.homeSI.leaflet=angular.copy(f.defaultMap),a.homeSI.leaflet.events={enable:["leafletDirectiveMarker.click"]}},bb(),y.resetToDefault(),V=function(){i.tag.getTags({followed:b.data.id}).then(function(c){a.homeSI.userTags={},a.homeSI.followingTags=c.objects.map(function(b,c){return b.color=a.homeSI.colorRange[c],a.homeSI.userTags[b.tag]=b,b}),b.data.tags_followed=c.objects},function(a){console.log(a)})},W=function(){a.homeSI.trendingTags=[],i.tag.getTrendingTags({limit:5,days:40}).then(function(b){angular.forEach(b.objects,function(b){J({id:b.id,tags:a.homeSI.followingTags})&&(b._followable=!0),a.homeSI.trendingTags.push(b)})})},J=function(a){var b,c;return b=a&&a.id,c=a&&a.tags,~c.map(function(a){return a.id}).indexOf(b)?!1:!0},X=function(){i.dateo.getDateos({limit:1}).then(function(b){a.homeSI.weeklyDateo=b.objects[0]},function(a){console.log(a)})},U=function(){i.activityLog.getActivityOfUserByUserId({user:b.data.id,mode:"all"}).then(function(b){angular.forEach(b.objects,function(b){b._url=p.parse(b),b._message=o.createTitle(b),a.homeSI.history.push(b)})})},R=function(b){var c,d,e;c=b&&b.index*f.homeSI.campaignsOffset,e={order_by:"-featured,-created",limit:f.homeSI.campaignsOffset,offset:c||0},d=b&&b.query||e,i.campaign.getCampaigns(d).then(function(b){a.homeSI.campaigns=b.objects,a.homeSI.loading.campaigns=!1},function(a){console.log(a)})},S=function(){var c;0!==b.data.tags_followed.length&&(c={order_by:"-created",limit:100,main_tag:b.data.tags_followed.map(function(a){return a.tag}).join(",")},a.homeSI.loading.campaignsFollowed=!0,i.campaign.getCampaigns(c).then(function(b){a.homeSI.campaignsFollowed=b.objects,a.homeSI.loading.campaignsFollowed=!1},function(a){console.log(a)}))},a.$watch("pagination.currentPage",function(){b.isSignedIn()&&(R({index:a.pagination.currentPage-1}),a.homeSI.loading.campaigns=!0)}),T=function(b){a.pagination.totalItems=b.meta.total_count,a.pagination.itemsPerPage=f.homeSI.paginationLimit},E=function(a){return[[a.lat+f.defaultBoundsRatio,a.lng+f.defaultBoundsRatio],[a.lat-f.defaultBoundsRatio,a.lng-f.defaultBoundsRatio]]},P=function(c){var d,e,g=c&&c.dateosGivens||{},h={};d=t.createBoundsFromArray(E({lat:c&&c.center&&c.center.coords.latitude||b.data.ip_location.latitude||f.defaultMap.center.lat,lng:c&&c.center&&c.center.coords.longitude||b.data.ip_location.longitude||f.defaultMap.center.lng})),a.query.search||(h.bounds=d),C=!1,e=0,a.homeSI.leaflet.center.zoom>15&&(e=1500,a.homeSI.leaflet.center.zoom=15),r(function(){l.getMap("leafletHomeSI").then(function(b){B=b.getBounds(),g.bottom_left_latitude=B._southWest.lat,g.bottom_left_longitude=B._southWest.lng,g.top_right_latitude=B._northEast.lat,g.top_right_longitude=B._northEast.lng,Q(g),angular.extend(a.homeSI.leaflet,h)})},e)};var kb=!1;a.$on("leafletDirectiveMap.moveend",function(){kb?setTimeout(function(){kb=!1},100):I()}),a.$on("leafletDirectiveMap.autopanstart",function(){kb=!0}),I=function(){!C&&jb&&(a.homeSI.loading.leafletMore=!0,l.getMap("leafletHomeSI").then(function(a){var b;b=a.getBounds(),Q({bottom_left_latitude:b._southWest.lat,bottom_left_longitude:b._southWest.lng,top_right_latitude:b._northEast.lat,top_right_longitude:b._northEast.lng})}))},H=function(a){var b,c=a&&a.marker;return angular.forEach(gb,function(a){a._id===c.id&&(b=!0)}),b?!0:!1},Q=function(c){var d,e={},g={},c=c||{},h=[];d=c.updateCenter,delete c.updateCenter,c.limit=f.homeSI.dateosLimitByRequest,"-created"!==a.query.orderBy&&(c.order_by=a.query.orderBy,C=!1,c.updateCenter=!0),a.query.search&&""!=a.query.search&&(c.q=a.query.search,C=!1,c.updateCenter=!0),"follow"===a.query.followFilter&&b.data.tags_followed.length>0&&(h=b.data.tags_followed.map(function(a){return a.tag}),c.tags=h.join(",")),i.dateo.getDateos(c).then(function(b){b.objects.length?(a.flow.notResults=null,angular.forEach(b.objects,function(b){var d,e=[],f=b.tags&&b.tags.map(function(a){return a.tag})||[];b.position&&!H({marker:b})&&(g["marker"+hb]={lat:b.position.coordinates[1],lng:b.position.coordinates[0],draggable:!1,focus:!1,_id:b.id,_tags:f,_dateo:b,icon:Y(b),riseOnHover:!0,group:"dateaCluster"},a.homeSI.leaflet.focusOnId&&a.homeSI.leaflet.focusOnId==b.id&&(g["marker"+hb].focus=!0),f.length>0&&("follow"===a.query.followFilter&&c.tags?(e=f.filter(function(b){return"undefined"!=typeof a.homeSI.userTags[b]}),g["marker"+hb].label={message:"#"+e.join(", #")}):(d={message:"#"+f.slice(0,2).join(", #")},g["marker"+hb].label.message=f.length>2?d+"...":d)),hb+=1)}),angular.extend(gb,g),e.markers=gb,a.homeSI.markers=Object.keys(gb),angular.extend(a.homeSI.leaflet,e),a.homeSI.loading.leaflet=!1,a.homeSI.loading.leafletMore=!1):(a.flow.notResults="0 resultados",a.homeSI.loading.leaflet=!1,a.homeSI.loading.leafletMore=!1)},function(a){console.log(a)})},_=function(b,d){c.get("views/dateo-map-popup.html").success(function(c){var e,g,h;e=a.$new(!0),e.dateo=b,e.dateFormat=f.defaultDateFormat,e.tags=b.tags.slice(0,2),g=x(angular.element(c)),h=g(e),d||(d=L.latLng([b.position.coordinates[1],b.position.coordinates[0]])),l.getMap("leafletHomeSI").then(function(a){L.popup({offset:L.point(0,-32)}).setLatLng(d).setContent(h[0]).openOn(a)})})},F=function(){h.getLocation({timeout:3e3}).then(function(a){z=a,P({center:a}),jb=!0},function(){i.ipLocation.getLocationByIP().then(function(a){var b={};b.coords={},b.coords.latitude=a.ip_location.latitude,b.coords.longitude=a.ip_location.longitude,z=b,P({center:b}),jb=!0})})},K=function(){a.homeSI.leaflet.markers={},gb={},hb=0},M=function(){var c,e;
return jb=!1,e=fb.get("nextURL"),e&&0===e.count?void r(function(){e.count=e.count+1,fb.set("nextURL",e),d.path(e.path)}):(s.isLanding=!1,a.flow.isSignedIn=!1,a.user=b.data,b.data.tags_followed.length&&(a.query.followFilter="follow",a.query.followFilterLabel="lo que sigo"),a.homeSI.colorRange=b.data.tags_followed.length<=10?d3.scale.category10().range():d3.scale.category20().range(),a.homeSI.userTags={},a.homeSI.followingTags=b.data.tags_followed.map(function(b,c){return b.color=a.homeSI.colorRange[c],a.homeSI.userTags[b.tag]=b,b}),c=angular.copy(f.defaultMap),f.defaultMap=c,c.center.zoom=f.homeSI.mapZoomOverride,c.bounds=t.createBoundsFromArray([[-12.0735,-77.0336],[-12.0829,-77.0467]]),a.homeSI.leaflet||(a.homeSI.leaflet={}),angular.extend(a.homeSI.leaflet,c),F(),R(),U(),W(),V(),a.$watch("query.orderBy",function(){a.homeSI.onFilterChange()}),a.$watch("query.followFilter",function(){a.homeSI.onFilterChange()}),void 0)},N=function(){M()},O=function(){s.isLanding=!0,a.flow.isSignedIn=!0},a.homeSI.leaflet.checkInvalidSize=function(){l.getMap("lealfetHomeSI").then(function(a){a.invalidateSize()})},a.homeSI.openDateoView=function(b){if(b!=a.homeSI.activeDateoView)switch(a.homeSI.activeDateoView=b,b){case"map":a.homeSI.geolocate(),a.homeSI.leaflet.checkInvalidSize();break;case"list":a.homeSI.buildDateosListView()}},a.homeSI.buildDateosListView=function(){var c,d={};d.order_by=a.query.orderBy,d.limit=a.homeSI.dateosListView.limit,d.page=a.query.page,a.query.search&&""!=a.query.search.trim()&&(d.q=a.query.search),"follow"===a.query.followFilter&&(d.tags=b.data.tags_followed.map(function(a){return a.tag}).join(",")),c=JSON.stringify(d),ib.list&&ib.list==c||(ib.list=c,a.homeSI.loading.dateosListView=!0,i.dateo.getDateos(d).then(function(b){a.homeSI.dateosListView.dateos=b.objects,a.homeSI.dateosListView.totalCount=b.meta.total_count,a.homeSI.loading.dateosListView=!1},function(a){console.log(a)}))},a.homeSI.geolocate=function(){a.homeSI.loading.leaflet=!0,K(),a.query.orderBy="-created",a.query.search="",C=!1,F({dateosGivens:{updateCenter:!0}})},a.flow.isSignedIn=!b.isSignedIn(),a.flow.signIn=function(){d.path("/signin")},a.flow.signUp=function(){d.path("/registrate")},a.$on("user:hasDateado",function(b,c){var d,e,g;c.created&&(g=c.dateo,l.getMap("leafletHomeSI").then(function(b){var c;if(a.query.orderBy="-created","follow"===a.query.followFilter){d=!1;for(var h in g.tags)if(a.homeSI.userTags[g.tags[h].tag]){d=!0;break}d||(a.query.followFilter="all")}a.homeSI.leaflet.focusOnId=g.id,e=L.latLng(g.position.coordinates[1],g.position.coordinates[0]),C=!0,b.setView(e,f.homeSI.zoomAfterDatear,{reset:!0}),c=b.getBounds(),Q({bottom_left_latitude:c._southWest.lat,bottom_left_longitude:c._southWest.lng,top_right_latitude:c._northEast.lat,top_right_longitude:c._northEast.lng}),C=!1,"list"==a.homeSI.activeDateoView&&buildDateosListView()}))}),a.flow.share=function(){j.open({templateUrl:"views/share.html",controller:"ShareCtrl",resolve:{shareModalGivens:function(){return{}}}})},a.homeSI.searchDateos=function(){"map"===a.homeSI.activeDateoView?(a.homeSI.loading.leaflet=!0,K(),P()):"list"===a.homeSI.activeDateoView&&(a.query.page=0,a.homeSI.buildDateosListView())},a.homeSI.searchDateosWithImages=function(){var b={};a.homeSI.loading.leaflet=!0,K(),a.query.search&&(b.q=a.query.search),b.has_images=1,P({dateosGivens:b})},a.homeSI.autocompleteSearch=function(a){return i.tag.getAutocompleteByKeyword({q:a.replace("#","")}).then(function(a){var b=[];return angular.forEach(a.suggestions,function(a){b.push("#"+a)}),b})},a.homeSI.fullscreen=function(){a.homeSI.mapFullscreen=!0,n.isEnabled()?n.cancel():n.enable(document.getElementById("homeSI-map-holder"))},a.homeSI.searchCampaigns=function(){a.homeSI.loading.campaigns=!0,a.homeSI.searchCampaignsKeyword?R({query:{q:a.homeSI.searchCampaignsKeyword,limit:f.homeSI.campaignOffset,offset:0}}):R()},G=function(){return A?+A.replace("marker",""):0},a.homeSI.focusNextMarker=function(b){var c,d,e=b&&b.direction,f=b&&b.goTo;if(f)c="last"==f?Object.keys(a.homeSI.leaflet.markers).length-1:0,d="marker"+c;else{if(0===G()&&0===e||G()===Object.keys(a.homeSI.leaflet.markers).length&&1===e)return A="marker0",void(a.homeSI.leaflet.markers[A].focus=!0);c=e?G()+1:G()-1,d="marker"+c}l.getMarkers("leafletHomeSI").then(function(b){var c=u.getCurrentGroups().dateaCluster,e=b[d];c&&c.zoomToShowLayer(e,function(){a.$broadcast("leafletDirectiveMarker.click",{markerName:d})})})},a.homeSI.onFilterChange=function(){var b,c={};jb&&(b=t.createBoundsFromArray(E({lat:z&&z.coords&&z.coords.latitude,lng:z&&z.coords&&z.coords.longitude})),c.bottom_left_latitude=b.southWest.lat,c.bottom_left_longitude=b.southWest.lng,c.top_right_latitude=b.northEast.lat,c.top_right_longitude=b.northEast.lng,a.homeSI.loading.leaflet=!0,K(),P(c))},a.flow.goToDetail=function(a){a.campaigns[0].username&&d.path("/"+a.campaigns[0].username+"/"+a.tag)},Y=function(b){var c,d,e=[];return"follow"===a.query.followFilter?(angular.forEach(b.tags,function(b){angular.isDefined(a.homeSI.userTags[b.tag])&&e.push(a.homeSI.userTags[b.tag].color)}),0==e.length&&e.push(f.visualization.default_color)):e.push(f.visualization.default_color),d=f.visualization.markerWidth/e.length,c='<svg width="'+f.visualization.markerWidth+'" height="'+f.visualization.markerHeight+'"><g style="clip-path: url(#pinpath);">',angular.forEach(e,function(a,b){c=c+'<rect height="'+f.visualization.markerHeight+'" width="'+parseInt(Math.ceil(d))+'" fill="'+a+'" x="'+Math.ceil(b*d)+'" />'}),c=c+'<circle class="datea-svg-marker-circle" data-datea-svg-circle-id="'+b.id+'" cx="14.5" cy="13" r="4" fill="white" /><path d="'+f.visualization.markerSvgPath+'" stroke="#888888" fill="none" stroke-width="1" /></g></svg>',{type:"div",iconSize:[29,40],iconAnchor:[14.5,40],popupAnchor:[0,-33],labelAnchor:[8,-25],html:c,className:"datea-pin-icon datea-pin-icon"+b.id}},db=function(b){return"follow"===a.query.followFilter?$(b):Z(b)},$=function(c){var d,e,f=c.getAllChildMarkers(),g=f.length,h=w.clusterSizeRange(f.length),i=h+1,j=h/2,k={},l=[];angular.forEach(f,function(b){angular.forEach(b.options._tags,function(c){a.homeSI.userTags[c]&&(angular.isDefined(k[c])?(k[c].value++,k[c].ids.push(b.options._id)):k[c]={label:"#"+c,value:1,tag:c,ids:[b.options._id]})})});for(var m in k)l.push(k[m]);return d=w.makeSVGPie({n:g,r:j,d:h,data:l,tags:b.data.tags_followed,secondaryTags:a.homeSI.userTags}),e=new L.DivIcon({html:d,className:w.pieclusterConfig.clusterIconClassName,iconSize:new L.Point(i,i)})},Z=function(a){var b,c,d=a.getAllChildMarkers(),e=d.length,f=ab(d.length),g=f+1,h=f/2;return b=cb({n:e,r:h,d:f}),c=new L.DivIcon({html:b,className:"marker-cluster",iconSize:new L.Point(g,g)})},ab=d3.scale.linear().domain([0,100]).range([50,80]).clamp(!0),cb=function(a){var b,c;return b=document.createElementNS(d3.ns.prefix.svg,"svg"),c=d3.select(b).data([a.data]).attr("class","datea-svg-cluster").attr("width",a.d).attr("height",a.d).append("svg:g").attr("transform","translate("+a.r+","+a.r+")"),c.append("circle").attr("fill",f.visualization.default_color).attr("r",a.r).attr("cx",0).attr("cy",0).attr("opacity",.75),c.append("circle").attr("fill","#ffffff").attr("r",a.r/2.2).attr("cx",0).attr("cy",0),c.append("text").attr("x",0).attr("y",0).attr("class","cpie-label").attr("text-anchor","middle").attr("dy",".3em").text(a.n),eb(b)},eb=function(a){return"undefined"!=typeof window.XMLSerializer?(new window.XMLSerializer).serializeToString(a):"undefined"!=typeof a.xml?a.xml:""},a.homeSI.leaflet.clusterOptions={iconCreateFunction:db,polygonOptions:w.pieclusterConfig.polygonOptions},a.$on("leafletDirectiveMarker.click",function(b,c){var d;A=c.markerName,d=a.homeSI.leaflet.markers[c.markerName]._dateo,l.getMarkers("leafletHomeSI").then(function(a){var b=a[c.markerName];_(d,b.getLatLng())})}),a.$on("$destroy",function(){bb(),u.resetCurrentGroups()}),e.$on("user:signedIn",function(){1===b.data.status&&M()}),e.$on("user:signedOut",function(){O()}),e.$on("user:signedUp",function(){N()}),e.$on("user:updated",function(){a.user=b.data}),D=b.data.status,b.isSignedIn()&&1===b.data.status&&M()}]),angular.module("dateaWebApp").controller("DateoSearchCtrl",["$scope","Api","$routeParams","$location","$q","User","$modal","config","$filter","$interpolate","leafletData","$timeout","leafletMarkersHelpers","$http","$compile","shareMetaData","Datear","$document",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r){var s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I;a.query={q:c.search||"",limit:d.search().limit||100,order_by:d.search().order_by||"-created",tab:d.search().tab||"map"},d.search().since&&(a.query.since=Date.parse(d.search().since)||void 0),d.search().until&&(a.query.until=Date.parse(d.search().until)||void 0),I=h.visualization.defaultMarkerIcon,I.html=h.visualization.defaultMarkerIcon.htmlGen(d.absUrl()),a.result={},a.flow={},a.flow.loading=!0,a.flow.leaflet={},a.flow.result={},a.flow.isHashtag=!1,a.flow.dateoDetail={dateo:null,show:!1},a.flow.orderByOptions=[{val:"-created",label:"últimos"},{val:"-vote_count",label:"más apoyados"},{val:"-comment_count",label:"más comentados"}],angular.extend(a.flow.leaflet,h.defaultMap),a.dateFormat=h.defaultDateFormat,p.setData({title:"Datea | buscar dateos"}),a.$watch("query.limit",function(){a.flow.limitLabel=a.query.limit<1e3?"máximo "+a.query.limit:"todos los"}),u=function(){var a={};c.search&&(a.q=c.search);for(var b in d.search())"tab"!==b&&(a[b]=d.search()[b]);return w(),a},w=function(){a.query.q.match(/^#\S+$/)&&(a.flow.isHashtag=!0)},a.flow.goToHashtag=function(){d.path("/tag/"+a.query.q.replace("#",""))},C=function(){var b,c={};for(var e in a.query)"q"!==e&&a.query[e]&&(c[e]=a.query[e],c[e]="since"===e||"until"===e?a.query[e].toISOString():a.query[e]);b=a.query.q||"",d.path("/buscar/"+b),d.search(c)},F=function(b){var c,d=[],e=a.query;c=void 0!==b?b>e.limit?e.limit:b:e.limit,c>0?("-created"===e.order_by&&d.push("últimos "+c),"-vote_count"===e.order_by&&d.push(c+" más apoyados"),"-comment_count"===e.order_by&&d.push(c+" más comentados")):d.push("sin resultados"),e.since&&e.until?d.push(i("date")(e.since,"d/M/yy")+" > "+i("date")(e.until,"d/M/yy")):(e.since&&d.push("desde &nbsp;"+i("date")(e.since,"d/M/yy")),e.until&&d.push("hasta &nbsp;"+i("date")(e.until,"d/M/yy"))),a.flow.queryTextRep=d},z=function(){var c,e=d.search().tab||"map";a.flow.showFilter=!1,a.flow.loading=!0,c=u(),"map"===e?(a.result.dateos=[],a.flow.leaflet.markers={}):"images"===e&&(a.result.dateosWithImages=[],c.has_images=1),b.dateo.getDateos(c).then(function(b){if("map"===e)G(),a.flow.dateoShowListNumResults=h.defaultdateoNumResults,a.result.dateos=b.objects,H=b.objects.map(function(a){return a.id}),s({dateos:b.objects}),a.result.totalDateos=b.meta.total_count;else if("images"===e){var c=[];_.each(b.objects,function(a){_.each(a.images,function(b){b.dateo=a,c.push(b)})}),a.result.dateoImages=c,a.result.totalDateos=b.meta.total_count}a.flow.loading=!1,F(b.objects.length)},function(a){console.log(a)}),a.result.campaigns=[],c.q&&b.campaign.getCampaigns({q:c.q,order_by:"-dateo_count"}).then(function(b){a.result.campaigns=b.objects},function(a){console.log(a)})},a.flow.doSearch=function(){C(),z()},a.flow.openTab=function(b){a.query.tab=b,a.flow.doSearch(),"map"==b&&k.getMap("leafletSearch").then(function(a){a.invalidateSize()})},a.flow.autocompleteSearch=function(a){return b.tag.getAutocompleteByKeyword({q:a.replace("#","")}).then(function(a){var b=[];return angular.forEach(a.suggestions,function(a){b.push("#"+a)}),b})},a.flow.showMoreListResults=function(){a.flow.dateoShowListNumResults+=h.defaultdateoNumResults},s=function(b){var c=b&&b.dateos,d=[];E=0,a.flow.leaflet.markers={},angular.forEach(c,function(a){a.position&&(x(a),d.push([a.position.coordinates[1],a.position.coordinates[0]]))}),Object.keys(a.flow.leaflet.markers).length&&k.getMap("leafletSearch").then(function(a){a.fitBounds(d)})},t=function(a){var b;return b="#"+a.tags.slice(0,2).join(", #"),a.tags.length>2&&(b+="..."),{lat:a.position.coordinates[1],lng:a.position.coordinates[0],group:"search",label:{message:b},draggable:!1,focus:!1,_id:a.id,icon:I,riseOnHover:!0}},x=function(b){var c=t(b);a.flow.leaflet.markers["marker"+b.id]=c,E++},v=function(b){n.get("views/dateo-map-popup.html").success(function(c){var d,e,f,g,i;g=H.indexOf(b.options._id),e=a.$new(!0),e.dateo=a.result.dateos[g],e.dateFormat=h.defaultDateFormat,e.openDetail=function(){a.flow.openDateoDetail(e.dateo.id)},e.tags=e.dateo.tags.slice(0,2),d=o(angular.element(c)),f=d(e),i=b.getLatLng(),k.getMap("leafletSearch").then(function(a){L.popup({offset:L.point(0,-32)}).setLatLng(i).setContent(f[0]).openOn(a)})})},a.clusterOptions={polygonOptions:{weight:1,fillColor:"#999",color:"#999",fillOpacity:.4}},a.$on("user:hasDateado",function(b,c){c.created&&(a.result.dateos.unshift(c.dateo),H.unshift(c.dateo.id),c.dateo.is_geolocated&&x(c.dateo),c.dateo.has_images&&a.result.dateosWithImages.unshift(c.dateo),c.dateo.position&&a.flow.focusDateo(c.dateo.id))}),a.flow.focusDateo=function(b){var c;c="marker"+b,k.getMarkers("leafletSearch").then(function(b){var d=m.getCurrentGroups().search,e=b[c];d&&e&&d.zoomToShowLayer(e,function(){a.flow.leaflet.markers[c].focus,v(e)})})},a.flow.openDateoDetail=function(b){var c=H.indexOf(b),d=a.result.dateos[c];a.flow.dateoDetail.dateo=d,a.flow.dateoDetail.markerIndex=c,a.flow.dateoDetail.show=!0,d.position&&a.flow.focusDateo(b)},a.flow.closeDateoDetail=function(){a.flow.dateoDetail.dateo=null,a.flow.dateoDetail.show=!1},a.$on("focus-dateo",function(b,c){a.flow.focusDateo(c.id)}),a.$on("open-dateo-detail",function(b,c){a.flow.openDateoDetail(c.id)}),a.$on("close-dateo-detail",function(){a.flow.closeDateoDetail()}),a.$on("leafletDirectiveMarker.click",function(b,c){a.flow.leaflet.markers[c.markerName].focus=!0,v(c.leafletEvent.target)}),a.flow.scrollToCampaigns=function(a){a.preventDefault(),a.stopPropagation(),r.scrollToElement($("#campaigns"),100,400)},B=d3.scale.linear().domain([0,100]).range([50,80]).clamp(!0),y=function(a){var b,c,d=a.getAllChildMarkers(),e=d.length,f=B(d.length),g=f+1,h=f/2;return b=A({n:e,r:h,d:f}),c=new L.DivIcon({html:b,className:"marker-cluster",iconSize:new L.Point(g,g)})},A=function(a){var b,c;return b=document.createElementNS(d3.ns.prefix.svg,"svg"),c=d3.select(b).data([a.data]).attr("class","datea-svg-cluster").attr("width",a.d).attr("height",a.d).append("svg:g").attr("transform","translate("+a.r+","+a.r+")"),c.append("circle").attr("fill",h.visualization.default_color).attr("r",a.r).attr("cx",0).attr("cy",0).attr("opacity",.75),c.append("circle").attr("fill","#ffffff").attr("r",a.r/2.2).attr("cx",0).attr("cy",0),c.append("text").attr("x",0).attr("y",0).attr("class","cpie-label").attr("text-anchor","middle").attr("dy",".3em").text(a.n),D(b)},a.flow.leaflet.clusterOptions={iconCreateFunction:y,polygonOptions:{weight:1,fillColor:"#999",color:"#999",fillOpacity:.4}},D=function(a){return"undefined"!=typeof window.XMLSerializer?(new window.XMLSerializer).serializeToString(a):"undefined"!=typeof a.xml?a.xml:""},z(),$(window).resize(function(){G()}),G=function(){if(Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor")>0){var a=$(".dateo-map-viz"),b=a.height();$(".leaflet-map-holder, .dateos-holder").css("height",b+"px"),k.getMap("leafletSearch").then(function(a){a.invalidateSize()})}},a.$on("$destroy",function(){a.result={},m.resetCurrentGroups(),q.resetContext(),$(window).off("resize")})}]),angular.module("dateaWebApp").controller("EmbedbuilderCtrl",["$scope","$modalInstance","embedBuilderGivens","$interpolate","$timeout","config",function(a,b,c,d,e,f){a.flow={},a.embed={},a.embed.author=c.author,a.embed.mainTag=c.mainTag,a.embed.path=c.path,angular.extend(a.embed,f.embed),a.embed.width=a.embed.widthResult=f.embed.defaultWidth,a.embed.height=f.embed.defaultHeight,a.embed.widthResult=f.embed.width,e(function(){a.$apply(function(){a.embed.width=String(f.embed.defaultWidth),a.embed.height=String(f.embed.defaultHeight)})},100),a.flow.changeWidthResult=function(){var b;"%"===String(a.embed.widthResult).charAt(-1)&&"100"!==String(a.embed.widthResult).replace("%","")&&(a.embed.widthResult="100%",a.embed.width=f.embed.maxWidth),parseInt(a.embed.widthResult)&&(b=parseInt(a.embed.widthResult),b<f.embed.minWidth&&(b=f.embed.minWidth),b>f.embed.maxWidth&&(b=f.embed.maxWidth),b===f.embed.maxWidth?(a.embed.width=f.embed.maxWidth,a.embed.widthResult="100%"):a.embed.width=a.embed.widthResult=b)},a.$watch("embed.width",function(){a.embed.widthResult=a.embed.width==f.embed.maxWidth?"100%":a.embed.width}),a.flow.changeHeightResult=function(){var b=parseInt(a.embed.height);b>f.embed.maxHeight&&(b=f.embed.maxHeight),b<f.embed.minHeight&&(b=f.embed.minHeight),a.embed.height=b},e(function(){$("textarea").select()},100)}]),angular.module("dateaWebApp").directive("fileInputWidget",["$rootScope","config","$timeout",function(a,b,c){return{restrict:"E",templateUrl:"views/file-input-widget.html",scope:{callback:"&",fileType:"@",maxImgSize:"@",maxNumber:"@"},link:function(a,d,e){var f=e.maxImgSize?parseInt(e.maxImgSize):b.maxImgSize;a.maxNumber=e.maxNumber?parseInt(e.maxNumber):20;var g;a.flow={},e.$observe("maxNumber",function(b){a.maxNumber=b?parseInt(b):20}),e.$observe("fileType",function(c){a.fileType=c?c:"image","image"===a.fileType?(a.flow.accept="image/*",!a.maxNumber||a.maxNumber>1?(a.flow.dragMessage="suelta <strong>imágenes</strong> aquí",a.flow.btnMessage="Elige imágenes para subir"):(a.flow.dragMessage="suelta una <strong>imagen</strong> aquí",a.flow.btnMessage="Elige una imagen para subir")):(a.flow.accept=b.allowedMimetypes.join(","),!a.maxNumber||a.maxNumber>1?(a.flow.dragMessage="suelta <strong>archivos</strong> aquí",a.flow.btnMessage="Elige archivos para subir"):(a.flow.dragMessage="suelta un <strong>archivo</strong> aquí",a.flow.btnMessage="Elige un archivo para subir"))}),c(function(){FileAPI.event.on(d.find("#inputFileElement")[0],"change",function(a){var b=FileAPI.getFiles(a);g(b)})},100),$(document).on("dragenter",function(b){b.preventDefault(),b.stopPropagation(),a.$apply(function(){a.flow.isOver=!0})}),$(document).on("dragover",function(a){a.preventDefault(),a.stopPropagation()}),$(document).on("drop",function(b){a.$apply(function(){a.flow.isOver=!1,a.flow.loading=!0});var c=[],d=b.originalEvent.dataTransfer.files;b.preventDefault(),b.stopPropagation();for(var e=0;e<d.length;e++)c.push(d[e]);g(c)}),g=function(d){FileAPI.filterFiles(d,function(c){return"image"===a.fileType&&"image"===c.type.split("/")[0]?!0:"file"===a.fileType&&-1!==b.allowedMimetypes.indexOf(c.type)?!0:!1},function(b){if(b.length){var d=[];for(var e in b){var g,h,g,i=b[e];"image"==i.type.split("/")[0]?FileAPI.Image(i).rotate("auto").resize(f,f,"max").get(function(e,f){f&&(h="image/jpeg"==i.type||"image/png"==i.type?i.type:"image/png",g=f.toDataURL(h,1),d.push({data:i,file:g,type:"image"}),d.length===b.length&&(a.callback({files:d}),c(function(){a.flow.loading=!1},0,!0)))}):FileAPI.readAsDataURL(i,function(e){"load"==e.type&&(g=e.result,d.push({data:i,file:g,type:"file"}),d.length===b.length&&(a.callback({files:d}),c(function(){a.flow.loading=!1},0,!0)))})}}else c(function(){a.flow.loading=!1},0,!0)})},a.$on("$destroy",function(){FileAPI.event.off(d,"change"),$(document).off("drop"),$(document).off("dragover"),$(document).off("dragenter")})}}}]),angular.module("dateaWebApp").directive("imageGallery",function(){return{restrict:"A",link:function(a,b){b.magnificPopup&&b.magnificPopup({type:"image",delegate:".slide",gallery:{enabled:!0,preload:[0,2]}})}}}),angular.module("dateaWebApp").controller("FlagFormCtrl",["$scope","$modalInstance","Api","flagModalGivens","User","localStorageService",function(a,b,c,d){a.flow={},a.flow.doFlag=function(){a.flagform.$valid?(a.flow.loading=!0,c.flag.doFlag({content_type:d.flagObjType,object_id:d.flagId,comment:a.flag.comment}).then(function(){a.flow.loading=!1,a.flow.success=!0},function(a){console.log(a)})):a.flow.notValid=!0}}]),L.drawLocal={draw:{toolbar:{actions:{title:"Cancelar acción",text:"Cancelar"},undo:{title:"Borrar último punto",text:"Borrar último punto"},buttons:{polyline:"Dibujar polilínea",polygon:"Dibujar polígono",rectangle:"Dibujar rectángulo",circle:"Dibujar círculo",marker:"Dibujar marcador"}},handlers:{circle:{tooltip:{start:"Click and drag to draw circle."}},marker:{tooltip:{start:"Click map to place marker."}},polygon:{tooltip:{start:"Cliquea para crear polígono.",cont:"Cliquea para colocar nuevo vértice.",end:"Cliquea el primer punto para cerrar polígono."}},polyline:{error:"<strong>Error:</strong> shape edges cannot cross!",tooltip:{start:"Click to start drawing line.",cont:"Click to continue drawing line.",end:"Click last point to finish line."}},rectangle:{tooltip:{start:"Click and drag to draw rectangle."}},simpleshape:{tooltip:{end:"Release mouse to finish drawing."}}}},edit:{toolbar:{actions:{save:{title:"Guardar cambios.",text:"Guardar"},cancel:{title:"Cancelar edición, descartar cambios.",text:"Cancelar"}},buttons:{edit:"Edit layers.",editDisabled:"No layers to edit.",remove:"Delete layers.",removeDisabled:"No layers to delete."}},handlers:{edit:{tooltip:{text:"Edita arrastrando los vértices.",subtext:"Cliquea cancelar para descartar cambios."}},remove:{tooltip:{text:'Selecciona el polígono a borrar y cliquea en "guardar"'}}}}},angular.module("dateaWebApp").directive("daTimeline",["$rootScope","config","$timeout","Piecluster","$sce","$document",function(a,b,c,d,e,f){return{restrict:"E",templateUrl:"/views/timeline.html",scope:{dateos:"&",tags:"&",campaign:"&",loading:"="},link:function(a,b){var g,h,i=0,j=($(".timeline-bar"),"1h"),k=[],l=!1;h=d3.scale.linear().domain([0,100]).range([30,55]).clamp(!0),a.timeline={},a.bar={},a.bar.dragging=!1,a.bar.left=0,a.bar.width=window.innerWidth,a.bar.style={left:"0",width:a.bar.width+"px"},a.bar.timeNotches={},a.slider={},a.activeDateos=[{},{},{}],a.bar.startDrag=function(b){a.bar.dragging=!0,g=b.screenX,b.preventDefault(),b.stopPropagation(),a.bar.style.cursor="col-resize"},a.bar.mouseMoving=function(b){var c=a.bar.left<1&&a.bar.left+a.bar.width>=window.innerWidth;a.bar.dragging&&y(),a.bar.dragging&&c?(i=b.screenX-g,a.bar.left+=i,z(),g=b.screenX):a.bar.dragging&&(a.bar.left=a.bar.left>0?0:window.innerWidth-a.bar.width,z(),a.bar.dragging=!1,delete a.bar.style.cursor,b.preventDefault(),b.stopPropagation()),a.bar.mouseX=b.pageX||b.layerX},a.bar.stopDrag=function(b){a.bar.dragging=!1,b.preventDefault(),b.stopPropagation(),delete a.bar.style.cursor};var m=!1;a.bar.mousewheel=function(b,d,e,f){if(l)n&&c.cancel(n),n=c(function(){l=!1},500);else{b.preventDefault(),b.stopPropagation();var g=12*(f+2*(f/Math.abs(f))*(a.bar.width/window.innerWidth)),h=a.bar.mouseX-a.bar.left;o(g,h),y(),m&&c.cancel(m),m=c(function(){p()},500)}};var n=!1;f.on("scroll",function(){l=!0,n&&c.cancel(n),n=c(function(){l=!1},500)});var o=function(b,c){var d,e=a.bar.left+a.bar.width,f=(window.innerWidth/a.bar.width*q.timespan(),a.bar.left<=0),g=e>=window.innerWidth;f||g?(d=f&&!g?0:!f&&g?1:c/a.bar.width,a.bar.left-=d*b,a.bar.width+=b):(a.bar.left=0,a.bar.width=window.innerWidth),a.bar.left=a.bar.left>0?0:a.bar.left,a.bar.width=a.bar.width<window.innerWidth?window.innerWidth:a.bar.width,z()},p=function(b){var b=b?b:a.activeDateos[1].id,c={};_.each(k,function(b){var d=q.project(b.timestamp,1)*a.bar.width,e=parseInt(d/50);c[e]?c[e].dateos.push(b):c[e]={dateos:[b]}}),c=_.each(c,function(c,f){var g={};_.each(c.dateos,function(d){_.each(d.tags,function(b){b!=a.campaign().main_tag.tag&&a.tags()[b]&&(g[b]?g[b].value++:g[b]={value:1,tag:b})}),d.id==b&&(c.isActive=!0)});var i=_.values(g),j=c.dateos.length>1?Math.round(h(c.dateos.length)):20;i.length||(i=[{value:c.dateos.length,tag:"Otros"}]);var k={n:c.dateos.length,r:j/2,d:j,data:i,tags:a.tags(),secondaryTags:a.tags(),opacity:1};if(c.html=d.makeSVGPie(k),c.html=e.trustAsHtml(c.html),c.dateos.length>1)var l=50*f+25;else var l=q.project(c.dateos[0].timestamp,a.bar.width);c.style={top:-k.r+"px",height:k.d+"px",left:(l-k.r)/a.bar.width*100+"%"},c.isActive&&(a.bar.activePosStyle={left:l/a.bar.width*100+"%"})}),a.clusters=c},q={min:+1/0,max:-1/0,extend:function(a){this.min=Math.min(a,this.min),this.max=Math.max(a,this.max)},timespan:function(){return this.max-this.min},project:function(a,b){return b=b||100,b*(a-this.min)/this.timespan()},reset:function(){this.min=+1/0,this.max=-1/0}},r={1544e3:{top:{interval:"1h",format:"ha - d.M.yy"},bottom:{interval:"1m",format:"m"}},3888e3:{top:{interval:"1h",format:"H'h' - d MMM yyyy"},bottom:{interval:"5m",format:"m"}},116e5:{top:{interval:"1h",format:"H'h' - d MMM yyyy"},bottom:{interval:"15m",format:"m"}},216e5:{top:{interval:"1d",format:"d MMM yyyy"},bottom:{interval:"1h",format:"H"}},10368e4:{top:{interval:"1d",format:"d MMM yyyy"},bottom:{interval:"6h",format:"H"}},5184e5:{top:{interval:"1M",format:"MMMM yyyy"},bottom:{interval:"1d",format:"d"}},5184e6:{top:{interval:"1M",format:"MMMM yyyy"},bottom:{interval:"7d",format:"d"}},15552e6:{top:{interval:"1y",format:"yyyy"},bottom:{interval:"1M",format:"MMM"}},93312e6:{top:{interval:"10y",format:"yyyy's'"},bottom:{interval:"1y",format:"yy"}},10368e8:{top:{interval:"100y",format:"yyyy's'"},bottom:{interval:"10y",format:"yy's'"}}},s=Object.keys(r).map(function(a){return parseInt(a)});s.sort(function(a,b){return a-b});var t=new Date,u=60*t.getTimezoneOffset()*1e3,v={"1m":function(a,b){var c=[],d=6e4,e=Math.ceil((b-a)/d),f=new Date(parseInt(a/d)*d);f.setSeconds(0,0),c.push(f);for(var g=0;e>g;g++){var h=new Date(c[g].getTime()+d);c.push(h)}return c},"5m":function(a,b){var c=[],d=3e5,a=parseInt(a/d)*d-u,e=Math.ceil((b-a)/d),f=new Date(a);f.setSeconds(0,0),c.push(f);for(var g=0;e>g;g++){var h=new Date(c[g].getTime()+d);c.push(h)}return c},"15m":function(a,b){var c=[],d=9e5,a=parseInt(a/d)*d-u,e=Math.ceil((b-a)/d),f=new Date(a);f.setMinutes(0,0,0),c.push(f);for(var g=0;e>g;g++){var h=new Date(c[g].getTime()+d);c.push(h)}return c},"1h":function(a,b){var c=[],d=36e5,a=parseInt(a/d)*d-u,e=Math.ceil((b-a)/d),f=new Date(a);f.setMinutes(0,0,0),c.push(f);for(var g=0;e>g;g++){var h=new Date(c[g].getTime()+d);c.push(h)}return c},"6h":function(a,b){var c=[],d=216e5,a=parseInt(a/d)*d-u,e=Math.ceil((b-a)/d),f=new Date(a);f.setMinutes(0,0,0),c.push(f);for(var g=0;e>g;g++){var h=new Date(c[g].getTime()+d);c.push(h)}return c},"12h":function(a,b){var c=[],d=432e5,a=parseInt(a/d)*d-u,e=Math.ceil((b-a)/d),f=new Date(a);f.setMinutes(0,0,0),c.push(f);for(var g=0;e>g;g++){var h=new Date(c[g].getTime()+d);c.push(h)}return c},"1d":function(a,b){var c=[],d=864e5,a=parseInt(a/d)*d-u,e=Math.ceil((b-a)/d),f=new Date(a);f.setHours(0,0,0,0),c.push(f);for(var g=0;e>g;g++){var h=new Date(c[g].getTime()+d);c.push(h)}return c},"7d":function(a,b){var c=[],d=6048e5,e=Math.ceil((b-a)/d),f=new Date(parseInt(a/d)*d-u);f.setHours(0,0,0,0),c.push(f);for(var g=0;e>g;g++){var h=new Date(c[g].getTime()+d);c.push(h)}return c},"1M":function(a,b){var c=[],d=new Date(a);d.setDate(1),d.setHours(0,0,0,0),c.push(d);for(var e=d,f=!0;f;){var g=new Date(e.getFullYear(),e.getMonth()+1,1,0,0,0,0);g.getTime()<=b?(c.push(g),e=g):f=!1}return c},"1y":function(a,b){var c=[],d=new Date(a);d.setMonth(0,1),d.setHours(0,0,0,0),c.push(d);for(var e=d,f=!0;f;){var g=new Date(e.getFullYear()+1,0,1,0,0,0,0);g.getTime()<=b?(c.push(g),e=g):f=!1}return c},"10y":function(a,b){var c=[],d=new Date(a);d.setMonth(0,1),d.setHours(0,0,0,0),d.setFullYear(10*parseInt(d.getFullYear()/10)),c.push(d);for(var e=d,f=!0;f;){var g=new Date(e.getFullYear()+10,0,1,0,0,0,0);g.getTime()<=b?(c.push(g),e=g):f=!1}return c},"100y":function(a,b){var c=[],d=new Date(a);d.setMonth(0,1),d.setHours(0,0,0,0),d.setFullYear(100*parseInt(d.getFullYear()/100)),c.push(d);for(var e=d,f=!0;f;){var g=new Date(e.getFullYear()+100,0,1,0,0,0,0);g.getTime()<=b?(c.push(g),e=g):f=!1}return c}},w=function(a){for(var b,c=0;c<s.length;c++)s[c]<=a&&(b=r[s[c]]);return b?b:r[_.first(s)]},x={"1m":function(){return 6e4/q.timespan()},"5m":function(){return 3e5/q.timespan()},"5m":function(){return 3e5/q.timespan()},"15m":function(){return 9e5/q.timespan()},"1h":function(){return 36e5/q.timespan()},"6h":function(){return 216e5/q.timespan()},"1d":function(){return 864e5/q.timespan()},"7d":function(){return 6048e5/q.timespan()},"1M":function(){return 30.4368499*864e5/q.timespan()},"1y":function(){return 365.242199*864e5/q.timespan()},"10y":function(){return 315569259936/q.timespan()},"100y":function(){return 3155364459936/q.timespan()}};a.bar.getTimeNotchStyle=function(b,c){var d={},e=b.getTime();if(c){var f=q.project(e,a.bar.width),g=f+c*a.bar.width,h=f+a.bar.left>0,i=g+a.bar.left<window.innerWidth,j=f+a.bar.left<=window.innerWidth&&g+a.bar.left>=0;j?h||i?!h&&i?(d.left=-a.bar.left/a.bar.width*100+"%",d.width=(g+a.bar.left)/a.bar.width*100+"%"):!i&&h?(d.left=q.project(e,100)+"%",d.width=(-a.bar.left+window.innerWidth-f)/a.bar.width*100+"%"):(d.left=q.project(e,100)+"%",d.width=100*c+"%"):(d.width=window.innerWidth+2,d.left=-a.bar.left-1):d.display="none"}else d.left=q.project(e,100)+"%";return d};var y=function(){var b=window.innerWidth/a.bar.width*q.timespan(),c=w(b),d=q.min+q.timespan()*(Math.abs(a.bar.left)/a.bar.width),e=d+b;j=c.bottom.interval,a.bar.timeNotches.first={format:c.top.format,intervals:v[c.top.interval](d,e),width:x[c.top.interval]()},a.bar.timeNotches.second={format:c.bottom.format,intervals:v[c.bottom.interval](d,e)}};a.timeline.zoom=function(b,d){var e=a.bar.width*d,f=a.bar.width-window.innerWidth,g=Math.abs(a.bar.left)/(f>0?f:1);if(g=g>0?g:.5,console.log("displaceFactor",g),e<window.innerWidth)e=window.innerWidth,a.bar.left=0;else{var h=e-a.bar.width;a.bar.left-=h*g}a.bar.animate=!0,a.bar.width=e,z(),y(),p(),c(function(){a.bar.animate=!1},500)};var z=function(){a.bar.style.width=a.bar.width+"px",a.bar.style.left=a.bar.left+"px"};a.timeline.clusterClick=function(b,d){if(d.dateos.length>1&&"5m"!=j&&"1m"!=j){a.bar.animate=!0;var e=d.dateos.map(function(a){return a.timestamp});e.sort(function(a,b){return a-b});var f=_.last(e)-e[0],g=w(f);"1m"==g.bottom.interval&&(f=q.timespan()>9e5?9e5:q.timespan());var h=window.innerWidth/(1.5*f*a.bar.width/q.timespan());console.log("maxInterval",f,"zoomFactor",h,"nMode",g),a.bar.width*=h,a.bar.left=-q.project(e[0]-.25*f,a.bar.width),console.log("bar width - left",a.bar.width+a.bar.left>window.innerWidth),a.timeline.showdateo(d.dateos[0]),c(function(){A(1)}),z(),c(function(){a.bar.animate=!1,y(),p()},500)}else a.timeline.showdateo(d.dateos[0]),p()},a.timeline.showdateo=function(b){var d=_.findIndex(k,function(a){return b.id===a.id});a.activeDateos[0]=d-1>=0?k[d-1]:{},a.activeDateos[1]=b,a.activeDateos[2]=d+1<k.length?k[d+1]:{},c(function(){A(1)})},a.timeline.nextDateo=function(){a.activeDateos[2].id&&(a.slider.slideNext=!0,A(2),c(function(){var b=_.findIndex(k,function(b){return a.activeDateos[2].id===b.id}),d=b+1<k.length?k[b+1]:{},e=a.activeDateos.slice(1);e.push(d),a.activeDateos=e,a.slider.slideNext=!1,p(),_.each(a.clusters,function(b){if(b.isActive){var d=parseFloat(b.style.left.replace("%"))/100,e=d*a.bar.width+a.bar.left;if(e>=.88*window.innerWidth){a.bar.animate=!0;var f=Math.abs(a.bar.left)+window.innerWidth-d*a.bar.width-window.innerWidth/4;a.bar.left+f+a.bar.width<window.innerWidth?a.bar.left=-(a.bar.width-window.innerWidth):a.bar.left+=f,z(),y(),c(function(){a.bar.animate=!1},500)}return!1}})},420))},a.timeline.prevDateo=function(){a.activeDateos[0].id&&(a.slider.slidePrev=!0,A(0),c(function(){var b=a.activeDateos.slice(0,2),d=_.findIndex(k,function(b){return a.activeDateos[0].id===b.id});b.unshift(d-1>=0?k[d-1]:{}),a.activeDateos=b,a.slider.slidePrev=!1,p(),_.each(a.clusters,function(b){if(b.isActive){var d=parseFloat(b.style.left.replace("%"))/100,e=d*a.bar.width+a.bar.left;if(e<=.12*window.innerWidth){a.bar.animate=!0;var f=Math.abs(a.bar.left)-d*a.bar.width+window.innerWidth/4;a.bar.left+f>0?a.bar.left=0:a.bar.left+=f,z(),y(),c(function(){a.bar.animate=!1},500)}return!1}})},420))},f.on("keydown",function(b){39===b.which?a.$apply(a.timeline.nextDateo):37==b.which&&a.$apply(a.timeline.prevDateo)
});var A=function(b){var c=$(".slide-container-"+b).height();a.slider.wrapStyle={height:c+"px"}},B=function(){if(a.bar.dragging=!1,a.bar.left=0,a.bar.width=window.innerWidth,a.bar.style={left:"0",width:a.bar.width+"px"},k=a.dateos(),k&&k.length){k.sort(function(a,b){return a.timestamp-b.timestamp}),a.timeline.noResults=!1,q.reset(),_.each(k,function(a){q.extend(a.timestamp)});var b=q.timespan()/5;q.extend(q.min-b),q.extend(q.max+b),y(),k.length&&(a.activeDateos=[{},k[0],k.length>1?k[1]:{}]),p()}else a.timeline.noResults=!0};a.$watch("bar.width",function(){a.timeline.zoomOutDisabled=a.bar.width==window.innerWidth}),B(),a.$on("dateoQuery:done",function(){B()}),b.bind("keydown keypress",function(a){console.log(a),13===event.which&&event.preventDefault()})}}}]);